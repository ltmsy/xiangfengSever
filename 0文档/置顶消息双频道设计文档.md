# 置顶消息双频道设计文档

## 📋 文档概述

本文档详细描述了置顶消息功能的双频道ID存储策略，包括各种场景下的处理逻辑、数据存储方式和业务操作流程。

## 🏗️ 架构设计理念

### 双频道ID策略
- **原始频道ID**: 消息实际存储的频道ID
- **当前用户频道ID**: 发起置顶操作的用户频道ID

### 设计目标
- 支持跨用户置顶操作
- 保持数据一致性和权限控制
- 提供高效的查询和管理功能

## 📱 私聊场景处理

### 置顶自己的消息

#### 操作流程
1. 用户A置顶自己发给用户B的消息
2. 调用悟空IM搜索单条消息接口获取消息详情
3. 从返回结果中提取`target_uid`（对方用户UID）
4. 计算两个频道ID：
   - 原始频道ID：用户A的fakeChannelID（fake_aaa_bbb）
   - 当前用户频道ID：用户A的fakeChannelID（fake_aaa_bbb）
5. 在置顶表中存储一条记录

#### 存储逻辑
- 原始频道ID：fake_aaa_bbb（消息实际存储位置）
- 当前用户频道ID：fake_aaa_bbb（发起置顶的用户频道）
- 两个字段值相同，逻辑一致

### 置顶对方的消息

#### 操作流程
1. 用户A置顶用户B发给自己的消息
2. 调用悟空IM搜索单条消息接口获取消息详情
3. 从返回结果中提取`target_uid`（对方用户UID）
4. 计算两个频道ID：
   - 原始频道ID：用户B的fakeChannelID（fake_bbb_aaa）
   - 当前用户频道ID：用户A的fakeChannelID（fake_aaa_bbb）
5. 在置顶表中存储一条记录

#### 存储逻辑
- 原始频道ID：fake_bbb_aaa（消息实际存储位置）
- 当前用户频道ID：fake_aaa_bbb（发起置顶的用户频道）
- 两个字段值不同，体现跨用户操作

## 🏢 群聊场景处理

### 置顶群聊消息

#### 操作流程
1. 用户在群组中置顶某条消息
2. 调用悟空IM搜索单条消息接口获取消息详情
3. 从返回结果中提取群组信息
4. 计算两个频道ID：
   - 原始频道ID：群组ID
   - 当前用户频道ID：群组ID
5. 在置顶表中存储一条记录

#### 存储逻辑
- 原始频道ID：群组ID（消息实际存储位置）
- 当前用户频道ID：群组ID（发起置顶的用户频道）
- 两个字段值相同，逻辑一致

## ❌ 取消置顶操作

### 取消置顶逻辑

#### 操作流程
1. 用户发起取消置顶操作
2. 系统通过messageID在置顶表中查找记录
3. 找到对应的置顶记录
4. 执行逻辑删除（设置is_deleted=1）
5. 更新version字段用于同步

#### 查找策略
- 通过messageID在置顶表中查找
- 支持批量取消置顶操作
- 记录操作日志和版本信息

### 权限控制
- 只有置顶发起者可以取消置顶
- 群组管理员可以取消任何成员的置顶
- 系统管理员可以取消所有置顶

## 🗑️ 清空置顶消息

### 清空置顶逻辑

#### 操作流程
1. 用户发起清空置顶操作
2. 系统计算当前用户的频道ID
3. 在置顶表中查找该频道下的所有置顶消息
4. 收集所有messageID
5. 批量执行逻辑删除操作
6. 更新version字段用于同步

#### 查找策略
- 通过当前用户频道ID查找所有置顶消息
- 支持按频道类型过滤
- 批量处理提高性能

### 批量操作优化
- 使用事务确保数据一致性
- 分批处理大量数据
- 记录操作日志和统计信息

## 🔍 查询置顶消息

### 查询置顶逻辑

#### 操作流程
1. 用户请求查询置顶消息
2. 系统计算当前用户的频道ID
3. 在置顶表中按频道ID查询置顶消息
4. 过滤已删除的消息
5. 按时间或序号排序返回结果

#### 查询策略
- 通过当前用户频道ID快速定位
- 支持分页和增量同步
- 缓存查询结果提高性能

### 消息过滤逻辑
- **本地消息过滤**: 检查当前用户是否已删除消息
- **对方消息过滤**: 私聊场景下过滤对方已删除的置顶消息
- **频道偏移过滤**: 根据频道设置过滤超出偏移范围的消息
- **状态标记**: 将过滤的消息标记为`IsDeleted=1`

### 同步机制
- 使用version字段实现增量同步
- 支持多设备数据同步
- 实时推送置顶状态变化

## 📊 数据存储结构

### 置顶表字段说明

#### 核心字段
- `message_id`: 消息唯一标识
- `original_channel_id`: 原始频道ID
- `current_channel_id`: 当前用户频道ID
- `channel_type`: 频道类型
- `version`: 同步版本号

#### 管理字段
- `is_deleted`: 逻辑删除标记
- `created_at`: 创建时间
- `updated_at`: 更新时间

### 索引设计
- 主键索引：id
- 唯一索引：message_id + channel_id
- 查询索引：current_channel_id + channel_type
- 原始频道索引：original_channel_id + channel_type
- 消息查询索引：message_id + current_channel_id

## 🔄 数据同步策略

### 增量同步
- 基于version字段的增量同步
- 支持多设备数据一致性
- 实时推送置顶状态变化

### 冲突处理
- 版本号冲突检测
- 最后修改时间优先策略
- 用户操作优先级控制

## 📢 CMD通知智能过滤

### 通知过滤策略
当用户已经清空会话或删除自己的消息时，系统会智能过滤CMD通知，避免发送无效通知。

#### 置顶操作通知过滤
1. **检查对方消息状态**: 查询对方用户的`message_user_extra`表
2. **判断是否删除**: 检查`MessageIsDeleted`字段状态
3. **智能过滤**: 如果对方已删除所有相关消息，则不发送通知
4. **日志记录**: 记录过滤原因和操作日志

#### 取消置顶通知过滤
1. **批量检查**: 检查所有相关消息的删除状态
2. **统计删除数量**: 统计对方已删除的消息数量
3. **条件过滤**: 如果对方已删除所有相关消息，则不发送通知
4. **性能优化**: 批量查询避免多次数据库访问

#### 清空置顶通知过滤
1. **消息状态检查**: 检查所有置顶消息的删除状态
2. **对方状态验证**: 验证对方用户的消息删除状态
3. **智能决策**: 根据对方状态决定是否发送通知
4. **批量处理**: 支持大量消息的批量状态检查

### 过滤逻辑优势
- **避免无效通知**: 不向已删除消息的用户发送通知
- **提升用户体验**: 减少无意义的系统消息
- **节省系统资源**: 减少不必要的网络传输
- **保持数据一致性**: 通知状态与消息状态保持一致

## 🚀 性能优化策略

### 查询优化
- 合理使用索引
- 分页查询避免大量数据
- 缓存热点数据

### 批量操作
- 批量插入和更新
- 事务控制确保一致性
- 异步处理非关键操作

## 🛡️ 安全与权限

### 权限控制
- 用户只能操作自己的置顶消息
- 群组权限继承和验证
- 系统管理员特殊权限

### 数据安全
- 逻辑删除保护数据完整性
- 操作日志记录审计信息
- 敏感操作二次确认

## 📈 扩展性考虑

### 功能扩展
- 支持置顶消息分类
- 置顶消息过期时间
- 置顶消息优先级

### 架构扩展
- 支持多级频道结构
- 分布式置顶管理
- 跨应用置顶同步

## 🎯 总结

双频道ID设计策略完美解决了置顶功能的各种场景需求：

1. **支持跨用户操作**: 可以置顶和取消置顶任何人的消息
2. **保持数据一致性**: 通过双频道ID确保数据完整性
3. **提供高效查询**: 多种索引支持不同查询场景
4. **支持权限控制**: 基于频道ID的细粒度权限管理
5. **便于扩展维护**: 清晰的架构设计支持未来功能扩展

这种设计既解决了当前的技术问题，又为未来的功能扩展奠定了坚实的基础。 