# 群组权限控制前端对接接口文档

## 📋 概述

本文档描述了TangSengDaoDao系统中群组权限控制的所有前端对接接口，包括角色管理、权限验证、禁言控制、黑名单管理等核心功能。所有接口都基于真实的代码实现，确保信息的准确性和实用性。

## 🔐 认证说明

- **基础路径**: `/v1`
- **认证方式**: 所有接口都需要在请求头中携带有效的认证Token
- **认证中间件**: `g.ctx.AuthMiddleware(r)`

## 📚 接口目录

### 1. 角色权限管理
- [1.1 添加群管理员](#11-添加群管理员) - `POST /v1/groups/:group_no/managers`
- [1.2 移除群管理员](#12-移除群管理员) - `DELETE /v1/groups/:group_no/managers`
- [1.3 群主转让](#13-群主转让) - `POST /v1/groups/:group_no/transfer/:to_uid`

### 2. 禁言权限控制
- [2.1 群全员禁言](#21-群全员禁言) - `POST /v1/groups/:group_no/forbidden/:on`
- [2.2 成员禁言管理](#22-成员禁言管理) - `POST /v1/groups/:group_no/forbidden_with_member`
- [2.3 获取禁言时长列表](#23-获取禁言时长列表) - `GET /v1/group/forbidden_times`

### 3. 黑名单权限管理
- [3.1 添加/移除黑名单](#31-添加移除黑名单) - `POST /v1/groups/:group_no/blacklist/:action`

### 4. 成员管理权限
- [4.1 移除群成员](#41-移除群成员) - `DELETE /v1/groups/:group_no/members`
- [4.2 修改群成员信息](#42-修改群成员信息) - `PUT /v1/groups/:group_no/members/:uid`

### 5. 群组设置权限
- [5.1 修改群信息](#51-修改群信息) - `PUT /v1/groups/:group_no`
- [5.2 解散群组](#52-解散群组) - `DELETE /v1/groups/:group_no/disband`
- [5.3 上传群头像](#53-上传群头像) - `POST /v1/groups/:group_no/avatar`

---

## 📚 权限体系架构

### 1. 角色层级结构

```go
const (
    MemberRoleCommon  = 0  // 普通成员
    MemberRoleCreator = 1  // 创建者（群主）
    MemberRoleManager = 2  // 管理者（管理员）
)
```

### 2. 权限继承关系

- **群主权限**: 拥有所有权限，可执行任何操作
- **管理员权限**: 可管理普通成员，不能管理其他管理员或群主
- **普通成员权限**: 只能修改自己的信息，无管理权限

### 3. 权限验证机制

系统提供三个核心权限验证函数：

```go
// 是否是群管理者或创建者
func QueryIsGroupManagerOrCreator(groupNo string, uid string) (bool, error)

// 是否是群创建者
func QueryIsGroupCreator(groupNo string, uid string) (bool, error)

// 查询管理者或创建者的uid列表
func QueryGroupManagerOrCreatorUIDS(groupNo string) ([]string, error)
```

## 📚 接口分类

### 1. 角色权限管理

#### 1.1 添加群管理员
- **接口**: `POST /v1/groups/:group_no/managers`
- **功能**: 设置群管理员
- **权限**: 需要登录，且为群主
- **路径参数**: `group_no` - 群组编号
- **请求参数**:
```json
["uid1", "uid2"]
```
- **业务逻辑**:
  - 验证群主权限（`QueryIsGroupCreator`）
  - 不能将自己设置为管理员
  - 更新成员角色为管理员（`UpdateMembersToManager`）
  - 如果群处于禁言状态，重置管理员白名单
  - 发送成员更新命令
  - 支持批量操作

#### 1.2 移除群管理员
- **接口**: `DELETE /v1/groups/:group_no/managers`
- **功能**: 移除群管理员
- **权限**: 需要登录，且为群主
- **路径参数**: `group_no` - 群组编号
- **请求参数**:
```json
["uid1", "uid2"]
```
- **业务逻辑**:
  - 验证群主权限（`QueryIsGroupCreator`）
  - 不能将自己移除管理员
  - 更新成员角色为普通成员（`UpdateManagersToMember`）
  - 如果群处于禁言状态，重置管理员白名单
  - 发送成员更新命令
  - 支持批量操作

#### 1.3 群主转让
- **接口**: `POST /v1/groups/:group_no/transfer/:to_uid`
- **功能**: 转让群主权限
- **权限**: 需要登录，且为群主
- **路径参数**: 
  - `group_no` - 群组编号
  - `to_uid` - 新群主用户ID
- **业务逻辑**:
  - 验证转让目标是否为群成员
  - 验证当前用户是否为群主（`QueryIsGroupCreator`）
  - 更新角色权限（`UpdateMemberRoleTx`）
  - 发布转让事件（`GroupMemberTransferGrouper`）
  - 重置新群主的禁言状态
  - 如果群处于禁言状态，更新IM白名单

### 2. 禁言权限控制

#### 2.1 群全员禁言
- **接口**: `POST /v1/groups/:group_no/forbidden/:on`
- **功能**: 开启/关闭群全员禁言
- **权限**: 需要登录，且为群主或管理员
- **路径参数**: 
  - `group_no` - 群组编号
  - `on` - 禁言开关（1开启，0关闭）
- **业务逻辑**:
  - 验证操作权限（`QueryIsGroupManagerOrCreator`）
  - 设置群禁言状态
  - 自动设置管理员白名单（`setIMWhitelistForGroupManager`）
  - 发布禁言更新事件（`GroupUpdate`）
  - 同步到悟空IM系统

#### 2.2 成员禁言管理
- **接口**: `POST /v1/groups/:group_no/forbidden_with_member`
- **功能**: 禁言或解禁特定成员
- **权限**: 需要登录，且为群主或管理员
- **路径参数**: `group_no` - 群组编号
- **请求参数**:
```json
{
  "member_uid": "uid",
  "action": 1,  // 0解禁，1禁言
  "key": 3      // 禁言时长：1分钟，2十分钟，3一小时，4一天，5一周，6一月
}
```
- **业务逻辑**:
  - 验证操作权限（角色层级检查）
  - 普通成员不能禁言其他成员
  - 不能禁言群主
  - 同级之间不能互相禁言
  - 设置禁言时长
  - 同步到悟空IM黑名单
  - 发送成员更新命令

#### 2.3 获取禁言时长列表
- **接口**: `GET /v1/group/forbidden_times`
- **功能**: 获取可选的禁言时长选项
- **权限**: 需要登录
- **响应**: 返回禁言时长选项列表
- **响应数据**:
```json
[
  {"text": "1分钟", "key": 1},
  {"text": "10分钟", "key": 2},
  {"text": "1小时", "key": 3},
  {"text": "1天", "key": 4},
  {"text": "1周", "key": 5},
  {"text": "1个月", "key": 6}
]
```

### 3. 黑名单权限管理

#### 3.1 添加/移除黑名单
- **接口**: `POST /v1/groups/:group_no/blacklist/:action`
- **功能**: 管理群组黑名单
- **权限**: 需要登录，且为群主或管理员
- **路径参数**: 
  - `group_no` - 群组编号
  - `action` - 操作类型（add/remove）
- **请求参数**:
```json
{
  "uids": ["uid1", "uid2"]
}
```
- **业务逻辑**:
  - 验证操作权限（`QueryIsGroupManagerOrCreator`）
  - 更新成员状态
  - 同步IM黑名单（`setGroupBlacklist`）
  - 发送成员更新命令
  - 支持批量操作

### 4. 成员管理权限

#### 4.1 移除群成员
- **接口**: `DELETE /v1/groups/:group_no/members`
- **功能**: 从群组移除成员
- **权限**: 需要登录，且为群主或管理员
- **路径参数**: `group_no` - 群组编号
- **请求参数**:
```json
{
  "members": ["uid1", "uid2"]
}
```
- **业务逻辑**:
  - 验证操作权限（角色检查）
  - 管理员不能删除其他管理员或群主
  - 不能删除自己
  - 发布成员移除事件
  - 自动更新群头像
  - 同步到悟空IM系统

#### 4.2 修改群成员信息
- **接口**: `PUT /v1/groups/:group_no/members/:uid`
- **功能**: 修改群成员信息
- **权限**: 需要登录，且为管理员或本人
- **路径参数**: 
  - `group_no` - 群组编号
  - `uid` - 成员用户ID
- **业务逻辑**:
  - 验证操作权限（`QueryIsGroupManagerOrCreator`）
  - 管理员可修改任何成员信息
  - 普通成员只能修改自己的信息
  - 发布成员更新命令

### 5. 群组设置权限

#### 5.1 修改群信息
- **接口**: `PUT /v1/groups/:group_no`
- **功能**: 修改群组基本信息
- **权限**: 需要登录，且为群主或管理员
- **路径参数**: `group_no` - 群组编号
- **业务逻辑**:
  - 验证操作权限（`QueryIsGroupManagerOrCreator`）
  - 支持修改字段：name、notice、invite
  - 发布群更新事件

#### 5.2 解散群组
- **接口**: `DELETE /v1/groups/:group_no/disband`
- **功能**: 解散群组
- **权限**: 需要登录，且为群主
- **路径参数**: `group_no` - 群组编号
- **业务逻辑**:
  - 验证群主权限（`QueryIsGroupCreator`）
  - 更新群状态为解散
  - 发布群解散事件

#### 5.3 上传群头像
- **接口**: `POST /v1/groups/:group_no/avatar`
- **功能**: 上传群组头像
- **权限**: 需要登录，且为群主
- **路径参数**: `group_no` - 群组编号
- **业务逻辑**:
  - 验证群主权限（`QueryIsGroupCreator`）
  - 上传头像文件
  - 发布头像更新事件

## 🔄 权限验证流程

### 1. 权限检查流程

```go
// 1. 检查用户是否在群内
exist, err := g.db.ExistMember(uid, groupNo)

// 2. 检查用户角色权限
isManager, err := g.db.QueryIsGroupManagerOrCreator(groupNo, uid)
isCreator, err := g.db.QueryIsGroupCreator(groupNo, uid)

// 3. 根据角色执行权限验证
if !isManager {
    c.ResponseError(errors.New("权限不足"))
    return
}
```

### 2. 角色权限矩阵

| 操作 | 群主 | 管理员 | 普通成员 |
|------|------|--------|----------|
| 添加管理员 | ✅ | ❌ | ❌ |
| 移除管理员 | ✅ | ❌ | ❌ |
| 群主转让 | ✅ | ❌ | ❌ |
| 全员禁言 | ✅ | ✅ | ❌ |
| 成员禁言 | ✅ | ✅ | ❌ |
| 黑名单管理 | ✅ | ✅ | ❌ |
| 移除成员 | ✅ | ✅ | ❌ |
| 修改群信息 | ✅ | ✅ | ❌ |
| 解散群组 | ✅ | ❌ | ❌ |
| 上传头像 | ✅ | ❌ | ❌ |

### 3. 权限继承关系

```go
// 权限检查函数
func (g *Group) checkPermission(groupNo, uid string, requiredRole int) error {
    switch requiredRole {
    case MemberRoleCreator:
        isCreator, err := g.db.QueryIsGroupCreator(groupNo, uid)
        if err != nil || !isCreator {
            return errors.New("需要群主权限")
        }
    case MemberRoleManager:
        isManager, err := g.db.QueryIsGroupManagerOrCreator(groupNo, uid)
        if err != nil || !isManager {
            return errors.New("需要管理员权限")
        }
    }
    return nil
}
```

## ⚠️ 重要业务逻辑

### 1. 白名单机制
- 群全员禁言时，管理员自动加入白名单
- 管理员可正常发言，普通成员被禁言
- 权限变更时自动更新白名单

### 2. 禁言黑名单同步
- 成员禁言状态同步到悟空IM黑名单
- 禁言到期自动解除并同步状态
- 支持定时任务检查禁言状态

### 3. 权限变更事件
- 角色变更发布相应事件
- 权限变更同步到IM系统
- 支持实时通知和状态更新

### 4. 数据一致性保证
- 使用数据库事务确保操作的原子性
- 权限变更与IM系统状态同步
- 支持版本号机制进行增量同步

## 📝 错误码说明

- `400`: 请求参数错误
- `401`: 未授权访问
- `403`: 权限不足
- `404`: 资源不存在
- `500`: 服务器内部错误

### 常见权限错误信息
- "只有创建者才能设置管理员！"
- "只有创建者或管理员才能禁言！"
- "操作用户权限不够"
- "管理员不能删除管理员"
- "管理员不能删除群主"
- "普通成员无法删除群成员"

## 🚀 最佳实践

### 1. 权限预检查
- 前端应提前检查用户权限
- 避免发送无效请求，提升用户体验
- 根据权限动态显示操作按钮

### 2. 批量权限操作
- 权限管理支持批量操作
- 减少API调用次数，提高效率
- 统一处理权限变更事件

### 3. 实时权限更新
- 监听权限变更事件
- 及时更新UI状态
- 保持界面与后端权限的一致性

### 4. 权限缓存策略
- 合理缓存用户权限信息
- 避免频繁查询数据库
- 权限变更时及时清除缓存

### 5. 错误处理机制
- 妥善处理权限不足情况
- 提供友好的用户提示信息
- 记录权限操作日志

## 🔧 技术特性

### 1. 事务支持
- 涉及多表操作时使用数据库事务
- 确保权限变更的一致性和完整性

### 2. 事件驱动架构
- 权限变更会发布相应事件
- 支持异步处理和系统解耦

### 3. IM系统集成
- 与悟空IM深度集成
- 权限变更实时同步到IM系统

### 4. 权限验证中间件
- 统一的权限验证机制
- 支持多种权限检查策略
- 可扩展的权限验证框架

### 5. 角色权限缓存
- 支持权限信息缓存
- 提高权限检查效率
- 支持权限变更实时更新

## 📊 权限数据结构

### 成员角色模型
```go
type MemberModel struct {
    GroupNo   string `json:"group_no"`   // 群组编号
    UID       string `json:"uid"`        // 用户ID
    Role      int    `json:"role"`       // 角色：0普通，1群主，2管理员
    Status    int    `json:"status"`     // 状态：0正常，2黑名单
    Version   int64  `json:"version"`    // 版本号
    // ... 其他字段
}
```

### 权限验证响应
```go
type PermissionCheckResp struct {
    HasPermission bool   `json:"has_permission"` // 是否有权限
    Role          int    `json:"role"`           // 用户角色
    Message       string `json:"message"`        // 权限说明
}
```

## 🔍 权限调试工具

### 1. 权限检查接口
- 提供权限检查的调试接口
- 支持权限验证的详细日志
- 便于排查权限相关问题

### 2. 权限变更日志
- 记录所有权限变更操作
- 支持权限变更历史查询
- 便于审计和问题追踪

### 3. 权限状态监控
- 实时监控群组权限状态
- 支持权限异常告警
- 确保权限系统正常运行
