# 群组管理前端对接接口文档

## 📋 概述

本文档描述了TangSengDaoDao系统中群组管理功能的所有前端对接接口，包括群组创建、成员管理、权限控制、设置管理等核心功能。

## 🔐 认证说明

- **基础路径**: `/v1`
- **认证方式**: 所有接口都需要在请求头中携带有效的认证Token
- **认证中间件**: `g.ctx.AuthMiddleware(r)`

## 📚 接口目录

### 1. 群组基础管理
- [1.1 创建群组](#11-创建群组) - `POST /v1/group/create`
- [1.2 获取我的群组列表](#12-获取我的群组列表) - `GET /v1/group/my`
- [1.3 获取群组信息](#13-获取群组信息) - `GET /v1/groups/:group_no`
- [1.4 获取群组详情（公开）](#14-获取群组详情公开) - `GET /v1/groups/:group_no/detail`
- [1.5 修改群组信息](#15-修改群组信息) - `PUT /v1/groups/:group_no`
- [1.6 解散群组](#16-解散群组) - `DELETE /v1/groups/:group_no/disband`

### 2. 群组成员管理
- [2.1 添加群成员](#21-添加群成员) - `POST /v1/groups/:group_no/members`
- [2.2 移除群成员](#22-移除群成员) - `DELETE /v1/groups/:group_no/members`
- [2.3 获取群成员列表](#23-获取群成员列表) - `GET /v1/groups/:group_no/members`
- [2.4 同步群成员](#24-同步群成员) - `GET /v1/groups/:group_no/membersync`
- [2.5 修改群成员信息](#25-修改群成员信息) - `PUT /v1/groups/:group_no/members/:uid`
- [2.6 退出群组](#26-退出群组) - `POST /v1/groups/:group_no/exit`

### 3. 群组权限管理
- [3.1 添加群管理员](#31-添加群管理员) - `POST /v1/groups/:group_no/managers`
- [3.2 移除群管理员](#32-移除群管理员) - `DELETE /v1/groups/:group_no/managers`
- [3.3 群主转让](#33-群主转让) - `POST /v1/groups/:group_no/transfer/:to_uid`
- [3.4 群全员禁言](#34-群全员禁言) - `POST /v1/groups/:group_no/forbidden/:on`
- [3.5 成员禁言管理](#35-成员禁言管理) - `POST /v1/groups/:group_no/forbidden_with_member`

### 4. 群组设置管理
- [4.1 修改群组设置](#41-修改群组设置) - `PUT /v1/groups/:group_no/setting`
- [4.2 获取禁言时长列表](#42-获取禁言时长列表) - `GET /v1/group/forbidden_times`

### 5. 群组邀请系统
- [5.1 群成员邀请](#51-群成员邀请) - `POST /v1/groups/:group_no/member/invite`
- [5.2 获取邀请详情](#52-获取邀请详情) - `GET /v1/group/invites/:invite_no`
- [5.3 确认邀请](#53-确认邀请) - `POST /v1/group/invite/sure`

### 6. 群组二维码
- [6.1 获取群二维码](#61-获取群二维码) - `GET /v1/groups/:group_no/qrcode`
- [6.2 扫码加入群组](#62-扫码加入群组) - `GET /v1/groups/:group_no/scanjoin`

### 7. 群组头像管理
- [7.1 上传群头像](#71-上传群头像) - `POST /v1/groups/:group_no/avatar`
- [7.2 获取群头像](#72-获取群头像) - `GET /v1/groups/:group_no/avatar`

### 8. 黑名单管理
- [8.1 添加/移除黑名单](#81-添加移除黑名单) - `POST /v1/groups/:group_no/blacklist/:action`

---

## 📚 接口分类

### 1. 群组基础管理

#### 1.1 创建群组
- **接口**: `POST /v1/group/create`
- **功能**: 创建新的群组
- **权限**: 需要登录
- **请求参数**:
```json
{
  "name": "群组名称",
  "members": ["uid1", "uid2", "uid3"]
}
```
- **响应**: 返回群组信息
- **业务逻辑**:
  - 验证好友关系（如果开启）
  - 自动生成群编号
  - 创建群成员关系
  - 发布群创建事件

#### 1.2 获取我的群组列表
- **接口**: `GET /v1/group/my`
- **功能**: 获取当前用户保存的群组列表
- **权限**: 需要登录
- **响应**: 返回群组列表数组

#### 1.3 获取群组信息
- **接口**: `GET /v1/groups/:group_no`
- **功能**: 获取指定群组的详细信息
- **权限**: 需要登录，且为群成员
- **路径参数**: `group_no` - 群组编号
- **响应**: 返回群组详细信息

#### 1.4 获取群组详情（公开）
- **接口**: `GET /v1/groups/:group_no/detail`
- **功能**: 获取群组公开信息（无需登录）
- **路径参数**: `group_no` - 群组编号
- **响应**: 返回群组基本信息

#### 1.5 修改群组信息
- **接口**: `PUT /v1/groups/:group_no`
- **功能**: 修改群组基本信息
- **权限**: 需要登录，且为群主或管理员
- **路径参数**: `group_no` - 群组编号
- **请求参数**:
```json
{
  "name": "新群组名称",
  "notice": "新群公告",
  "invite": 1
}
```
- **支持修改字段**:
  - `name`: 群组名称
  - `notice`: 群公告
  - `invite`: 邀请开关

#### 1.6 解散群组
- **接口**: `DELETE /v1/groups/:group_no/disband`
- **功能**: 解散群组
- **权限**: 需要登录，且为群主
- **路径参数**: `group_no` - 群组编号
- **业务逻辑**:
  - 验证群主权限
  - 更新群状态为解散
  - 发布群解散事件

### 2. 群组成员管理

#### 2.1 添加群成员
- **接口**: `POST /v1/groups/:group_no/members`
- **功能**: 向群组添加新成员
- **权限**: 需要登录，且为群成员
- **路径参数**: `group_no` - 群组编号
- **请求参数**:
```json
{
  "members": ["uid1", "uid2", "uid3"]
}
```
- **业务逻辑**:
  - 验证操作者是否为群成员
  - 检查群邀请模式设置
  - 验证好友关系
  - 自动生成群头像（如果成员数<9）

#### 2.2 移除群成员
- **接口**: `DELETE /v1/groups/:group_no/members`
- **功能**: 从群组移除成员
- **权限**: 需要登录，且为群主或管理员
- **路径参数**: `group_no` - 群组编号
- **请求参数**:
```json
{
  "members": ["uid1", "uid2"]
}
```
- **业务逻辑**:
  - 验证操作权限
  - 管理员不能删除其他管理员或群主
  - 发布成员移除事件
  - 自动更新群头像

#### 2.3 获取群成员列表
- **接口**: `GET /v1/groups/:group_no/members`
- **功能**: 获取群组成员列表
- **权限**: 需要登录，且为群成员
- **路径参数**: `group_no` - 群组编号
- **查询参数**:
  - `keyword`: 搜索关键字
  - `page`: 页码（默认1）
  - `limit`: 每页数量（默认100，最大100000）
- **响应**: 返回成员详情列表

#### 2.4 同步群成员
- **接口**: `GET /v1/groups/:group_no/membersync`
- **功能**: 同步群成员信息（增量更新）
- **权限**: 需要登录，且为群成员
- **路径参数**: `group_no` - 群组编号
- **查询参数**:
  - `version`: 版本号（用于增量同步）
  - `limit`: 每页数量（默认100）
- **响应**: 返回增量成员信息

#### 2.5 修改群成员信息
- **接口**: `PUT /v1/groups/:group_no/members/:uid`
- **功能**: 修改群成员信息
- **权限**: 需要登录，且为管理员或本人
- **路径参数**: 
  - `group_no` - 群组编号
  - `uid` - 成员用户ID
- **请求参数**:
```json
{
  "remark": "新备注名称"
}
```

#### 2.6 退出群组
- **接口**: `POST /v1/groups/:group_no/exit`
- **功能**: 主动退出群组
- **权限**: 需要登录，且为群成员
- **路径参数**: `group_no` - 群组编号
- **业务逻辑**:
  - 如果群主退出，自动转让给第二元老成员
  - 发布退出事件
  - 清理相关设置

### 3. 群组权限管理

#### 3.1 添加群管理员
- **接口**: `POST /v1/groups/:group_no/managers`
- **功能**: 设置群管理员
- **权限**: 需要登录，且为群主
- **路径参数**: `group_no` - 群组编号
- **请求参数**:
```json
["uid1", "uid2"]
```
- **业务逻辑**:
  - 验证群主权限
  - 更新成员角色
  - 重置管理员白名单（如果群禁言）

#### 3.2 移除群管理员
- **接口**: `DELETE /v1/groups/:group_no/managers`
- **功能**: 移除群管理员
- **权限**: 需要登录，且为群主
- **路径参数**: `group_no` - 群组编号
- **请求参数**:
```json
["uid1", "uid2"]
```

#### 3.3 群主转让
- **接口**: `POST /v1/groups/:group_no/transfer/:to_uid`
- **功能**: 转让群主权限
- **权限**: 需要登录，且为群主
- **路径参数**: 
  - `group_no` - 群组编号
  - `to_uid` - 新群主用户ID
- **业务逻辑**:
  - 验证转让目标是否为群成员
  - 更新角色权限
  - 发布转让事件

#### 3.4 群全员禁言
- **接口**: `POST /v1/groups/:group_no/forbidden/:on`
- **功能**: 开启/关闭群全员禁言
- **权限**: 需要登录，且为群主或管理员
- **路径参数**: 
  - `group_no` - 群组编号
  - `on` - 禁言开关（1开启，0关闭）
- **业务逻辑**:
  - 设置群禁言状态
  - 自动设置管理员白名单
  - 发布禁言更新事件

#### 3.5 成员禁言管理
- **接口**: `POST /v1/groups/:group_no/forbidden_with_member`
- **功能**: 禁言或解禁特定成员
- **权限**: 需要登录，且为群主或管理员
- **路径参数**: `group_no` - 群组编号
- **请求参数**:
```json
{
  "member_uid": "uid",
  "action": 1,  // 0解禁，1禁言
  "key": 3      // 禁言时长：1分钟，2十分钟，3一小时，4一天，5一周，6一月
}
```

### 4. 群组设置管理

#### 4.1 修改群组设置
- **接口**: `PUT /v1/groups/:group_no/setting`
- **功能**: 修改群组相关设置
- **权限**: 需要登录，且为群成员
- **路径参数**: `group_no` - 群组编号
- **请求参数**:
```json
{
  "mute": 1,                    // 免打扰
  "top": 1,                     // 置顶
  "show_nick": 1,               // 显示昵称
  "save": 1,                    // 保存到通讯录
  "chat_pwd_on": 1,             // 聊天密码
  "revoke_remind": 1,           // 撤回提醒
  "join_group_remind": 1,       // 进群提醒
  "screenshot": 1               // 截屏通知
}
```

#### 4.2 获取禁言时长列表
- **接口**: `GET /v1/group/forbidden_times`
- **功能**: 获取可选的禁言时长选项
- **权限**: 需要登录
- **响应**: 返回禁言时长选项列表

### 5. 群组邀请系统

#### 5.1 群成员邀请
- **接口**: `POST /v1/groups/:group_no/member/invite`
- **功能**: 邀请用户加入群组
- **权限**: 需要登录，且为群成员
- **路径参数**: `group_no` - 群组编号
- **业务逻辑**: 创建邀请记录，等待被邀请者确认

#### 5.2 获取邀请详情
- **接口**: `GET /v1/group/invites/:invite_no`
- **功能**: 获取群组邀请详情
- **权限**: 无需登录
- **路径参数**: `invite_no` - 邀请编号

#### 5.3 确认邀请
- **接口**: `POST /v1/group/invite/sure`
- **功能**: 确认群组邀请
- **权限**: 无需登录
- **业务逻辑**: 处理邀请确认，自动加入群组

### 6. 群组二维码

#### 6.1 获取群二维码
- **接口**: `GET /v1/groups/:group_no/qrcode`
- **功能**: 生成群组二维码
- **权限**: 需要登录，且为群成员
- **路径参数**: `group_no` - 群组编号
- **响应**: 返回二维码信息和有效期

#### 6.2 扫码加入群组
- **接口**: `GET /v1/groups/:group_no/scanjoin`
- **功能**: 通过二维码扫码加入群组
- **权限**: 无需登录
- **路径参数**: `group_no` - 群组编号
- **查询参数**: `auth_code` - 认证码
- **业务逻辑**: 验证二维码有效性，自动加入群组

### 7. 群组头像管理

#### 7.1 上传群头像
- **接口**: `POST /v1/groups/:group_no/avatar`
- **功能**: 上传群组头像
- **权限**: 需要登录，且为群主
- **路径参数**: `group_no` - 群组编号
- **请求类型**: `multipart/form-data`
- **文件参数**: `file` - 头像文件
- **业务逻辑**: 上传头像，发布头像更新事件

#### 7.2 获取群头像
- **接口**: `GET /v1/groups/:group_no/avatar`
- **功能**: 获取群组头像
- **权限**: 无需登录
- **路径参数**: `group_no` - 群组编号
- **查询参数**: `v` - 版本号（用于缓存控制）

### 8. 黑名单管理

#### 8.1 添加/移除黑名单
- **接口**: `POST /v1/groups/:group_no/blacklist/:action`
- **功能**: 管理群组黑名单
- **权限**: 需要登录，且为群主或管理员
- **路径参数**: 
  - `group_no` - 群组编号
  - `action` - 操作类型（add/remove）
- **请求参数**:
```json
{
  "uids": ["uid1", "uid2"]
}
```
- **业务逻辑**: 更新成员状态，同步IM黑名单

## 📊 数据模型

### 群组状态
```go
const (
    GroupStatusDisabled = 0  // 已禁用
    GroupStatusNormal   = 1  // 正常
    GroupStatusDisband  = 2  // 解散
)
```

### 成员角色
```go
const (
    MemberRoleCommon  = 0  // 普通成员
    MemberRoleCreator = 1  // 创建者
    MemberRoleManager = 2  // 管理者
)
```

### 群组类型
```go
const (
    GroupTypeCommon GroupType = iota // 普通群
    GroupTypeSuper                   // 超大群
)
```

## 🔄 事件通知

系统支持多种事件通知，包括：
- 群组创建/更新/解散
- 成员添加/移除/角色变更
- 群组设置变更
- 头像更新
- 权限变更

## ⚠️ 注意事项

1. **权限验证**: 所有管理操作都需要验证用户权限
2. **事务处理**: 涉及多表操作时使用数据库事务
3. **事件发布**: 重要操作会发布相应事件通知
4. **IM同步**: 群组变更会同步到悟空IM系统
5. **缓存控制**: 头像等资源支持版本控制
6. **自动升级**: 普通群达到一定成员数可自动升级为超大群

## 📝 错误码说明

- `400`: 请求参数错误
- `401`: 未授权访问
- `403`: 权限不足
- `404`: 资源不存在
- `500`: 服务器内部错误

## 🚀 最佳实践

1. **批量操作**: 成员管理支持批量操作，提高效率
2. **增量同步**: 使用版本号进行增量数据同步
3. **权限检查**: 前端应提前检查用户权限，避免无效请求
4. **错误处理**: 妥善处理各种错误情况，提供友好提示
5. **实时更新**: 监听相关事件，及时更新UI状态
