# 群组高级功能前端对接接口文档

## 📋 概述

本文档描述了TangSengDaoDao系统中群组高级功能的所有前端对接接口，包括二维码系统、头像管理、禁言系统、黑名单管理、群主转让、自动群主选择等核心功能。所有接口都基于真实的代码实现，确保信息的准确性和实用性。

## 🔐 认证说明

- **基础路径**: `/v1`
- **认证方式**: 所有接口都需要在请求头中携带有效的认证Token
- **认证中间件**: `g.ctx.AuthMiddleware(r)`

## 📚 接口目录

### 1. 二维码系统
- [1.1 生成群二维码](#11-生成群二维码) - `GET /v1/groups/:group_no/qrcode`
- [1.2 扫码加入群组](#12-扫码加入群组) - `POST /v1/groups/:group_no/scan_join`

### 2. 头像管理系统
- [2.1 上传群头像](#21-上传群头像) - `POST /v1/groups/:group_no/avatar`
- [2.2 自动头像生成](#22-自动头像生成) - 系统自动功能

### 3. 禁言系统
- [3.1 全员禁言控制](#31-全员禁言控制) - `PUT /v1/groups/:group_no/setting`
- [3.2 个人禁言管理](#32-个人禁言管理) - `POST /v1/groups/:group_no/forbidden`
- [3.3 禁言时长列表](#33-禁言时长列表) - `GET /v1/groups/:group_no/forbidden_times`
- [3.4 自动解禁机制](#34-自动解禁机制) - 系统自动功能

### 4. 黑名单管理
- [4.1 添加/移除黑名单](#41-添加移除黑名单) - `POST /v1/groups/:group_no/blacklist/:action`

### 5. 群主转让系统
- [5.1 群主转让](#51-群主转让) - `PUT /v1/groups/:group_no/transfer/:to_uid`

### 6. 自动群主选择
- [6.1 群主退出自动转让](#61-群主退出自动转让) - 系统自动功能

### 7. 成员恢复机制
- [7.1 智能成员恢复](#71-智能成员恢复) - 系统自动功能

### 8. 版本号同步系统
- [8.1 增量同步机制](#81-增量同步机制) - 系统自动功能

### 9. 事件通知系统
- [9.1 事件类型](#91-事件类型) - 系统事件
- [9.2 命令消息](#92-命令消息) - 系统命令

### 10. IM系统集成
- [10.1 悟空IM集成](#101-悟空im集成) - 系统集成功能

---

## 📚 接口分类

### 1. 二维码系统

#### 1.1 生成群二维码
- **接口**: `GET /v1/groups/:group_no/qrcode`
- **功能**: 生成群组邀请二维码
- **权限**: 需要登录，且为群成员
- **路径参数**: `group_no` - 群组编号
- **业务逻辑**:
  - 验证操作者是否为群成员
  - 生成唯一UUID作为二维码标识
  - 缓存二维码信息（有效期7天）
  - 返回二维码URL和过期时间
- **响应示例**:
```json
{
  "day": 7,
  "qrcode": "https://example.com/qrcode/uuid123",
  "expire": "12月25日"
}
```

#### 1.2 扫码加入群组
- **接口**: `POST /v1/groups/:group_no/scan_join`
- **功能**: 通过二维码扫码加入群组
- **权限**: 需要登录
- **路径参数**: `group_no` - 群组编号
- **查询参数**: `auth_code` - 授权码
- **业务逻辑**:
  - 验证群组是否存在
  - 检查群组是否开启邀请模式
  - 验证授权码的有效性和类型
  - 检查扫码者是否已在群内
  - 自动生成群头像（如果成员数<9且未上传过自定义头像）
  - 支持成员恢复（如果之前被删除过）
  - 发布成员扫码加入事件
  - 同步到悟空IM系统

### 2. 头像管理系统

#### 2.1 上传群头像
- **接口**: `POST /v1/groups/:group_no/avatar`
- **功能**: 上传自定义群头像
- **权限**: 需要登录，且为群主
- **路径参数**: `group_no` - 群组编号
- **请求参数**: `file` - 头像文件（multipart/form-data）
- **业务逻辑**:
  - 验证操作者是否为群主
  - 支持PNG格式，最大20MB
  - 自动生成群头像存储路径
  - 更新数据库头像信息
  - 发送群头像更新命令
  - 实时通知所有群成员

#### 2.2 自动头像生成
- **功能**: 系统自动生成群头像
- **触发条件**:
  - 群成员数量小于9人
  - 未上传过自定义头像
  - 成员变更时自动触发
- **生成逻辑**:
  - 取前9个成员的头像
  - 自动合成群头像
  - 发布头像更新事件

### 3. 禁言系统

#### 3.1 全员禁言控制
- **接口**: `PUT /v1/groups/:group_no/setting`
- **功能**: 开启/关闭全员禁言
- **权限**: 需要登录，且为群主或管理员
- **请求参数**:
```json
{
  "forbidden": 1  // 1:开启禁言, 0:关闭禁言
}
```
- **业务逻辑**:
  - 验证操作者权限
  - 更新群组禁言状态
  - 自动设置管理员白名单
  - 同步到悟空IM系统

#### 3.2 个人禁言管理
- **接口**: `POST /v1/groups/:group_no/forbidden`
- **功能**: 禁言/解禁特定成员
- **权限**: 需要登录，且为群主或管理员
- **请求参数**:
```json
{
  "member_uid": "uid123",
  "action": 1,    // 0:解禁, 1:禁言
  "key": 3        // 禁言时长: 1-1分钟, 2-10分钟, 3-1小时, 4-1天, 5-1周, 6-1个月
}
```
- **业务逻辑**:
  - 验证操作者权限（不能禁言同级或更高级别成员）
  - 计算禁言过期时间
  - 更新成员禁言状态
  - 同步到悟空IM黑名单系统
  - 发送成员更新命令

#### 3.3 禁言时长列表
- **接口**: `GET /v1/groups/:group_no/forbidden_times`
- **功能**: 获取可选的禁言时长选项
- **响应示例**:
```json
[
  {"text": "1分钟", "key": 1},
  {"text": "10分钟", "key": 2},
  {"text": "1小时", "key": 3},
  {"text": "1天", "key": 4},
  {"text": "1周", "key": 5},
  {"text": "1个月", "key": 6}
]
```

#### 3.4 自动解禁机制
- **功能**: 系统自动解除过期禁言
- **实现方式**: 后台定时任务循环检查
- **检查频率**: 每15秒检查一次
- **业务逻辑**:
  - 查询禁言过期的成员
  - 自动重置禁言状态
  - 从IM黑名单中移除
  - 发送成员更新命令

### 4. 黑名单管理

#### 4.1 添加/移除黑名单
- **接口**: `POST /v1/groups/:group_no/blacklist/:action`
- **功能**: 添加或移除群成员黑名单
- **权限**: 需要登录，且为群主或管理员
- **路径参数**: 
  - `group_no` - 群组编号
  - `action` - 操作类型（add/remove）
- **请求参数**:
```json
{
  "uids": ["uid1", "uid2"]
}
```
- **业务逻辑**:
  - 验证操作者权限
  - 批量更新成员状态
  - 同步到悟空IM黑名单系统
  - 智能处理禁言状态（移除黑名单时检查是否仍被禁言）
  - 发送成员更新命令

### 5. 群主转让系统

#### 5.1 群主转让
- **接口**: `PUT /v1/groups/:group_no/transfer/:to_uid`
- **功能**: 将群主权限转让给其他成员
- **权限**: 需要登录，且为群主
- **路径参数**:
  - `group_no` - 群组编号
  - `to_uid` - 新群主UID
- **业务逻辑**:
  - 验证转让者是否为群主
  - 验证接收者是否在群内
  - 自动处理禁言状态（新群主自动解除禁言）
  - 更新成员角色
  - 发布群主转让事件
  - 重置管理员白名单（如果群组处于禁言状态）

### 6. 自动群主选择

#### 6.1 群主退出自动转让
- **功能**: 群主退出时自动选择新群主
- **触发条件**: 群主主动退出群组
- **选择逻辑**: 自动选择第二老的群成员作为新群主
- **业务逻辑**:
  - 查询第二老成员信息
  - 自动提升为新群主
  - 发布角色变更事件
  - 发送成员更新命令

### 7. 成员恢复机制

#### 7.1 智能成员恢复
- **功能**: 支持被删除成员重新加入
- **实现方式**: 数据库软删除 + 恢复机制
- **业务逻辑**:
  - 检查成员是否被删除过
  - 自动恢复成员信息
  - 保持原有的邀请人信息
  - 重新生成版本号

### 8. 版本号同步系统

#### 8.1 增量同步机制
- **功能**: 支持群组数据的增量同步
- **版本号类型**:
  - `GroupMemberSeqKey` - 成员版本号
  - `GroupSettingSeqKey` - 设置版本号
- **同步策略**: 基于版本号的增量更新

### 9. 事件通知系统

#### 9.1 事件类型
- **成员相关事件**:
  - `GroupMemberScanJoin` - 扫码加入
  - `GroupMemberTransferGrouper` - 群主转让
  - `GroupMemberRemove` - 成员移除
- **群组相关事件**:
  - `GroupAvatarUpdate` - 头像更新
  - `ConversationDelete` - 会话删除

#### 9.2 命令消息
- **CMD类型**:
  - `CMDGroupMemberUpdate` - 成员更新
  - `CMDGroupAvatarUpdate` - 头像更新

### 10. IM系统集成

#### 10.1 悟空IM集成
- **订阅者管理**:
  - 添加订阅者（新成员加入）
  - 移除订阅者（成员退出/被踢）
- **黑名单同步**:
  - 添加黑名单
  - 移除黑名单
- **白名单管理**:
  - 管理员白名单设置
  - 全员禁言时的权限控制

## 🔧 技术特性

### 1. 事务支持
- 所有关键操作都支持数据库事务
- 确保数据一致性和原子性
- 支持事件和数据库操作的原子提交

### 2. 缓存机制
- Redis缓存二维码信息
- 支持7天有效期
- 自动过期清理

### 3. 文件处理
- 支持大文件上传（最大20MB）
- 自动文件格式验证
- 智能文件路径生成

### 4. 权限验证
- 多级权限检查
- 角色继承关系
- 操作权限验证

### 5. 错误处理
- 完善的错误码系统
- 详细的错误日志
- 用户友好的错误提示

## 📝 最佳实践

### 1. 二维码使用
- 建议在群组设置页面提供二维码生成功能
- 定期提醒用户二维码过期时间
- 支持二维码分享功能

### 2. 禁言管理
- 提供禁言时长选择器
- 显示成员禁言状态
- 支持批量禁言操作

### 3. 头像管理
- 支持头像预览功能
- 提供默认头像选项
- 自动头像生成提示

### 4. 权限控制
- 清晰的权限提示
- 操作确认机制
- 权限变更通知

## ⚠️ 注意事项

1. **权限验证**: 所有高级功能都需要严格的权限验证
2. **事务处理**: 涉及多表操作时使用事务确保一致性
3. **事件通知**: 重要操作完成后及时发送事件通知
4. **IM同步**: 群组变更需要同步到悟空IM系统
5. **缓存管理**: 二维码等临时数据需要设置合理的过期时间
6. **错误处理**: 提供详细的错误信息和用户友好的提示
7. **性能优化**: 大量成员操作时考虑分批处理
8. **安全控制**: 防止恶意操作和权限提升攻击

## 🚀 扩展功能

### 1. 群组统计
- 成员活跃度统计
- 消息发送频率分析
- 群组健康度评估

### 2. 智能管理
- 自动检测异常行为
- 智能推荐管理员
- 群组规则自动执行

### 3. 高级设置
- 自定义群组规则
- 灵活的权限配置
- 群组模板系统

这份文档涵盖了群组高级功能的所有核心特性，前端开发人员可以根据实际需求选择合适的接口进行对接，实现丰富的群组管理功能。
