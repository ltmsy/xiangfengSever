# 群组成员管理前端对接接口文档

## 📋 概述

本文档描述了TangSengDaoDao系统中群组成员管理的所有前端对接接口，包括成员添加、移除、权限管理、禁言控制、黑名单管理等核心功能。所有接口都基于真实的代码实现，确保信息的准确性和实用性。

## 🔐 认证说明

- **基础路径**: `/v1`
- **认证方式**: 所有接口都需要在请求头中携带有效的认证Token
- **认证中间件**: `g.ctx.AuthMiddleware(r)`

## 📚 接口目录

### 1. 成员基础管理
- [1.1 添加群成员](#11-添加群成员) - `POST /v1/groups/:group_no/members`
- [1.2 移除群成员](#12-移除群成员) - `DELETE /v1/groups/:group_no/members`
- [1.3 获取群成员列表](#13-获取群成员列表) - `GET /v1/groups/:group_no/members`
- [1.4 同步群成员](#14-同步群成员) - `GET /v1/groups/:group_no/membersync`
- [1.5 修改群成员信息](#15-修改群成员信息) - `PUT /v1/groups/:group_no/members/:uid`
- [1.6 退出群组](#16-退出群组) - `POST /v1/groups/:group_no/exit`

### 2. 成员权限管理
- [2.1 添加群管理员](#21-添加群管理员) - `POST /v1/groups/:group_no/managers`
- [2.2 移除群管理员](#22-移除群管理员) - `DELETE /v1/groups/:group_no/managers`
- [2.3 群主转让](#23-群主转让) - `POST /v1/groups/:group_no/transfer/:to_uid`

### 3. 成员禁言管理
- [3.1 群全员禁言](#31-群全员禁言) - `POST /v1/groups/:group_no/forbidden/:on`
- [3.2 成员禁言管理](#32-成员禁言管理) - `POST /v1/groups/:group_no/forbidden_with_member`
- [3.3 获取禁言时长列表](#33-获取禁言时长列表) - `GET /v1/group/forbidden_times`

### 4. 黑名单管理
- [4.1 添加/移除黑名单](#41-添加移除黑名单) - `POST /v1/groups/:group_no/blacklist/:action`

### 5. 成员邀请系统
- [5.1 扫码加入群组](#51-扫码加入群组) - `GET /v1/groups/:group_no/scanjoin`

---

## 📚 接口分类

### 1. 成员基础管理

#### 1.1 添加群成员
- **接口**: `POST /v1/groups/:group_no/members`
- **功能**: 向群组添加新成员
- **权限**: 需要登录，且为群成员
- **路径参数**: `group_no` - 群组编号
- **请求参数**:
```json
{
  "members": ["uid1", "uid2", "uid3"]
}
```
- **业务逻辑**:
  - 验证操作者是否为群成员
  - 检查群邀请模式设置（如果开启，只有群主/管理员可添加）
  - 验证好友关系（如果开启）
  - 过滤已注销用户
  - 过滤已在群内或黑名单的用户
  - 自动生成群头像（如果成员数<9且未上传过自定义头像）
  - 发布成员添加事件
  - 同步到悟空IM系统

#### 1.2 移除群成员
- **接口**: `DELETE /v1/groups/:group_no/members`
- **功能**: 从群组移除成员
- **权限**: 需要登录，且为群主或管理员
- **路径参数**: `group_no` - 群组编号
- **请求参数**:
```json
{
  "members": ["uid1", "uid2"]
}
```
- **业务逻辑**:
  - 验证操作权限（群主/管理员）
  - 管理员不能删除其他管理员或群主
  - 不能删除自己
  - 发布成员移除事件
  - 自动更新群头像（如果成员数<9）
  - 同步到悟空IM系统
  - 发送被踢消息通知

#### 1.3 获取群成员列表
- **接口**: `GET /v1/groups/:group_no/members`
- **功能**: 获取群组成员列表
- **权限**: 需要登录，且为群成员
- **路径参数**: `group_no` - 群组编号
- **查询参数**:
  - `keyword`: 搜索关键字（可选）
  - `page`: 页码（默认1）
  - `limit`: 每页数量（默认100，最大100000）
- **响应**: 返回成员详情列表
- **响应数据结构**:
```json
[
  {
    "id": 123,
    "uid": "user123",
    "group_no": "group456",
    "name": "张三",
    "remark": "备注名",
    "role": 0,
    "version": 1234567890,
    "is_deleted": 0,
    "status": 0,
    "invite_uid": "inviter123",
    "robot": 0,
    "forbidden_expir_time": 0,
    "created_at": "2024-01-01 12:00:00",
    "updated_at": "2024-01-01 12:00:00"
  }
]
```

#### 1.4 同步群成员
- **接口**: `GET /v1/groups/:group_no/membersync`
- **功能**: 同步群成员信息（增量更新）
- **权限**: 需要登录，且为群成员
- **路径参数**: `group_no` - 群组编号
- **查询参数**:
  - `version`: 版本号（用于增量同步）
  - `limit`: 每页数量（默认100）
- **响应**: 返回增量成员信息
- **业务逻辑**: 支持增量同步，提高数据同步效率

#### 1.5 修改群成员信息
- **接口**: `PUT /v1/groups/:group_no/members/:uid`
- **功能**: 修改群成员信息
- **权限**: 需要登录，且为管理员或本人
- **路径参数**: 
  - `group_no` - 群组编号
  - `uid` - 成员用户ID
- **请求参数**:
```json
{
  "remark": "新备注名称"
}
```
- **业务逻辑**:
  - 管理员可修改任何成员信息
  - 普通成员只能修改自己的信息
  - 发布成员更新命令

#### 1.6 退出群组
- **接口**: `POST /v1/groups/:group_no/exit`
- **功能**: 主动退出群组
- **权限**: 需要登录，且为群成员
- **路径参数**: `group_no` - 群组编号
- **业务逻辑**:
  - 如果群主退出，自动转让给第二元老成员
  - 发布退出事件
  - 清理相关设置
  - 发送退出通知消息

### 2. 成员权限管理

#### 2.1 添加群管理员
- **接口**: `POST /v1/groups/:group_no/managers`
- **功能**: 设置群管理员
- **权限**: 需要登录，且为群主
- **路径参数**: `group_no` - 群组编号
- **请求参数**:
```json
["uid1", "uid2"]
```
- **业务逻辑**:
  - 验证群主权限
  - 不能将自己设置为管理员
  - 更新成员角色
  - 重置管理员白名单（如果群禁言）
  - 发送成员更新命令

#### 2.2 移除群管理员
- **接口**: `DELETE /v1/groups/:group_no/managers`
- **功能**: 移除群管理员
- **权限**: 需要登录，且为群主
- **路径参数**: `group_no` - 群组编号
- **请求参数**:
```json
["uid1", "uid2"]
```
- **业务逻辑**:
  - 验证群主权限
  - 不能将自己移除管理员
  - 更新成员角色
  - 重置管理员白名单（如果群禁言）
  - 发送成员更新命令

#### 2.3 群主转让
- **接口**: `POST /v1/groups/:group_no/transfer/:to_uid`
- **功能**: 转让群主权限
- **权限**: 需要登录，且为群主
- **路径参数**: 
  - `group_no` - 群组编号
  - `to_uid` - 新群主用户ID
- **业务逻辑**:
  - 验证转让目标是否为群成员
  - 更新角色权限
  - 发布转让事件
  - 重置禁言状态
  - 更新IM白名单

### 3. 成员禁言管理

#### 3.1 群全员禁言
- **接口**: `POST /v1/groups/:group_no/forbidden/:on`
- **功能**: 开启/关闭群全员禁言
- **权限**: 需要登录，且为群主或管理员
- **路径参数**: 
  - `group_no` - 群组编号
  - `on` - 禁言开关（1开启，0关闭）
- **业务逻辑**:
  - 设置群禁言状态
  - 自动设置管理员白名单
  - 发布禁言更新事件
  - 同步到悟空IM系统

#### 3.2 成员禁言管理
- **接口**: `POST /v1/groups/:group_no/forbidden_with_member`
- **功能**: 禁言或解禁特定成员
- **权限**: 需要登录，且为群主或管理员
- **路径参数**: `group_no` - 群组编号
- **请求参数**:
```json
{
  "member_uid": "uid",
  "action": 1,  // 0解禁，1禁言
  "key": 3      // 禁言时长：1分钟，2十分钟，3一小时，4一天，5一周，6一月
}
```
- **业务逻辑**:
  - 验证操作权限
  - 设置禁言时长
  - 同步到悟空IM黑名单
  - 发送成员更新命令

#### 3.3 获取禁言时长列表
- **接口**: `GET /v1/group/forbidden_times`
- **功能**: 获取可选的禁言时长选项
- **权限**: 需要登录
- **响应**: 返回禁言时长选项列表
- **响应数据**:
```json
[
  {"text": "1分钟", "key": 1},
  {"text": "10分钟", "key": 2},
  {"text": "1小时", "key": 3},
  {"text": "1天", "key": 4},
  {"text": "1周", "key": 5},
  {"text": "1个月", "key": 6}
]
```

### 4. 黑名单管理

#### 4.1 添加/移除黑名单
- **接口**: `POST /v1/groups/:group_no/blacklist/:action`
- **功能**: 管理群组黑名单
- **权限**: 需要登录，且为群主或管理员
- **路径参数**: 
  - `group_no` - 群组编号
  - `action` - 操作类型（add/remove）
- **请求参数**:
```json
{
  "uids": ["uid1", "uid2"]
}
```
- **业务逻辑**:
  - 更新成员状态
  - 同步IM黑名单
  - 发送成员更新命令
  - 支持批量操作

### 5. 成员邀请系统

#### 5.1 扫码加入群组
- **接口**: `GET /v1/groups/:group_no/scanjoin`
- **功能**: 通过二维码扫码加入群组
- **权限**: 无需登录
- **路径参数**: `group_no` - 群组编号
- **查询参数**: `auth_code` - 认证码
- **业务逻辑**:
  - 验证二维码有效性
  - 检查群邀请模式
  - 自动加入群组
  - 发布扫码加入事件
  - 自动更新群头像

## 📊 数据模型

### 成员角色定义
```go
const (
    MemberRoleCommon  = 0  // 普通成员
    MemberRoleCreator = 1  // 创建者（群主）
    MemberRoleManager = 2  // 管理者（管理员）
)
```

### 成员状态定义
```go
const (
    GroupMemberStatusNormal    = 0  // 正常
    GroupMemberStatusBlacklist = 2  // 黑名单
)
```

### 成员响应数据结构
```go
type memberDetailResp struct {
    ID                 uint64 `json:"id"`                    // 数据库ID
    UID                string `json:"uid"`                    // 成员uid
    GroupNo            string `json:"group_no"`               // 群唯一编号
    Name               string `json:"name"`                   // 群成员名称
    Remark             string `json:"remark"`                 // 成员备注
    Role               int    `json:"role"`                   // 成员角色
    Version            int64  `json:"version"`                // 版本号
    IsDeleted          int    `json:"is_deleted"`             // 是否已删除
    Status             int    `json:"status"`                 // 成员状态
    InviteUID          string `json:"invite_uid"`             // 邀请人uid
    Robot              int    `json:"robot"`                  // 机器人标识
    ForbiddenExpirTime int64  `json:"forbidden_expir_time"`  // 禁言时长
    CreatedAt          string `json:"created_at"`             // 创建时间
    UpdatedAt          string `json:"updated_at"`             // 更新时间
}
```

## 🔄 事件通知

### 成员相关事件
- **GroupMemberAdd**: 成员添加事件
- **GroupMemberRemove**: 成员移除事件
- **GroupMemberScanJoin**: 扫码加入事件
- **GroupMemberTransferGrouper**: 群主转让事件
- **GroupMemberUpdate**: 成员信息更新事件
- **GroupAvatarUpdate**: 群头像更新事件

### 事件数据结构
```go
// 成员添加事件
type MsgGroupMemberAddReq struct {
    GroupNo      string              // 群组编号
    Operator     string              // 操作者
    OperatorName string              // 操作者名称
    Members      []*UserBaseVo       // 新增成员列表
}

// 成员移除事件
type MsgGroupMemberRemoveReq struct {
    GroupNo      string              // 群组编号
    Operator     string              // 操作者
    OperatorName string              // 操作者名称
    Members      []*UserBaseVo       // 被移除成员列表
}
```

## ⚠️ 重要业务逻辑

### 1. 权限验证机制
- **群主权限**: 可执行所有操作
- **管理员权限**: 可管理普通成员，不能管理其他管理员或群主
- **普通成员权限**: 只能修改自己的信息

### 2. 自动头像生成
- 当群成员数量<9且未上传过自定义头像时，系统会自动生成群头像
- 头像基于前9名成员的默认头像组合生成

### 3. 群主自动转让
- 群主退出时，自动转让给第二元老成员
- 确保群组不会因群主退出而解散

### 4. 禁言白名单机制
- 群全员禁言时，管理员自动加入白名单
- 管理员可正常发言，普通成员被禁言

### 5. 数据一致性保证
- 使用数据库事务确保操作的原子性
- 重要操作会同步到悟空IM系统
- 支持版本号机制进行增量同步

## 📝 错误码说明

- `400`: 请求参数错误
- `401`: 未授权访问
- `403`: 权限不足
- `404`: 资源不存在
- `500`: 服务器内部错误

### 常见错误信息
- "群开启了邀请模式，不能添加群成员！"
- "只有群管理者才能修改！"
- "管理员不能删除管理员"
- "不能删除自己"
- "操作用户权限不够"

## 🚀 最佳实践

### 1. 批量操作优化
- 成员管理支持批量操作，建议一次处理多个成员
- 减少API调用次数，提高效率

### 2. 增量同步策略
- 使用版本号进行增量数据同步
- 避免重复传输数据，节省带宽

### 3. 权限预检查
- 前端应提前检查用户权限
- 避免发送无效请求，提升用户体验

### 4. 实时状态更新
- 监听相关事件，及时更新UI状态
- 保持界面与后端数据的一致性

### 5. 错误处理机制
- 妥善处理各种错误情况
- 提供友好的用户提示信息

## 🔧 技术特性

### 1. 事务支持
- 涉及多表操作时使用数据库事务
- 确保数据的一致性和完整性

### 2. 事件驱动架构
- 重要操作会发布相应事件
- 支持异步处理和系统解耦

### 3. IM系统集成
- 与悟空IM深度集成
- 群组变更实时同步到IM系统

### 4. 缓存机制
- 支持头像版本控制
- 提高资源访问效率

### 5. 自动升级机制
- 普通群达到一定成员数可自动升级为超大群
- 支持不同规模的群组管理
