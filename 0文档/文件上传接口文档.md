# 文件上传接口文档

## 目录

- [概述](#概述)
- [基础信息](#基础信息)
- [接口列表](#接口列表)
  - [1. 获取文件上传地址](#1-获取文件上传地址)
  - [2. 上传文件](#2-上传文件)
  - [3. 文件预览/下载](#3-文件预览/下载)
- [特殊接口](#特殊接口)
  - [4. 用户头像上传](#4-用户头像上传)
  - [5. 群组头像上传](#5-群组头像上传)
- [存储服务配置](#存储服务配置)
  - [支持的存储后端](#支持的存储后端)
  - [配置文件示例](#配置文件示例)
- [前端集成示例](#前端集成示例)
  - [JavaScript上传示例](#javascript上传示例)
  - [头像上传示例](#头像上传示例)
- [错误码说明](#错误码说明)
- [注意事项](#注意事项)
  - [安全考虑](#安全考虑)
  - [性能优化](#性能优化)
  - [存储管理](#存储管理)
- [更新日志](#更新日志)
- [技术支持](#技术支持)

---

## 概述

唐僧叨叨服务器提供完整的文件上传服务，支持多种存储后端（MinIO、阿里云OSS、七牛云、SeaweedFS），支持所有文件类型上传，包括文档、图片、压缩包、可执行文件等。

## 基础信息

- **基础路径**: `/v1/file`
- **认证方式**: Token认证（除文件预览外）
- **支持格式**: multipart/form-data
- **文件大小限制**: 
  - 头像上传: 20MB
  - 群组头像: 20MB
  - 其他文件: 无限制（受存储服务限制）

## 接口列表

### 1. 获取文件上传地址

**接口地址**: `GET /v1/file/upload`

**接口描述**: 获取文件上传的临时地址，用于前端上传文件

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| path | string | 是 | 文件保存路径 |
| type | string | 是 | 文件类型 |

**文件类型说明**:

| 类型值 | 说明 | 用途 |
|--------|------|------|
| chat | 聊天文件 | 聊天中的文件传输 |
| moment | 动态文件 | 朋友圈动态中的文件 |
| momentcover | 动态封面 | 朋友圈动态封面图片 |
| sticker | 表情 | 自定义表情包 |
| report | 举报 | 举报相关文件 |
| common | 通用 | 通用文件上传 |
| chatbg | 聊天背景 | 聊天背景图片 |
| download | 下载文件 | 下载目录文件 |
| workplacebanner | 工作台横幅 | 工作台横幅图片 |
| workplaceappicon | 工作台图标 | 工作台应用图标 |

**请求示例**:
```bash
GET /v1/file/upload?type=chat&path=/user123/document.pdf
```

**响应示例**:
```json
{
  "url": "http://api.example.com/v1/file/upload?type=chat&path=/user123/document.pdf"
}
```

**返回地址用途说明**:

这个返回的URL地址是前端进行文件上传的**临时授权地址**，采用**两步上传**的安全机制：

#### **第一步：获取上传地址**
- 前端调用此接口获取上传地址
- 服务器验证用户权限和路径合法性
- 返回包含完整参数的上传URL

#### **第二步：使用返回地址上传文件**
- 前端使用返回的URL进行实际文件上传
- 服务器验证路径和类型是否匹配第一步的请求
- 确保上传安全性和一致性

#### **设计优势**：
1. **安全性**: 防止前端直接构造上传路径，确保路径合法性
2. **灵活性**: 支持不同存储后端，便于负载均衡和CDN配置
3. **可维护性**: 上传逻辑集中管理，便于添加日志、监控、限流等功能

#### **完整上传流程示例**：
```javascript
// 1. 获取上传地址
const response = await fetch('/v1/file/upload?type=chat&path=/user123/document.pdf');
const { url } = await response.json();

// 2. 使用返回的地址上传文件
const formData = new FormData();
formData.append('file', file);
await fetch(url, { method: 'POST', body: formData });
```

### 2. 上传文件

**接口地址**: `POST /v1/file/upload`

**接口描述**: 通过获取的上传地址上传文件

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file | file | 是 | 要上传的文件 |
| path | string | 是 | 文件保存路径（URL参数） |
| type | string | 是 | 文件类型（URL参数） |
| signature | int | 否 | 是否返回文件签名，1=返回，0=不返回 |
| contenttype | string | 否 | 文件MIME类型，默认application/octet-stream |

**请求示例**:
```bash
POST /v1/file/upload?type=chat&path=/user123/document.pdf&signature=1
Content-Type: multipart/form-data

file: [文件内容]
contenttype: application/pdf
```

**响应示例**:
```json
{
  "path": "file/preview/chat/user123/document.pdf",
  "sha512": "abc123..." // 当signature=1时返回
}
```

### 3. 文件预览/下载

**接口地址**: `GET /v1/file/preview/*path`

**接口描述**: 预览或下载已上传的文件

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| path | string | 是 | 文件路径（路径参数） |
| filename | string | 否 | 下载文件名，不填则使用原文件名 |

**请求示例**:
```bash
GET /v1/file/preview/chat/user123/document.pdf?filename=我的文档.pdf
```

**响应**: 直接返回文件内容，支持浏览器预览或下载

## 特殊接口

### 4. 用户头像上传

**接口地址**: `POST /v1/user/avatar`

**接口描述**: 上传用户头像（专用接口）

**特点**:
- 自动生成头像路径
- 支持PNG格式
- 文件大小限制：20MB
- 自动通知好友头像更新

**请求示例**:
```bash
POST /v1/user/avatar
Content-Type: multipart/form-data

file: [PNG图片文件]
```

### 5. 群组头像上传

**接口地址**: `POST /v1/group/{group_no}/avatar`

**接口描述**: 上传群组头像（专用接口）

**特点**:
- 仅群创建者可操作
- 文件大小限制：20MB
- 自动通知群成员头像更新

**请求示例**:
```bash
POST /v1/group/g123/avatar
Content-Type: multipart/form-data

file: [PNG图片文件]
```

## 存储服务配置

### 支持的存储后端

1. **MinIO** (默认)
   - 配置项: `fileService: "minio"`
   - 特点: 开源对象存储，支持S3协议

2. **阿里云OSS**
   - 配置项: `fileService: "aliyunOSS"`
   - 特点: 阿里云对象存储服务

3. **七牛云**
   - 配置项: `fileService: "qiniu"`
   - 特点: 七牛云对象存储

4. **SeaweedFS**
   - 配置项: `fileService: "seaweedFS"`
   - 特点: 分布式文件系统

### 配置文件示例

```yaml
##################### 文件服务 ####################
fileService: "minio" # 文件服务 minio or aliyunOSS or seaweedFS or qiniu

minio: # minio配置
  url: "http://localhost:9000" # minio地址
  accessKeyID: "minioadmin" # minio accessKeyID
  secretAccessKey: "minioadmin"  # minio secretAccessKey

#oss:  # aliyun oss配置
#  endpoint: "oss-cn-hangzhou.aliyuncs.com"
#  bucketURL: "https://bucket.oss-cn-hangzhou.aliyuncs.com"
#  accessKeyID: "your_access_key"
#  accessKeySecret: "your_secret_key"

#qiniu: # 七牛云配置
#  url: "http://cdn.example.com"
#  bucketName: "your_bucket"
#  accessKey: "your_access_key"
#  secretKey: "your_secret_key"

#seaweed: # seaweed配置
#  url: "http://localhost:9000"
```

## 前端集成示例

### JavaScript上传示例

```javascript
// 1. 获取上传地址
async function getUploadUrl(type, path) {
  const response = await fetch(`/v1/file/upload?type=${type}&path=${path}`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  const result = await response.json();
  return result.url;
}

// 2. 上传文件
async function uploadFile(type, path, file) {
  const uploadUrl = await getUploadUrl(type, path);
  
  const formData = new FormData();
  formData.append('file', file);
  formData.append('contenttype', file.type);
  
  const response = await fetch(uploadUrl, {
    method: 'POST',
    body: formData
  });
  
  const result = await response.json();
  return result.path;
}

// 使用示例
const fileInput = document.getElementById('fileInput');
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  const filePath = await uploadFile('chat', `/user123/${file.name}`, file);
  console.log('文件上传成功:', filePath);
});
```

### 头像上传示例

```javascript
// 用户头像上传
async function uploadUserAvatar(file) {
  const formData = new FormData();
  formData.append('file', file);
  
  const response = await fetch('/v1/user/avatar', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  });
  
  if (response.ok) {
    console.log('头像上传成功');
  }
}

// 群组头像上传
async function uploadGroupAvatar(groupNo, file) {
  const formData = new FormData();
  formData.append('file', file);
  
  const response = await fetch(`/v1/group/${groupNo}/avatar`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  });
  
  if (response.ok) {
    console.log('群头像上传成功');
  }
}
```

## 错误码说明

| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| 400 | 请求参数错误 | 检查必填参数是否完整 |
| 401 | 认证失败 | 检查Token是否有效 |
| 413 | 文件过大 | 检查文件大小是否超限 |
| 500 | 服务器内部错误 | 联系技术支持 |

## 注意事项

### 安全考虑
1. **文件类型验证**: 当前系统支持所有文件类型，包括.exe等可执行文件，建议前端添加文件类型白名单
2. **文件大小限制**: 建议根据业务需求设置合理的文件大小限制
3. **访问控制**: 文件访问需要相应的权限验证

### 性能优化
1. **大文件处理**: 对于大文件，建议使用分片上传
2. **CDN加速**: 建议配置CDN加速文件访问
3. **缓存策略**: 对于静态文件，建议配置适当的缓存策略

### 存储管理
1. **定期清理**: 建议定期清理无用的文件
2. **备份策略**: 重要文件建议配置备份策略
3. **监控告警**: 建议配置存储空间使用监控

## 更新日志

- **v1.0.0**: 初始版本，支持基础文件上传功能
- **v1.1.0**: 新增文件签名功能
- **v1.2.0**: 支持多种存储后端
- **v1.3.0**: 优化文件预览和下载功能

## 技术支持

如有问题，请联系技术支持团队或查看相关日志文件。
