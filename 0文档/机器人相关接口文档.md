# 机器人相关接口文档

## 📋 目录

- [概述](#概述)
- [基础信息](#基础信息)
- [认证说明](#认证说明)
- [接口列表](#接口列表)
  - [1. 机器人同步](#1-机器人同步)
  - [2. 机器人行内搜索](#2-机器人行内搜索)
  - [3. 获取机器人事件](#3-获取机器人事件)
  - [4. 机器人发送消息](#4-机器人发送消息)
  - [5. 机器人输入状态](#5-机器人输入状态)
  - [6. 流式消息开始](#6-流式消息开始)
  - [7. 流式消息结束](#7-流式消息结束)
  - [8. 事件确认](#8-事件确认)
  - [9. 响应行内搜索](#9-响应行内搜索)
- [数据模型](#数据模型)
- [错误码说明](#错误码说明)
- [使用示例](#使用示例)
- [更新日志](#更新日志)

---

## 概述

本文档描述了TangSengDaoDao系统中所有与机器人相关的API接口。机器人系统支持自动回复、行内搜索、消息发送等功能，为IM系统提供智能化的服务支持。

**注意**：本文档严格按照代码实现整理，确保接口信息的准确性和完整性。

---

## 基础信息

- **基础URL**: `http://localhost:8090`
- **API版本**: `v1`
- **认证方式**: 
  - 用户端接口：Token认证（在请求头中添加 `token: {token}`）
  - 机器人端接口：AppKey认证（在URL路径中传递）
- **数据格式**: JSON
- **字符编码**: UTF-8

---

## 认证说明

### 用户端认证
在调用用户端接口前，需要先登录获取token：

```bash
curl -X POST http://localhost:8090/v1/user/login \
  -H "Content-Type: application/json" \
  -d '{"username":"your_username","password":"your_password"}'
```

### 机器人端认证
机器人端接口使用AppKey认证，在URL路径中传递：
```
/v1/robots/{robot_id}/{app_key}/...
```

---

## 接口列表

### 1. 机器人同步

**接口地址**: `POST /v1/robot/sync`

**功能描述**: 同步机器人菜单和配置信息，获取机器人的最新状态和命令菜单。

**权限要求**: 需要用户登录

**请求参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `robot_id` | string | 否 | 机器人ID（兼容老版本） | `"u_10000"` |
| `version` | int64 | 是 | 当前版本号，用于增量同步 | `0` |
| `username` | string | 否 | 机器人用户名 | `"system"` |

**请求示例**:

```bash
curl -X POST http://localhost:8090/v1/robot/sync \
  -H "Content-Type: application/json" \
  -H "token: your_token_here" \
  -d '[
    {
      "robot_id": "u_10000",
      "version": 0,
      "username": "system"
    }
  ]'
```

**响应示例**:

```json
[
  {
    "robot_id": "u_10000",
    "username": "system",
    "inline_on": 1,
    "placeholder": "请输入搜索关键词",
    "status": 1,
    "version": 1755423150,
    "created_at": "2025-01-17 10:00:00",
    "updated_at": "2025-01-17 10:00:00",
    "menus": [
      {
        "cmd": "/基本信息",
        "remark": "唐僧叨叨基本信息",
        "type": "none",
        "robot_id": "u_10000",
        "created_at": "2025-01-17 10:00:00",
        "updated_at": "2025-01-17 10:00:00"
      }
    ]
  }
]
```

**响应字段说明**:
| 字段 | 类型 | 说明 |
|------|------|------|
| `robot_id` | string | 机器人唯一ID |
| `username` | string | 机器人用户名 |
| `inline_on` | int | 是否开启行内搜索：1=开启，0=关闭 |
| `placeholder` | string | 输入框占位符 |
| `status` | int | 机器人状态：1=启用，0=禁用 |
| `version` | int64 | 版本号 |
| `created_at` | string | 创建时间 |
| `updated_at` | string | 更新时间 |
| `menus` | array | 机器人命令菜单列表 |

---

### 2. 机器人行内搜索

**接口地址**: `POST /v1/robot/inline_query`

**功能描述**: 使用机器人的行内搜索功能，获取机器人提供的搜索结果。

**权限要求**: 需要用户登录

**请求参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `offset` | string | 否 | 搜索偏移位置，第一次为空 | `""` |
| `query` | string | 是 | 搜索关键字 | `"天气"` |
| `username` | string | 是 | 机器人名称 | `"weather_bot"` |
| `channel_id` | string | 是 | 频道ID | `"4cd7c2783f7b46178f994f7d12729fff"` |
| `channel_type` | uint8 | 是 | 频道类型：1=私聊，2=群聊 | `1` |

**请求示例**:

```bash
curl -X POST http://localhost:8090/v1/robot/inline_query \
  -H "Content-Type: application/json" \
  -H "token: your_token_here" \
  -d '{
    "offset": "",
    "query": "天气",
    "username": "weather_bot",
    "channel_id": "4cd7c2783f7b46178f994f7d12729fff",
    "channel_type": 1
  }'
```

**响应示例**:

```json
{
  "inline_query_sid": "query_123456",
  "type": "article",
  "next_offset": "offset_789",
  "results": [
    {
      "type": "article",
      "id": "weather_001",
      "title": "今日天气",
      "description": "晴天，温度25°C",
      "thumb_url": "http://localhost:9000/weather/icon.png",
      "input_message_content": {
        "message_text": "今日天气：晴天，温度25°C"
      }
    }
  ]
}
```

---

### 3. 获取机器人事件

**接口地址**: `GET /v1/robots/{robot_id}/{app_key}/events`

**功能描述**: 获取机器人的事件列表，包括消息事件和行内搜索事件。

**权限要求**: 需要机器人身份验证（AppKey）

**路径参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `robot_id` | string | 是 | 机器人ID | `"u_10000"` |
| `app_key` | string | 是 | 应用密钥 | `"app_key_123"` |

**查询参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `event_id` | string | 是 | 起始事件ID | `"0"` |
| `limit` | string | 否 | 返回数量限制，默认20，最大100 | `"20"` |

**请求示例**:

```bash
curl -X GET "http://localhost:8090/v1/robots/u_10000/app_key_123/events?event_id=0&limit=20" \
  -H "Content-Type: application/json"
```

**响应示例**:

```json
{
  "status": 1,
  "results": [
    {
      "event_id": 1755423150,
      "message": {
        "message_id": 1957012653087920128,
        "message_seq": 14,
        "from_uid": "user_123",
        "channel_id": "channel_456",
        "channel_type": 1,
        "timestamp": 1755423150,
        "payload": {
          "type": 1,
          "content": "你好，机器人"
        }
      },
      "inline_query": null
    }
  ]
}
```

**响应字段说明**:
| 字段 | 类型 | 说明 |
|------|------|------|
| `status` | int | 响应状态：1=成功，0=失败 |
| `results` | array | 事件结果列表 |
| `event_id` | int64 | 事件ID |
| `message` | object | 消息对象（如果存在） |
| `inline_query` | object | 行内搜索对象（如果存在） |

---

### 4. 机器人发送消息

**接口地址**: `POST /v1/robots/{robot_id}/{app_key}/sendMessage`

**功能描述**: 机器人发送消息到指定频道。

**权限要求**: 需要机器人身份验证（AppKey）

**路径参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `robot_id` | string | 是 | 机器人ID | `"u_10000"` |
| `app_key` | string | 是 | 应用密钥 | `"app_key_123"` |

**请求参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `setting` | uint8 | 否 | 消息设置 | `0` |
| `channel_id` | string | 是 | 频道ID | `"channel_456"` |
| `channel_type` | uint8 | 是 | 频道类型：1=私聊，2=群聊 | `1` |
| `stream_no` | string | 否 | 流式消息编号 | `"stream_789"` |
| `entities` | array | 否 | 消息实体数组 | `[]` |
| `payload` | object | 是 | 消息内容 | 见下方示例 |

**payload字段说明**:
| 字段 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `type` | int | 是 | 消息类型：1=文本 | `1` |
| `content` | string | 是 | 消息内容 | `"你好，我是机器人！"` |

**请求示例**:

```bash
curl -X POST http://localhost:8090/v1/robots/u_10000/app_key_123/sendMessage \
  -H "Content-Type: application/json" \
  -d '{
    "setting": 0,
    "channel_id": "channel_456",
    "channel_type": 1,
    "stream_no": "stream_789",
    "entities": [],
    "payload": {
      "type": 1,
      "content": "你好，我是机器人！"
    }
  }'
```

**响应示例**:

```json
{
  "message_id": 1957012653087920128,
  "message_seq": 15,
  "timestamp": 1755423150
}
```

---

### 5. 机器人输入状态

**接口地址**: `POST /v1/robots/{robot_id}/{app_key}/typing`

**功能描述**: 显示机器人的"正在输入"状态。

**权限要求**: 需要机器人身份验证（AppKey）

**路径参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `robot_id` | string | 是 | 机器人ID | `"u_10000"` |
| `app_key` | string | 是 | 应用密钥 | `"app_key_123"` |

**请求参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `channel_id` | string | 是 | 频道ID | `"channel_456"` |
| `channel_type` | uint8 | 是 | 频道类型：1=私聊，2=群聊 | `1` |

**请求示例**:

```bash
curl -X POST http://localhost:8090/v1/robots/u_10000/app_key_123/typing \
  -H "Content-Type: application/json" \
  -d '{
    "channel_id": "channel_456",
    "channel_type": 1
  }'
```

**响应示例**:

```json
{
  "code": 0,
  "message": "success"
}
```

---

### 6. 流式消息开始

**接口地址**: `POST /v1/robots/{robot_id}/{app_key}/stream/start`

**功能描述**: 开始流式消息。

**权限要求**: 需要机器人身份验证（AppKey）

**路径参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `robot_id` | string | 是 | 机器人ID | `"u_10000"` |
| `app_key` | string | 是 | 应用密钥 | `"app_key_123"` |

**请求参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `channel_id` | string | 是 | 频道ID | `"channel_456"` |
| `channel_type` | uint8 | 是 | 频道类型：1=私聊，2=群聊 | `1` |

**请求示例**:

```bash
curl -X POST http://localhost:8090/v1/robots/u_10000/app_key_123/stream/start \
  -H "Content-Type: application/json" \
  -d '{
    "channel_id": "channel_456",
    "channel_type": 1
  }'
```

**响应示例**:

```json
{
  "stream_no": "stream_123456"
}
```

---

### 7. 流式消息结束

**接口地址**: `POST /v1/robots/{robot_id}/{app_key}/stream/end`

**功能描述**: 结束流式消息。

**权限要求**: 需要机器人身份验证（AppKey）

**路径参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `robot_id` | string | 是 | 机器人ID | `"u_10000"` |
| `app_key` | string | 是 | 应用密钥 | `"app_key_123"` |

**请求参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `stream_no` | string | 是 | 流式消息编号 | `"stream_123456"` |

**请求示例**:

```bash
curl -X POST http://localhost:8090/v1/robots/u_10000/app_key_123/stream/end \
  -H "Content-Type: application/json" \
  -d '{
    "stream_no": "stream_123456"
  }'
```

**响应示例**:

```json
{
  "code": 0,
  "message": "success"
}
```

---

### 8. 事件确认

**接口地址**: `POST /v1/robots/{robot_id}/{app_key}/events/{event_id}/ack`

**功能描述**: 确认已处理的事件，系统会清理该事件。

**权限要求**: 需要机器人身份验证（AppKey）

**路径参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `robot_id` | string | 是 | 机器人ID | `"u_10000"` |
| `app_key` | string | 是 | 应用密钥 | `"app_key_123"` |
| `event_id` | string | 是 | 事件ID | `"1755423150"` |

**请求示例**:

```bash
curl -X POST http://localhost:8090/v1/robots/u_10000/app_key_123/events/1755423150/ack \
  -H "Content-Type: application/json"
```

**响应示例**:

```json
{
  "code": 0,
  "message": "success"
}
```

---

### 9. 响应行内搜索

**接口地址**: `POST /v1/robots/{robot_id}/{app_key}/answerInlineQuery`

**功能描述**: 响应行内搜索查询，返回搜索结果。

**权限要求**: 需要机器人身份验证（AppKey）

**路径参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `robot_id` | string | 是 | 机器人ID | `"u_10000"` |
| `app_key` | string | 是 | 应用密钥 | `"app_key_123"` |

**请求参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `inline_query_sid` | string | 是 | 行内搜索ID | `"query_123456"` |
| `type` | string | 是 | 结果类型 | `"gif"` |
| `id` | string | 是 | 结果ID | `"result_001"` |
| `results` | array | 否 | 结果数组 | `[]` |
| `next_offset` | string | 否 | 下次查询偏移量 | `"offset_789"` |

**请求示例**:

```bash
curl -X POST http://localhost:8090/v1/robots/u_10000/app_key_123/answerInlineQuery \
  -H "Content-Type: application/json" \
  -d '{
    "inline_query_sid": "query_123456",
    "type": "gif",
    "id": "result_001",
    "results": [],
    "next_offset": "offset_789"
  }'
```

**响应示例**:

```json
{
  "code": 0,
  "message": "success"
}
```

---

## 数据模型

### 机器人模型 (robot)

| 字段 | 类型 | 说明 |
|------|------|------|
| `AppID` | string | 应用ID |
| `RobotID` | string | 机器人唯一ID |
| `Username` | string | 机器人用户名 |
| `InlineOn` | int | 是否开启行内搜索：1=开启，0=关闭 |
| `Placeholder` | string | 输入框占位符 |
| `Token` | string | 机器人令牌 |
| `Version` | int64 | 版本号 |
| `Status` | int | 状态：1=启用，0=禁用 |

### 菜单模型 (menu)

| 字段 | 类型 | 说明 |
|------|------|------|
| `RobotID` | string | 机器人ID |
| `CMD` | string | 命令 |
| `Remark` | string | 命令说明 |
| `Type` | string | 命令类型 |

### 行内搜索模型 (InlineQuery)

| 字段 | 类型 | 说明 |
|------|------|------|
| `SID` | string | 搜索ID |
| `ChannelID` | string | 频道ID |
| `ChannelType` | uint8 | 频道类型 |
| `FromUID` | string | 发送者UID |
| `Query` | string | 查询关键字 |
| `Offset` | string | 偏移量 |

### 行内搜索结果 (InlineQueryResult)

| 字段 | 类型 | 说明 |
|------|------|------|
| `InlineQuerySID` | string | 行内搜索ID |
| `Type` | ResultType | 结果类型 |
| `ID` | string | 结果ID |
| `Results` | array | 结果数组 |
| `NextOffset` | string | 下次查询偏移量 |

---

## 错误码说明

| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| `401` | 未授权 | 检查AppKey是否正确 |
| `400` | 参数错误 | 检查必填参数是否完整 |
| `500` | 服务器错误 | 联系管理员或稍后重试 |

### 常见错误

#### **"机器人不存在"**
- 原因：robot_id无效或机器人已被删除
- 解决：检查robot_id是否正确

#### **"appKey不正确"**
- 原因：AppKey验证失败
- 解决：检查AppKey是否正确

#### **"不允许发送消息到此频道"**
- 原因：机器人没有该频道的发送权限
- 解决：检查频道权限设置

---

## 使用示例

### 完整的机器人工作流程

#### **1. 用户端获取机器人信息**
```bash
# 同步机器人菜单
curl -X POST http://localhost:8090/v1/robot/sync \
  -H "Content-Type: application/json" \
  -H "token: user_token" \
  -d '[{"robot_id": "u_10000", "version": 0, "username": "system"}]'
```

#### **2. 机器人端处理事件**
```bash
# 获取事件列表
curl -X GET "http://localhost:8090/v1/robots/u_10000/app_key_123/events?event_id=0&limit=20"

# 发送回复消息
curl -X POST http://localhost:8090/v1/robots/u_10000/app_key_123/sendMessage \
  -H "Content-Type: application/json" \
  -d '{
    "channel_id": "channel_456",
    "channel_type": 1,
    "payload": {"type": 1, "content": "收到您的消息！"}
  }'

# 确认事件已处理
curl -X POST http://localhost:8090/v1/robots/u_10000/app_key_123/events/1755423150/ack
```

#### **3. 行内搜索流程**
```bash
# 用户发起行内搜索
curl -X POST http://localhost:8090/v1/robot/inline_query \
  -H "Content-Type: application/json" \
  -H "token: user_token" \
  -d '{"query": "天气", "username": "weather_bot", "channel_id": "channel_456", "channel_type": 1}'

# 机器人响应搜索结果
curl -X POST http://localhost:8090/v1/robots/weather_bot/app_key_123/answerInlineQuery \
  -H "Content-Type: application/json" \
  -d '{"inline_query_sid": "query_123", "type": "article", "id": "weather_001"}'
```

---

## 更新日志

- **2025-08-17**: 创建机器人相关接口文档
- **2025-08-17**: 严格按照代码实现整理接口信息
- **2025-08-17**: 完善参数说明和响应示例
- **2025-08-17**: 添加数据模型和错误码说明

---

## 🔝 [返回顶部](#机器人相关接口文档)
