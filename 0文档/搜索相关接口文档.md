# 搜索相关接口文档

## 📋 目录

- [概述](#概述)
- [基础信息](#基础信息)
- [认证说明](#认证说明)
- [接口列表](#接口列表)
  - [1. 消息搜索](#1-消息搜索)
  - [2. 用户搜索](#2-用户搜索)
  - [3. 好友搜索](#3-好友搜索)
  - [4. 机器人行内搜索](#4-机器人行内搜索)
- [搜索配置说明](#搜索配置说明)
- [使用建议](#使用建议)
- [错误码说明](#错误码说明)
- [更新日志](#更新日志)

---

## 概述

本文档描述了TangSengDaoDao系统中所有面向客户端的搜索相关API接口。这些接口主要用于帮助用户快速找到需要的信息、用户或好友，提升用户体验。

**注意**：本文档中的接口都是**用户端接口**，不需要管理员权限，只需要用户登录即可使用。

---

## 基础信息

- **基础URL**: `http://localhost:8090`
- **API版本**: `v1`
- **认证方式**: Token认证（在请求头中添加 `token: {token}`）
- **数据格式**: JSON
- **字符编码**: UTF-8

---

## 认证说明

### 获取Token
在调用搜索接口前，需要先登录获取token：

```bash
curl -X POST http://localhost:8090/v1/user/login \
  -H "Content-Type: application/json" \
  -d '{"username":"your_username","password":"your_password"}'
```

### 使用Token
在请求头中添加token：
```bash
curl -H "token: your_token_here" \
  -H "Content-Type: application/json" \
  "http://localhost:8090/v1/message/search"
```

---

## 接口列表

### 1. 消息搜索

**接口地址**: `POST /v1/message/search`

**功能描述**: 搜索用户的聊天消息记录，支持按频道、消息类型等条件筛选。

**权限要求**: 需要用户登录

**请求参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `uid` | string | 是 | 搜索的消息限定在某个用户内（当前登录用户） | `"4cd7c2783f7b46178f994f7d12729fff"` |
| `channel_id` | string | 否 | 频道ID，不传则搜索所有频道 | `"4cd7c2783f7b46178f994f7d12729fff"` |
| `channel_type` | uint8 | 否 | 频道类型：1=私聊，2=群聊，不传则搜索所有类型 | `1` |
| `content_type` | int | 否 | 消息正文类型，不传则搜索所有类型 | `1` |
| `keyword` | string | 是 | 搜索关键字 | `"你好"` |

**消息类型对照表**:
| 类型值 | 说明 |
|--------|------|
| `1` | 文本消息 |
| `2` | 图片消息 |
| `3` | 语音消息 |
| `4` | 视频消息 |
| `5` | 文件消息 |
| `6` | GIF消息 |
| `7` | 位置消息 |
| `8` | 名片消息 |
| `9` | 动画表情 |
| `10` | emoji表情 |
| `11` | 聊天记录 |

**请求示例**:

```bash
curl -X POST http://localhost:8090/v1/message/search \
  -H "Content-Type: application/json" \
  -H "token: your_token_here" \
  -d '{
    "uid": "4cd7c2783f7b46178f994f7d12729fff",
    "channel_id": "4cd7c2783f7b46178f994f7d12729fff",
    "channel_type": 1,
    "content_type": 1,
    "keyword": "你好"
  }'
```

**响应示例**:

```json
[
  {
    "message_id": "1957012653087920128",
    "message_seq": 14,
    "from_uid": "4cd7c2783f7b46178f994f7d12729fff",
    "from_name": "张三",
    "channel_id": "4cd7c2783f7b46178f994f7d12729fff",
    "channel_type": 1,
    "timestamp": 1755423150,
    "payload": {
      "type": 1,
      "content": "你好，今天天气怎么样？"
    },
    "is_deleted": 0,
    "is_pinned": 0
  }
]
```

**注意事项**:
- 只能搜索当前登录用户的消息记录
- 搜索结果按时间倒序排列
- 支持模糊搜索
- 多媒体消息的payload中包含文件URL信息

---

### 2. 用户搜索

**接口地址**: `GET /v1/user/search`

**功能描述**: 搜索其他用户，用于添加好友等功能。

**权限要求**: 无需登录，任何人都可以搜索

**请求参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `keyword` | string | 是 | 搜索关键字（支持用户名、手机号、短编号） | `"张三"` |

**搜索范围**:
- 用户名（username）
- 手机号（phone）
- 短编号（short_no）

**请求示例**:

```bash
curl -X GET "http://localhost:8090/v1/user/search?keyword=张三" \
  -H "Content-Type: application/json"
```

**响应示例**:

```json
{
  "exist": 1,
  "data": {
    "uid": "4cd7c2783f7b46178f994f7d12729fff",
    "name": "张三",
    "username": "zhangsan",
    "short_no": "user001",
    "phone": "13800138000",
    "avatar": "http://localhost:9000/avatar/xxx.jpg",
    "status": 1,
    "sex": 1,
    "created_at": "2025-01-17 10:00:00"
  }
}
```

**响应字段说明**:
| 字段 | 说明 |
|------|------|
| `exist` | 是否找到用户：0=未找到，1=找到 |
| `data` | 用户信息（仅当exist=1时返回） |

**注意事项**:
- 手机号搜索可能被系统配置关闭
- 短编号搜索可能被用户个人设置关闭
- 搜索结果不包含已注销的用户

---

### 3. 好友搜索

**接口地址**: `GET /v1/friend/search`

**功能描述**: 在好友列表中搜索特定好友。

**权限要求**: 需要用户登录

**请求参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `keyword` | string | 是 | 搜索关键字 | `"张三"` |

**搜索范围**:
- 好友昵称（name）
- 好友备注（remark）

**请求示例**:

```bash
curl -X GET "http://localhost:8090/v1/friend/search?keyword=张三" \
  -H "Content-Type: application/json" \
  -H "token: your_token_here"
```

**响应示例**:

```json
[
  {
    "uid": "4cd7c2783f7b46178f994f7d12729fff",
    "name": "张三",
    "remark": "大学同学",
    "avatar": "http://localhost:9000/avatar/xxx.jpg",
    "status": 1,
    "is_alone": 0,
    "created_at": "2025-01-17 10:00:00"
  }
]
```

**响应字段说明**:
| 字段 | 说明 |
|------|------|
| `uid` | 好友UID |
| `name` | 好友昵称 |
| `remark` | 好友备注 |
| `avatar` | 头像URL |
| `status` | 好友状态：1=正常，2=黑名单 |
| `is_alone` | 是否为单项好友：0=双向，1=单项 |

**注意事项**:
- 只能搜索已添加的好友
- 支持模糊搜索
- 搜索结果按添加时间倒序排列

---

### 4. 机器人行内搜索

**接口地址**: `POST /v1/robot/inline_query`

**功能描述**: 使用机器人的行内搜索功能，获取机器人提供的搜索结果。

**权限要求**: 需要用户登录

**请求参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `offset` | string | 否 | 搜索偏移位置，第一次为空 | `""` |
| `query` | string | 是 | 搜索关键字 | `"天气"` |
| `username` | string | 是 | 机器人名称 | `"weather_bot"` |
| `channel_id` | string | 是 | 频道ID | `"4cd7c2783f7b46178f994f7d12729fff"` |
| `channel_type` | uint8 | 是 | 频道类型：1=私聊，2=群聊 | `1` |

**请求示例**:

```bash
curl -X POST http://localhost:8090/v1/robot/inline_query \
  -H "Content-Type: application/json" \
  -H "token: your_token_here" \
  -d '{
    "offset": "",
    "query": "天气",
    "username": "weather_bot",
    "channel_id": "4cd7c2783f7b46178f994f7d12729fff",
    "channel_type": 1
  }'
```

**响应示例**:

```json
{
  "inline_query_sid": "query_123456",
  "type": "article",
  "next_offset": "offset_789",
  "results": [
    {
      "type": "article",
      "id": "weather_001",
      "title": "今日天气",
      "description": "晴天，温度25°C",
      "thumb_url": "http://localhost:9000/weather/icon.png",
      "input_message_content": {
        "message_text": "今日天气：晴天，温度25°C"
      }
    }
  ]
}
```

**响应字段说明**:
| 字段 | 说明 |
|------|------|
| `inline_query_sid` | 搜索ID |
| `type` | 结果类型 |
| `next_offset` | 下次查询所需偏移量 |
| `results` | 搜索结果数组 |

**注意事项**:
- 需要先添加对应的机器人好友
- 不同机器人支持不同的搜索功能
- 支持分页加载更多结果

---

## 搜索配置说明

### 用户搜索配置

系统支持配置用户搜索的权限控制：

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `search_by_phone` | 是否允许通过手机号搜索用户 | 1（允许） |
| `search_by_short` | 是否允许通过短编号搜索用户 | 1（允许） |
| `phoneSearchOff` | 全局关闭手机号搜索功能 | false |

### 个人设置

用户可以在个人设置中控制自己的搜索可见性：

- **手机号搜索**: 控制其他用户是否可以通过手机号搜索到自己
- **短编号搜索**: 控制其他用户是否可以通过短编号搜索到自己

---

## 使用建议

### 1. 客户端集成

#### **搜索框设计**
- 提供统一的搜索入口
- 支持实时搜索建议
- 显示搜索历史记录

#### **搜索结果展示**
- 按类型分组显示结果
- 提供快速操作按钮
- 支持结果高亮显示

#### **搜索体验优化**
- 防抖处理，避免频繁请求
- 加载状态提示
- 空结果友好提示

### 2. 性能优化

- 合理设置搜索频率
- 本地缓存常用搜索结果
- 使用分页加载大量结果

### 3. 用户体验

- 搜索建议和自动补全
- 搜索历史记录
- 快速搜索快捷方式

---

## 错误码说明

| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| `401` | 未授权 | 检查token是否有效，重新登录 |
| `400` | 参数错误 | 检查必填参数是否完整 |
| `500` | 服务器错误 | 联系管理员或稍后重试 |

### 常见错误

#### **"token无效"**
- 原因：token已过期或无效
- 解决：重新登录获取新token

#### **"搜索关键字不能为空"**
- 原因：未传入搜索关键字
- 解决：确保传入有效的搜索关键字

#### **"用户不存在"**
- 原因：搜索的用户不存在或已被注销
- 解决：检查搜索关键字是否正确

---

## 更新日志

- **2025-08-17**: 创建搜索相关接口文档
- **2025-08-17**: 完善接口参数和响应示例
- **2025-08-17**: 添加使用建议和最佳实践

---

## �� [返回顶部](#搜索相关接口文档)
