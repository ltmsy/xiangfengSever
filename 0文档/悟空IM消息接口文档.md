# æ‚Ÿç©ºIMæ¶ˆæ¯æ¥å£æ–‡æ¡£

## ğŸ“‘ ç›®å½•

- [ğŸ“‹ æ–‡æ¡£æ¦‚è¿°](#-æ–‡æ¡£æ¦‚è¿°)
- [ğŸš€ å¿«é€Ÿå¼€å§‹](#-å¿«é€Ÿå¼€å§‹)
  - [åŸºç¡€ä¿¡æ¯](#åŸºç¡€ä¿¡æ¯)
  - [è®¤è¯æ–¹å¼](#è®¤è¯æ–¹å¼)
- [ğŸ“¨ æ¶ˆæ¯å‘é€æ¥å£](#-æ¶ˆæ¯å‘é€æ¥å£)
  - [1. å‘é€å•æ¡æ¶ˆæ¯](#1-å‘é€å•æ¡æ¶ˆæ¯)
  - [2. æ‰¹é‡å‘é€æ¶ˆæ¯](#2-æ‰¹é‡å‘é€æ¶ˆæ¯)
- [ğŸ” æ¶ˆæ¯æŸ¥è¯¢æ¥å£](#-æ¶ˆæ¯æŸ¥è¯¢æ¥å£)
  - [3. æ‰¹é‡æŸ¥è¯¢æ¶ˆæ¯](#3-æ‰¹é‡æŸ¥è¯¢æ¶ˆæ¯)
  - [4. æœç´¢å•æ¡æ¶ˆæ¯](#4-æœç´¢å•æ¡æ¶ˆæ¯)
- [ğŸ”„ æ¶ˆæ¯åŒæ­¥æ¥å£](#-æ¶ˆæ¯åŒæ­¥æ¥å£)
  - [5. é¢‘é“æ¶ˆæ¯åŒæ­¥ï¼ˆæ¨èï¼‰](#5-é¢‘é“æ¶ˆæ¯åŒæ­¥æ¨è)
  - [6. è·å–é¢‘é“æœ€å¤§æ¶ˆæ¯åºå·](#6-è·å–é¢‘é“æœ€å¤§æ¶ˆæ¯åºå·)
- [ğŸ¢ ç®¡ç†ç«¯æ¶ˆæ¯æœç´¢æ¥å£](#-ç®¡ç†ç«¯æ¶ˆæ¯æœç´¢æ¥å£)
  - [7. é›†ç¾¤æ¶ˆæ¯æœç´¢](#7-é›†ç¾¤æ¶ˆæ¯æœç´¢)
- [âŒ å·²åºŸå¼ƒçš„æ¥å£](#-å·²åºŸå¼ƒçš„æ¥å£)
  - [8. æ¶ˆæ¯åŒæ­¥ï¼ˆå·²åºŸå¼ƒï¼‰](#8-æ¶ˆæ¯åŒæ­¥å·²åºŸå¼ƒ)
  - [9. æ¶ˆæ¯åŒæ­¥å›æ‰§ï¼ˆå·²åºŸå¼ƒï¼‰](#9-æ¶ˆæ¯åŒæ­¥å›æ‰§å·²åºŸå¼ƒ)
- [ğŸŒŠ æµæ¶ˆæ¯æ¥å£](#-æµæ¶ˆæ¯æ¥å£)
  - [10. å¼€å¯æµæ¶ˆæ¯](#10-å¼€å¯æµæ¶ˆæ¯)
  - [11. å…³é—­æµæ¶ˆæ¯](#11-å…³é—­æµæ¶ˆæ¯)
- [ğŸ“Š æ¶ˆæ¯æ•°æ®ç»“æ„](#-æ¶ˆæ¯æ•°æ®ç»“æ„)
  - [æ¶ˆæ¯å“åº”æ ¼å¼](#æ¶ˆæ¯å“åº”æ ¼å¼)
  - [æ¶ˆæ¯å¤´éƒ¨æ ¼å¼](#æ¶ˆæ¯å¤´éƒ¨æ ¼å¼)
  - [é¢‘é“ç±»å‹è¯´æ˜](#é¢‘é“ç±»å‹è¯´æ˜)
- [ğŸ’¡ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)
  - [1. æ¶ˆæ¯åŒæ­¥ç­–ç•¥](#1-æ¶ˆæ¯åŒæ­¥ç­–ç•¥)
  - [2. æ¶ˆæ¯å‘é€ä¼˜åŒ–](#2-æ¶ˆæ¯å‘é€ä¼˜åŒ–)
  - [3. é”™è¯¯å¤„ç†](#3-é”™è¯¯å¤„ç†)
- [ğŸ”§ é…ç½®è¯´æ˜](#-é…ç½®è¯´æ˜)
  - [Webhooké…ç½®](#webhooké…ç½®)
  - [é›†ç¾¤é…ç½®](#é›†ç¾¤é…ç½®)
- [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)
- [ğŸ†˜ æŠ€æœ¯æ”¯æŒ](#-æŠ€æœ¯æ”¯æŒ)
- [ğŸ“ æ›´æ–°æ—¥å¿—](#-æ›´æ–°æ—¥å¿—)

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†æ‚Ÿç©ºIMï¼ˆWuKongIMï¼‰æä¾›çš„æ‰€æœ‰æ¶ˆæ¯ç›¸å…³æ¥å£ï¼ŒåŒ…æ‹¬æ¶ˆæ¯å‘é€ã€æŸ¥è¯¢ã€åŒæ­¥ç­‰åŠŸèƒ½ã€‚æ‚Ÿç©ºIMæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„åˆ†å¸ƒå¼å³æ—¶é€šè®¯ç³»ç»Ÿï¼Œæ”¯æŒä¸ªäººèŠå¤©ã€ç¾¤ç»„èŠå¤©ã€å®¢æœèŠå¤©ç­‰å¤šç§åœºæ™¯ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºç¡€ä¿¡æ¯
- **æœåŠ¡åœ°å€**: `http://localhost:5001`
- **APIæ–‡æ¡£**: `http://localhost:5001/docs`
- **å¥åº·æ£€æŸ¥**: `http://localhost:5001/health`
- **ç®¡ç†åå°**: `http://localhost:5300/web`

### è®¤è¯æ–¹å¼
æ‚Ÿç©ºIMæ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼š
- **Tokenè®¤è¯**: é€šè¿‡Headerä¸­çš„Authorizationå­—æ®µä¼ é€’
- **æ— è®¤è¯æ¨¡å¼**: éƒ¨åˆ†æ¥å£æ”¯æŒæ— è®¤è¯è®¿é—®
- **Webhookè®¤è¯**: é€šè¿‡é…ç½®çš„å¯†é’¥è¿›è¡ŒéªŒè¯

---

## ğŸ“¨ æ¶ˆæ¯å‘é€æ¥å£

### 1. å‘é€å•æ¡æ¶ˆæ¯

**æ¥å£åœ°å€**: `POST /message/send`

**åŠŸèƒ½æè¿°**: å‘æŒ‡å®šé¢‘é“å‘é€å•æ¡æ¶ˆæ¯

**è¯·æ±‚å‚æ•°**:
```json
{
  "header": {
    "no_persist": 0,      // æ˜¯å¦ä¸æŒä¹…åŒ– (0=æŒä¹…åŒ–, 1=ä¸æŒä¹…åŒ–)
    "red_dot": 1,         // æ˜¯å¦æ˜¾ç¤ºçº¢ç‚¹ (0=ä¸æ˜¾ç¤º, 1=æ˜¾ç¤º)
    "sync_once": 0        // æ˜¯å¦åªåŒæ­¥ä¸€æ¬¡ (0=å¦, 1=æ˜¯)
  },
  "client_msg_no": "msg_001",     // å®¢æˆ·ç«¯æ¶ˆæ¯å·ï¼ˆå¯é€‰ï¼‰
  "stream_no": "",                // æµæ¶ˆæ¯å·ï¼ˆå¯é€‰ï¼‰
  "from_uid": "user123",          // å‘é€è€…ç”¨æˆ·ID
  "channel_id": "group123",       // é¢‘é“ID
  "channel_type": 2,              // é¢‘é“ç±»å‹ (1=ä¸ªäºº, 2=ç¾¤ç»„)
  "expire": 0,                    // æ¶ˆæ¯è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼Œ0=æ°¸ä¸è¿‡æœŸï¼‰
  "subscribers": [],              // æŒ‡å®šè®¢é˜…è€…åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
  "payload": "SGVsbG8gV29ybGQ=", // Base64ç¼–ç çš„æ¶ˆæ¯å†…å®¹
  "tag_key": "important"          // æ¶ˆæ¯æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "message_id": 123456789,
  "message_seq": 1001,
  "client_msg_no": "msg_001"
}
```

**ä½¿ç”¨è¯´æ˜**:
- `payload`å­—æ®µå¿…é¡»è¿›è¡ŒBase64ç¼–ç 
- `channel_type`ä¸º1æ—¶è¡¨ç¤ºä¸ªäººèŠå¤©ï¼Œä¸º2æ—¶è¡¨ç¤ºç¾¤ç»„èŠå¤©
- ä¸ªäººèŠå¤©æ—¶ï¼Œ`channel_id`åº”ä¸ºå¯¹æ–¹ç”¨æˆ·ID
- ç¾¤ç»„èŠå¤©æ—¶ï¼Œ`channel_id`åº”ä¸ºç¾¤ç»„ID

### 2. æ‰¹é‡å‘é€æ¶ˆæ¯

**æ¥å£åœ°å€**: `POST /message/sendbatch`

**åŠŸèƒ½æè¿°**: æ‰¹é‡å‘é€å¤šæ¡æ¶ˆæ¯

**è¯·æ±‚å‚æ•°**:
```json
[
  {
    "header": {"no_persist": 0, "red_dot": 1, "sync_once": 0},
    "from_uid": "user123",
    "channel_id": "group123",
    "channel_type": 2,
    "payload": "SGVsbG8gV29ybGQ="
  },
  {
    "header": {"no_persist": 0, "red_dot": 0, "sync_once": 0},
    "from_uid": "user123",
    "channel_id": "group456",
    "channel_type": 2,
    "payload": "V2VsY29tZQ=="
  }
]
```

**å“åº”ç¤ºä¾‹**:
```json
[
  {
    "message_id": 123456789,
    "message_seq": 1001,
    "client_msg_no": "msg_001"
  },
  {
    "message_id": 123456790,
    "message_seq": 1002,
    "client_msg_no": "msg_002"
  }
]
```

---

## ğŸ” æ¶ˆæ¯æŸ¥è¯¢æ¥å£

### 3. æ‰¹é‡æŸ¥è¯¢æ¶ˆæ¯

**æ¥å£åœ°å€**: `POST /messages`

**åŠŸèƒ½æè¿°**: æ ¹æ®å¤šç§æ¡ä»¶æ‰¹é‡æŸ¥è¯¢æ¶ˆæ¯

**è¯·æ±‚å‚æ•°**:
```json
{
  "login_uid": "user123",                    // å½“å‰ç™»å½•ç”¨æˆ·ID
  "channel_id": "group123",                  // é¢‘é“ID
  "channel_type": 2,                         // é¢‘é“ç±»å‹
  "message_seqs": [1001, 1002, 1003],       // æŒ‰æ¶ˆæ¯åºå·æŸ¥è¯¢ï¼ˆå¯é€‰ï¼‰
  "message_ids": [123456789, 123456790],     // æŒ‰æ¶ˆæ¯IDæŸ¥è¯¢ï¼ˆå¯é€‰ï¼‰
  "client_msg_nos": ["msg001", "msg002"]     // æŒ‰å®¢æˆ·ç«¯æ¶ˆæ¯å·æŸ¥è¯¢ï¼ˆå¯é€‰ï¼‰
}
```

**å“åº”ç¤ºä¾‹**:
```json
[
  {
    "message_id": 123456789,
    "message_seq": 1001,
    "client_msg_no": "msg001",
    "from_uid": "user123",
    "channel_id": "group123",
    "channel_type": 2,
    "target_uid": "group123",
    "timestamp": 1640995200,
    "payload": "SGVsbG8gV29ybGQ="
  }
]
```

**ä½¿ç”¨è¯´æ˜**:
- ä¸‰ç§æŸ¥è¯¢æ¡ä»¶å¯ä»¥ç»„åˆä½¿ç”¨
- è‡³å°‘éœ€è¦æä¾›ä¸€ç§æŸ¥è¯¢æ¡ä»¶
- è¿”å›çš„æ¶ˆæ¯æŒ‰æ—¶é—´å€’åºæ’åˆ—

### 4. æœç´¢å•æ¡æ¶ˆæ¯

**æ¥å£åœ°å€**: `POST /message`

**åŠŸèƒ½æè¿°**: ç²¾ç¡®æŸ¥è¯¢å•æ¡æ¶ˆæ¯

**è¯·æ±‚å‚æ•°**:
```json
{
  "login_uid": "user123",        // å½“å‰ç™»å½•ç”¨æˆ·ID
  "channel_id": "group123",      // é¢‘é“ID
  "channel_type": 2,             // é¢‘é“ç±»å‹
  "message_id": 123456789,       // æ¶ˆæ¯IDï¼ˆäºŒé€‰ä¸€ï¼‰
  "client_msg_no": "msg001"      // å®¢æˆ·ç«¯æ¶ˆæ¯å·ï¼ˆäºŒé€‰ä¸€ï¼‰
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "message_id": 123456789,
  "message_seq": 1001,
  "client_msg_no": "msg001",
  "from_uid": "user123",
  "channel_id": "group123",
  "channel_type": 2,
  "target_uid": "group123",
  "timestamp": 1640995200,
  "payload": "SGVsbG8gV29ybGQ="
}
```

**ä½¿ç”¨è¯´æ˜**:
- `message_id`å’Œ`client_msg_no`å¿…é¡»æä¾›å…¶ä¸­ä¸€ä¸ª
- ä¸ªäººèŠå¤©æ—¶å¿…é¡»æä¾›`login_uid`
- å¦‚æœæ¶ˆæ¯ä¸å­˜åœ¨ï¼Œè¿”å›404çŠ¶æ€ç 

---

## ğŸ”„ æ¶ˆæ¯åŒæ­¥æ¥å£

### 5. é¢‘é“æ¶ˆæ¯åŒæ­¥ï¼ˆæ¨èï¼‰

**æ¥å£åœ°å€**: `POST /channel/messagesync`

**åŠŸèƒ½æè¿°**: åŒæ­¥æŒ‡å®šé¢‘é“çš„æ¶ˆæ¯ï¼Œæ”¯æŒåˆ†é¡µå’ŒèŒƒå›´æŸ¥è¯¢

**è¯·æ±‚å‚æ•°**:
```json
{
  "login_uid": "user123",           // å½“å‰ç™»å½•ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
  "channel_id": "group123",         // é¢‘é“IDï¼ˆå¿…å¡«ï¼‰
  "channel_type": 2,                // é¢‘é“ç±»å‹ï¼ˆå¿…å¡«ï¼‰
  "start_message_seq": 100,         // å¼€å§‹æ¶ˆæ¯åºå·ï¼ˆåŒ…å«ï¼Œå¯é€‰ï¼‰
  "end_message_seq": 200,           // ç»“æŸæ¶ˆæ¯åºå·ï¼ˆä¸åŒ…å«ï¼Œå¯é€‰ï¼‰
  "limit": 50,                      // æ¯æ¬¡åŒæ­¥æ•°é‡é™åˆ¶ï¼ˆæœ€å¤§10000ï¼‰
  "pull_mode": 0,                   // æ‹‰å–æ¨¡å¼ (0=å‘ä¸‹æ‹‰å–, 1=å‘ä¸Šæ‹‰å–)
  "stream_v2": 0                    // æ˜¯å¦ä½¿ç”¨stream_v2 (0=å¦, 1=æ˜¯)
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "start_message_seq": 100,
  "end_message_seq": 200,
  "more": 1,                        // æ˜¯å¦æœ‰æ›´å¤šæ•°æ® (0=å¦, 1=æ˜¯)
  "messages": [
    {
      "message_id": 123456789,
      "message_seq": 100,
      "client_msg_no": "msg001",
      "from_uid": "user123",
      "channel_id": "group123",
      "channel_type": 2,
      "target_uid": "group123",
      "timestamp": 1640995200,
      "payload": "SGVsbG8gV29ybGQ="
    }
  ]
}
```

**ä½¿ç”¨è¯´æ˜**:
- **æ¨èä½¿ç”¨**ï¼šè¿™æ˜¯æ¶ˆæ¯åŒæ­¥çš„ä¸»è¦æ¥å£
- å¦‚æœä¸æä¾›`start_message_seq`å’Œ`end_message_seq`ï¼Œåˆ™è¿”å›æœ€æ–°çš„æ¶ˆæ¯
- `pull_mode`ä¸º0æ—¶å‘ä¸‹æ‹‰å–ï¼ˆè·å–æ›´æ–°çš„æ¶ˆæ¯ï¼‰ï¼Œä¸º1æ—¶å‘ä¸Šæ‹‰å–ï¼ˆè·å–æ›´æ—©çš„æ¶ˆæ¯ï¼‰
- `more`å­—æ®µç”¨äºåˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®ï¼Œå®ç°åˆ†é¡µåŠ è½½

### 6. è·å–é¢‘é“æœ€å¤§æ¶ˆæ¯åºå·

**æ¥å£åœ°å€**: `GET /channel/max_message_seq`

**åŠŸèƒ½æè¿°**: è·å–æŒ‡å®šé¢‘é“æœ€æ–°çš„æ¶ˆæ¯åºå·

**è¯·æ±‚å‚æ•°**:
```
GET /channel/max_message_seq?channel_id=group123&channel_type=2
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "message_seq": 12345
}
```

**ä½¿ç”¨è¯´æ˜**:
- ç”¨äºåˆ¤æ–­é¢‘é“æ˜¯å¦æœ‰æ–°æ¶ˆæ¯
- å®¢æˆ·ç«¯å¯ä»¥ä¿å­˜ä¸Šæ¬¡åŒæ­¥çš„æœ€å¤§åºå·ï¼Œä¸æ–°åºå·æ¯”è¾ƒåˆ¤æ–­æ˜¯å¦éœ€è¦åŒæ­¥

---

## ğŸ¢ ç®¡ç†ç«¯æ¶ˆæ¯æœç´¢æ¥å£

### 7. é›†ç¾¤æ¶ˆæ¯æœç´¢

**æ¥å£åœ°å€**: `GET /cluster/messages`

**åŠŸèƒ½æè¿°**: åœ¨é›†ç¾¤èŒƒå›´å†…æœç´¢æ¶ˆæ¯ï¼Œæ”¯æŒå¤šç§æœç´¢æ¡ä»¶

**è¯·æ±‚å‚æ•°**:
```
GET /cluster/messages?node_id=1&from_uid=user123&channel_id=group123&channel_type=2&limit=20&offset_message_id=0&pre=0&payload=base64å†…å®¹&message_id=123&client_msg_no=msg001
```

**å‚æ•°è¯´æ˜**:
- `node_id`: èŠ‚ç‚¹IDï¼ˆ0è¡¨ç¤ºæ‰€æœ‰èŠ‚ç‚¹ï¼‰
- `from_uid`: å‘é€è€…ç”¨æˆ·ID
- `channel_id`: é¢‘é“ID
- `channel_type`: é¢‘é“ç±»å‹
- `limit`: è¿”å›æ•°é‡é™åˆ¶
- `offset_message_id`: åç§»æ¶ˆæ¯ID
- `offset_message_seq`: åç§»æ¶ˆæ¯åºå·
- `pre`: æ˜¯å¦å‘å‰æœç´¢ï¼ˆ1=æ˜¯ï¼Œ0=å¦ï¼‰
- `payload`: Base64ç¼–ç çš„æ¶ˆæ¯å†…å®¹ï¼ˆç”¨äºå†…å®¹æœç´¢ï¼‰
- `message_id`: æ¶ˆæ¯ID
- `client_msg_no`: å®¢æˆ·ç«¯æ¶ˆæ¯å·

**å“åº”ç¤ºä¾‹**:
```json
{
  "data": [
    {
      "message_id": 123456789,
      "message_seq": 1001,
      "client_msg_no": "msg001",
      "from_uid": "user123",
      "channel_id": "group123",
      "channel_type": 2,
      "target_uid": "group123",
      "timestamp": 1640995200,
      "payload": "SGVsbG8gV29ybGQ="
    }
  ],
  "total": 1000
}
```

**ä½¿ç”¨è¯´æ˜**:
- æ”¯æŒè·¨èŠ‚ç‚¹æœç´¢
- æ”¯æŒæ¶ˆæ¯å†…å®¹æ¨¡ç³Šæœç´¢ï¼ˆé€šè¿‡payloadå‚æ•°ï¼‰
- æ”¯æŒåˆ†é¡µå’Œåç§»æŸ¥è¯¢
- è¿”å›æ€»æ¶ˆæ¯æ•°é‡

---

## âŒ å·²åºŸå¼ƒçš„æ¥å£

### 8. æ¶ˆæ¯åŒæ­¥ï¼ˆå·²åºŸå¼ƒï¼‰

**æ¥å£åœ°å€**: `POST /message/sync`

**çŠ¶æ€**: å·²åºŸå¼ƒï¼Œä¸æ¨èä½¿ç”¨

**åºŸå¼ƒåŸå› **: åç»­ä¸æä¾›å¸¦å­˜å‚¨çš„å‘½ä»¤æ¶ˆæ¯ï¼Œä¸šåŠ¡ç«¯é€šè¿‡ä¸å­˜å‚¨çš„å‘½ä»¤ + è°ƒç”¨ä¸šåŠ¡ç«¯æ¥å£ä¸€æ ·å¯ä»¥å®ç°ç›¸åŒæ•ˆæœ

**æ›¿ä»£æ–¹æ¡ˆ**: ä½¿ç”¨ `/channel/messagesync` æ¥å£

### 9. æ¶ˆæ¯åŒæ­¥å›æ‰§ï¼ˆå·²åºŸå¼ƒï¼‰

**æ¥å£åœ°å€**: `POST /message/syncack`

**çŠ¶æ€**: å·²åºŸå¼ƒï¼Œä¸æ¨èä½¿ç”¨

**åºŸå¼ƒåŸå› **: ä¸ `/message/sync` é…å¥—çš„åºŸå¼ƒæ¥å£

---

## ğŸŒŠ æµæ¶ˆæ¯æ¥å£

### 10. å¼€å¯æµæ¶ˆæ¯

**æ¥å£åœ°å€**: `POST /stream/open`

**åŠŸèƒ½æè¿°**: å¼€å¯ä¸€ä¸ªæµæ¶ˆæ¯ä¼šè¯

**è¯·æ±‚å‚æ•°**:
```json
{
  "header": {"no_persist": 0, "red_dot": 1, "sync_once": 0},
  "client_msg_no": "stream_msg_001",
  "from_uid": "user123",
  "channel_id": "group123",
  "channel_type": 2,
  "payload": "SGVsbG8gV29ybGQ="
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "stream_no": "stream_abc123"
}
```

### 11. å…³é—­æµæ¶ˆæ¯

**æ¥å£åœ°å€**: `POST /stream/close`

**åŠŸèƒ½æè¿°**: å…³é—­æµæ¶ˆæ¯ä¼šè¯

**è¯·æ±‚å‚æ•°**:
```json
{
  "stream_no": "stream_abc123"
}
```

---

## ğŸ“Š æ¶ˆæ¯æ•°æ®ç»“æ„

### æ¶ˆæ¯å“åº”æ ¼å¼

```json
{
  "message_id": 123456789,        // æ¶ˆæ¯å”¯ä¸€IDï¼ˆint64ï¼‰
  "message_seq": 1001,            // æ¶ˆæ¯åºå·ï¼ˆuint64ï¼‰
  "client_msg_no": "msg001",      // å®¢æˆ·ç«¯æ¶ˆæ¯å·ï¼ˆstringï¼‰
  "from_uid": "user123",          // å‘é€è€…ç”¨æˆ·IDï¼ˆstringï¼‰
  "channel_id": "group123",       // é¢‘é“IDï¼ˆstringï¼‰
  "channel_type": 2,              // é¢‘é“ç±»å‹ï¼ˆuint8ï¼‰
  "target_uid": "group123",       // ç›®æ ‡ç”¨æˆ·/ç¾¤ç»„IDï¼ˆstringï¼‰
  "timestamp": 1640995200,        // æ¶ˆæ¯æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
  "payload": "SGVsbG8gV29ybGQ=", // Base64ç¼–ç çš„æ¶ˆæ¯å†…å®¹
  "setting": 0,                   // æ¶ˆæ¯è®¾ç½®ï¼ˆuint8ï¼‰
  "expire": 0                     // è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
}
```

### æ¶ˆæ¯å¤´éƒ¨æ ¼å¼

```json
{
  "no_persist": 0,    // æ˜¯å¦ä¸æŒä¹…åŒ– (0=æŒä¹…åŒ–, 1=ä¸æŒä¹…åŒ–)
  "red_dot": 1,       // æ˜¯å¦æ˜¾ç¤ºçº¢ç‚¹ (0=ä¸æ˜¾ç¤º, 1=æ˜¾ç¤º)
  "sync_once": 0      // æ˜¯å¦åªåŒæ­¥ä¸€æ¬¡ (0=å¦, 1=æ˜¯)
}
```

### é¢‘é“ç±»å‹è¯´æ˜

| ç±»å‹å€¼ | è¯´æ˜ | æè¿° |
|--------|------|------|
| 1 | ä¸ªäººèŠå¤© | ä¸€å¯¹ä¸€ç§èŠ |
| 2 | ç¾¤ç»„èŠå¤© | ç¾¤ç»„èŠå¤© |
| 3 | å®¢æœèŠå¤© | å®¢æœç³»ç»Ÿ |
| 4 | ç¤¾åŒºèŠå¤© | ç¤¾åŒºè®ºå› |

### target_uid å­—æ®µè¯´æ˜

`target_uid` å­—æ®µç”¨äºå¿«é€Ÿè¯†åˆ«æ¶ˆæ¯çš„ç›®æ ‡å¯¹è±¡ï¼Œæ— éœ€å†è§£æ `channel_id` å’Œ `channel_type` çš„ç»„åˆã€‚

**å­—æ®µå«ä¹‰**:
- **å­—æ®µå**: `target_uid`
- **ç±»å‹**: `string`
- **è¯´æ˜**: ç›®æ ‡ç”¨æˆ·/ç¾¤ç»„ID

**ä½¿ç”¨åœºæ™¯**:

**ç§èŠåœºæ™¯ï¼ˆ`channel_type = 1`ï¼‰**:
- `target_uid` = å¯¹æ–¹ç”¨æˆ·ID
- ä¾‹å¦‚ï¼šç”¨æˆ·Aå‘ç”¨æˆ·Bå‘é€æ¶ˆæ¯ï¼Œ`target_uid` ä¸º "userB"

**ç¾¤èŠåœºæ™¯ï¼ˆ`channel_type = 2`ï¼‰**:
- `target_uid` = ç¾¤ç»„ID  
- ä¾‹å¦‚ï¼šåœ¨ç¾¤ç»„ "group123" ä¸­å‘é€æ¶ˆæ¯ï¼Œ`target_uid` ä¸º "group123"

**ä¸šåŠ¡åº”ç”¨**:
- å¿«é€Ÿè·å–æ¶ˆæ¯æ¥æ”¶æ–¹ä¿¡æ¯
- ç®€åŒ–å‰ç«¯æ˜¾ç¤ºé€»è¾‘
- å‡å°‘ä¸šåŠ¡ç«¯æ•°æ®è§£æå·¥ä½œ

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æ¶ˆæ¯åŒæ­¥ç­–ç•¥

**å¢é‡åŒæ­¥**:
```javascript
// 1. è·å–é¢‘é“æœ€å¤§æ¶ˆæ¯åºå·
const maxSeq = await getChannelMaxMessageSeq(channelId, channelType);

// 2. ä¸æœ¬åœ°ä¿å­˜çš„åºå·æ¯”è¾ƒ
if (maxSeq > localLastSeq) {
  // 3. åŒæ­¥æ–°æ¶ˆæ¯
  const messages = await syncChannelMessages(channelId, channelType, localLastSeq, maxSeq);
  // 4. æ›´æ–°æœ¬åœ°åºå·
  localLastSeq = maxSeq;
}
```

**åˆ†é¡µåŠ è½½**:
```javascript
// 1. é¦–æ¬¡åŠ è½½æœ€æ–°æ¶ˆæ¯
let messages = await syncChannelMessages(channelId, channelType, 0, 0, 50);

// 2. å‘ä¸ŠåŠ è½½æ›´å¤šå†å²æ¶ˆæ¯
if (messages.more) {
  const moreMessages = await syncChannelMessages(
    channelId, 
    channelType, 
    0, 
    messages.messages[0].message_seq, 
    50, 
    1  // pull_mode = 1 (å‘ä¸Šæ‹‰å–)
  );
}
```

### 2. æ¶ˆæ¯å‘é€ä¼˜åŒ–

**æ‰¹é‡å‘é€**:
```javascript
// å¯¹äºéœ€è¦å‘é€å¤šæ¡æ¶ˆæ¯çš„åœºæ™¯ï¼Œä½¿ç”¨æ‰¹é‡æ¥å£
const batchMessages = [
  { from_uid: "user123", channel_id: "group1", channel_type: 2, payload: "Hello" },
  { from_uid: "user123", channel_id: "group2", channel_type: 2, payload: "World" }
];

const results = await sendBatchMessages(batchMessages);
```

**æ¶ˆæ¯å»é‡**:
```javascript
// ä½¿ç”¨client_msg_noé¿å…é‡å¤å‘é€
const clientMsgNo = generateUniqueId();
const result = await sendMessage({
  client_msg_no: clientMsgNo,
  from_uid: "user123",
  channel_id: "group123",
  channel_type: 2,
  payload: "Hello World"
});
```

### 3. é”™è¯¯å¤„ç†

**å¸¸è§é”™è¯¯ç **:
- `400`: è¯·æ±‚å‚æ•°é”™è¯¯
- `401`: è®¤è¯å¤±è´¥
- `404`: èµ„æºä¸å­˜åœ¨
- `500`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

**é‡è¯•ç­–ç•¥**:
```javascript
async function sendMessageWithRetry(messageData, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await sendMessage(messageData);
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      if (error.status === 500) {
        await delay(1000 * Math.pow(2, i)); // æŒ‡æ•°é€€é¿
        continue;
      }
      throw error;
    }
  }
}
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### Webhooké…ç½®

æ‚Ÿç©ºIMæ”¯æŒé€šè¿‡Webhookæ¨é€æ¶ˆæ¯äº‹ä»¶ï¼š

```yaml
webhook:
  grpcAddr: "localhost:6979"                    # gRPCåœ°å€
  httpAddr: "http://127.0.0.1:8080/webhooks"   # HTTPåœ°å€
  msgNotifyEventPushInterval: 500ms             # æ¨é€é—´éš”
  msgNotifyEventCountPerPush: 100               # æ¯æ¬¡æ¨é€æ•°é‡
  msgNotifyEventRetryMaxCount: 5                # æœ€å¤§é‡è¯•æ¬¡æ•°
  focusEvents:                                   # å…³æ³¨çš„äº‹ä»¶ç±»å‹
    - "msg.offline"                             # ç¦»çº¿æ¶ˆæ¯äº‹ä»¶
    - "msg.notify"                              # æ¶ˆæ¯é€šçŸ¥äº‹ä»¶
    - "user.onlinestatus"                       # ç”¨æˆ·åœ¨çº¿çŠ¶æ€å˜åŒ–äº‹ä»¶
```

### é›†ç¾¤é…ç½®

```yaml
cluster:
  nodeId: 1                                     # èŠ‚ç‚¹ID (0-1023)
  addr: "0.0.0.0:5100"                         # èŠ‚ç‚¹åœ°å€
  initNodes: ["0.0.0.0:5100"]                  # åˆå§‹èŠ‚ç‚¹åˆ—è¡¨
  slotCount: 1024                               # æ§½æ•°é‡
  slotReplicaCount: 1                           # æ§½å‰¯æœ¬æ•°é‡
  channelReplicaCount: 1                        # é¢‘é“å‰¯æœ¬æ•°é‡
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ‚Ÿç©ºIMå®˜æ–¹æ–‡æ¡£](https://github.com/WuKongIM/WuKongIM)
- [APIæ¥å£æ–‡æ¡£](http://localhost:5001/docs)
- [åè®®æ–‡æ¡£](docs/protocol.md)
- [éƒ¨ç½²æŒ‡å—](README.md)

---

## ğŸ†˜ æŠ€æœ¯æ”¯æŒ

å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–å¸®åŠ©ï¼š

1. **æŸ¥çœ‹æ—¥å¿—**: æ£€æŸ¥æœåŠ¡è¿è¡Œæ—¥å¿—
2. **APIæ–‡æ¡£**: è®¿é—® `http://localhost:5001/docs`
3. **å¥åº·æ£€æŸ¥**: è®¿é—® `http://localhost:5001/health`
4. **GitHub Issues**: æäº¤é—®é¢˜åˆ°å®˜æ–¹ä»“åº“

---

## ğŸ“ æ›´æ–°æ—¥å¿—

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å†…å®¹ |
|------|------|----------|
| 1.0.0 | 2025-08-18 | åˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰æ¶ˆæ¯æ¥å£ |
| 1.0.1 | 2025-08-18 | æ·»åŠ æœ€ä½³å®è·µå’Œé…ç½®è¯´æ˜ |
| 1.0.2 | 2025-08-18 | æ–°å¢ target_uid å­—æ®µï¼Œä¼˜åŒ–æ¶ˆæ¯æŸ¥è¯¢ä½“éªŒ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.2  
**æœ€åæ›´æ–°**: 2025-08-18  
**ç»´æŠ¤è€…**: æ‚Ÿç©ºIMå›¢é˜Ÿ 