# 会话内消息搜索接口文档

## 📋 接口概述

会话内消息搜索接口专门用于在私聊或群聊会话中搜索特定消息。该接口采用**两步式搜索**流程：
1. **批量搜索** → 返回消息列表
2. **单条锁定** → 定位到具体消息位置

## 🔗 接口信息

### 接口1：会话内消息搜索
- **接口路径**: `POST /v1/message/conversation/search`
- **请求方法**: `POST`
- **认证方式**: `Token Header`
- **内容类型**: `application/json`
- **接口描述**: 批量搜索会话内消息，返回消息列表

### 接口2：消息定位
- **接口路径**: `POST /v1/message/conversation/locate`
- **请求方法**: `POST`
- **认证方式**: `Token Header`
- **内容类型**: `application/json`
- **接口描述**: 定位具体消息，获取消息详情和位置信息

## 📥 请求参数

### 接口1：会话内消息搜索

#### 请求头
```
token: {token}
Content-Type: application/json
```

#### 请求体
```json
{
  "keyword": "搜索关键词",
  "channel_id": "会话ID",
  "channel_type": 1,
  "content_type": 0,
  "date_range": {
    "start_time": "2025-01-01 00:00:00",
    "end_time": "2025-12-31 23:59:59"
  },
  "pagination": {
    "page": 1,
    "page_size": 20
  },
  "sort": {
    "field": "time",
    "order": "desc"
  }
}
```

### 接口2：消息定位

#### 请求体
```json
{
  "message_id": "消息ID",
  "channel_id": "会话ID",
  "channel_type": 1
}
```

### 参数说明

#### 基础参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| keyword | string | 是 | 搜索关键词，支持中文、英文、数字 |
| channel_id | string | 是 | 会话ID（私聊时为对方用户ID，群聊时为群组编号） |
| channel_type | uint8 | 是 | 会话类型：1-私聊，2-群聊 |
| message_id | string | 是 | 消息ID（仅定位接口需要） |

#### 过滤参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| content_type | uint8 | 否 | 内容类型：0-全部，1-文本，2-图片，3-语音，4-视频，5-文件 |
| date_range.start_time | string | 否 | 搜索开始时间，格式：2025-01-01 00:00:00 |
| date_range.end_time | string | 否 | 搜索结束时间，格式：2025-01-01 00:00:00 |

#### 分页参数
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|---------|------|
| page | uint32 | 否 | 1 | 页码，从1开始 |
| page_size | uint32 | 否 | 20 | 每页数量，最大100 |

#### 排序参数
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|---------|------|
| field | string | 否 | time | 排序字段：time/relevance |
| order | string | 否 | desc | 排序方向：asc/desc |

## 📤 响应格式

### 接口1：会话内消息搜索 - 成功响应
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 45,
    "results": [
      {
        "message_id": "msg_123",
        "from_uid": "user_001",
        "from_name": "张三",
        "content": "这是一条包含关键词的消息内容...",
        "content_type": 1,
        "timestamp": "2025-08-17 22:30:00",
        "relevance_score": 0.95,
        "highlight": {
          "content": "这是一条包含<em>关键词</em>的消息内容..."
        },
        "is_read": true,
        "is_deleted": false,
        "is_revoked": false,
        "position": {
          "table_name": "message",
          "table_index": 0,
          "global_index": 15
        }
      }
    ]
  }
}
```

### 接口2：消息定位 - 成功响应
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "message": {
      "message_id": "msg_123",
      "from_uid": "user_001",
      "from_name": "张三",
      "content": "完整消息内容",
      "content_type": 1,
      "timestamp": "2025-08-17 22:30:00",
      "relevance_score": 1.0,
      "highlight": {
        "content": "完整消息内容"
      },
      "is_read": true,
      "is_deleted": false,
      "is_revoked": false,
      "position": {
        "table_name": "message",
        "table_index": 0,
        "global_index": 0
      }
    },
    "position": {
      "page": 3,
      "index": 15,
      "total_count": 150,
      "table_name": "message",
      "table_index": 0
    }
  }
}
```

### 错误响应
```json
{
  "code": 400,
  "message": "参数错误",
  "data": null
}
```

## 🔍 响应字段说明

### 搜索接口结果字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| total | int64 | 搜索结果总数 |
| results | array | 搜索结果数组 |

### 消息结果字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| message_id | string | 消息唯一ID |
| from_uid | string | 发送者UID |
| from_name | string | 发送者昵称 |
| content | string | 消息内容（截取片段） |
| content_type | uint8 | 内容类型：1-文本，2-图片，3-语音，4-视频，5-文件 |
| timestamp | string | 消息时间（格式：2025-01-01 00:00:00） |
| relevance_score | float64 | 相关度评分 (0-1) |
| highlight.content | string | 高亮显示的内容 |
| is_read | bool | 是否已读 |
| is_deleted | bool | 是否已删除 |
| is_revoked | bool | 是否已撤回 |
| position.table_name | string | 所在表名 |
| position.table_index | int | 在表中的索引 |
| position.global_index | int64 | 全局消息索引 |

### 定位接口位置字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| page | int | 所在页码（基于每页20条计算） |
| index | int | 在页面中的索引 |
| total_count | int64 | 会话总消息数 |
| table_name | string | 所在表名 |
| table_index | int | 在表中的索引 |

## 🚀 功能特性

### 1. 两步式搜索流程
- **第一步：批量搜索** - 获取符合条件的所有消息列表
- **第二步：单条锁定** - 根据消息ID定位到具体位置

### 2. 权限控制
- 验证用户是否有权限访问指定会话
- 私聊：检查是否是会话参与者
- 群聊：检查是否是群成员

### 3. 搜索能力
- 支持分表查询（message, message1, message2等）
- 关键词模糊匹配（payload和header字段）
- 内容类型过滤
- 时间范围过滤

### 4. 结果处理
- 智能相关度评分
- 关键词高亮显示
- 支持按时间或相关度排序
- 分页加载

### 5. 位置信息
- 提供消息在数据库中的位置信息
- 计算消息在会话中的页码和索引
- 支持前端精确定位和跳转

## 📝 使用示例

### 完整搜索流程示例

#### 步骤1：搜索消息列表
```json
POST /v1/message/conversation/search
{
  "keyword": "技术讨论",
  "channel_id": "user_123",
  "channel_type": 1,
  "content_type": 1,
  "pagination": {
    "page": 1,
    "page_size": 10
  }
}
```

#### 步骤2：定位具体消息
```json
POST /v1/message/conversation/locate
{
  "message_id": "msg_123",
  "channel_id": "user_123",
  "channel_type": 1
}
```

### 搜索私聊消息
```json
{
  "keyword": "技术讨论",
  "channel_id": "user_123",
  "channel_type": 1,
  "content_type": 1,
  "date_range": {
    "start_time": "2025-08-01 00:00:00",
    "end_time": "2025-08-17 23:59:59"
  },
  "pagination": {
    "page": 1,
    "page_size": 10
  },
  "sort": {
    "field": "time",
    "order": "desc"
  }
}
```

### 搜索群聊消息
```json
{
  "keyword": "会议安排",
  "channel_id": "group_456",
  "channel_type": 2,
  "content_type": 0,
  "pagination": {
    "page": 1,
    "page_size": 20
  },
  "sort": {
    "field": "relevance",
    "order": "desc"
  }
}
```

### 搜索图片消息
```json
{
  "keyword": "截图",
  "channel_id": "user_789",
  "channel_type": 1,
  "content_type": 2,
  "pagination": {
    "page": 1,
    "page_size": 15
  }
}
```

## 🔄 前端集成流程

### 1. 搜索阶段
1. 用户在会话界面输入关键词
2. 调用搜索接口获取消息列表
3. 在界面上显示搜索结果（支持高亮）

### 2. 定位阶段
1. 用户点击搜索结果中的某条消息
2. 调用定位接口获取消息详情和位置
3. 根据位置信息跳转到具体消息位置
4. 高亮显示定位到的消息

### 3. 用户体验优化
- 支持实时搜索（输入时即时搜索）
- 搜索结果缓存
- 平滑的跳转动画
- 消息高亮和聚焦效果

## ⚠️ 注意事项

1. **权限验证**: 只能搜索用户有权限访问的会话
2. **会话类型**: channel_type必须正确指定（1-私聊，2-群聊）
3. **结果限制**: 每页最大返回100条结果
4. **关键词长度**: 关键词长度建议在1-50个字符之间
5. **分表处理**: 自动遍历所有消息表进行搜索
6. **时间格式**: 时间格式必须为 "2025-01-01 00:00:00"
7. **两步流程**: 先搜索后定位，确保用户体验流畅

## 🔄 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0.0 | 2025-08-17 | 初始版本，支持会话内消息搜索 |
| 1.1.0 | 2025-08-17 | 增加消息定位接口，完善两步式搜索流程 |

## 🔗 相关接口

- [全局搜索接口](./全局搜索接口文档.md) - 跨会话的全局搜索
- [消息列表接口](./消息查看文档.md) - 获取会话消息列表
- [消息详情接口](./消息查看文档.md) - 获取消息详细信息 