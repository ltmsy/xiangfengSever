# 消息查看接口文档

## 概述

本文档描述了TangSengDaoDao系统中所有与消息查看相关的API接口，包括用户消息查询、群组消息查询、管理员消息查询等。

## 基础信息

- **基础URL**: `http://localhost:8090`
- **API版本**: `v1`
- **认证方式**: Token认证（在请求头中添加 `token: {token}`）
- **数据格式**: JSON

## 认证

所有接口都需要先登录获取token：

```bash
curl -X POST http://localhost:8090/v1/manager/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admiN123456"}'
```

## 接口列表

### 1. 查询指定用户的所有聊天记录（新增）

**接口地址**: `GET /v1/manager/message/recorduser`

**功能描述**: 查询指定用户的所有聊天记录，支持多种筛选条件

**请求参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `uid` | string | 是 | 用户ID | `4cd7c2783f7b46178f994f7d12729fff` |
| `direction` | string | 否 | 方向筛选：`send`(发送), `receive`(接收), `""`(全部) | `send` |
| `start_time` | string | 否 | 开始时间，格式：`YYYY-MM-DD HH:mm:ss` | `2025-08-17 15:00:00` |
| `end_time` | string | 否 | 结束时间，格式：`YYYY-MM-DD HH:mm:ss` | `2025-08-17 18:00:00` |
| `message_type` | string | 否 | 消息类型：`1`(文本), `2`(图片), `3`(语音) | `1` |
| `page` | int | 否 | 页码，默认1 | `1` |
| `page_size` | int | 否 | 每页数量，默认20 | `20` |

**请求示例**:

```bash
# 查询用户8888的所有消息
curl -s -H "token: $TOKEN" \
  "http://localhost:8090/v1/manager/message/recorduser?uid=4cd7c2783f7b46178f994f7d12729fff&page=1&page_size=20"

# 查询用户8888发送的消息
curl -s -H "token: $TOKEN" \
  "http://localhost:8090/v1/manager/message/recorduser?uid=4cd7c2783f7b46178f994f7d12729fff&direction=send&page=1&page_size=20"

# 查询用户8888接收的消息
curl -s -H "token: $TOKEN" \
  "http://localhost:8090/v1/manager/message/recorduser?uid=4cd7c2783f7b46178f994f7d12729fff&direction=receive&page=1&page_size=20"

# 查询用户8888的图片消息
curl -s -H "token: $TOKEN" \
  "http://localhost:8090/v1/manager/message/recorduser?uid=4cd7c2783f7b46178f994f7d12729fff&message_type=2&page=1&page_size=20"

# 查询用户8888在指定时间范围内的消息
curl -s -H "token: $TOKEN" \
  "http://localhost:8090/v1/manager/message/recorduser?uid=4cd7c2783f7b46178f994f7d12729fff&start_time=2025-08-17%2016:00:00&end_time=2025-08-17%2017:00:00&page=1&page_size=20"

# 组合筛选：时间范围 + 方向 + 消息类型
curl -s -H "token: $TOKEN" \
  "http://localhost:8090/v1/manager/message/recorduser?uid=4cd7c2783f7b46178f994f7d12729fff&start_time=2025-08-17%2016:00:00&end_time=2025-08-17%2017:00:00&direction=receive&message_type=1&page=1&page_size=20"
```

**响应示例**:

```json
{
  "count": 4,
  "list": [
    {
      "message_id": "1957012653087920128",
      "message_seq": 14,
      "sender": "5cf9fcbae2c241ce97eac0248e3024d6",
      "sender_name": "9999",
      "signal": 0,
      "payload": {
        "height": 435,
        "type": 2,
        "url": "file/preview/chat/1/4cd7c2783f7b46178f994f7d12729fff/B514244E22E6EA9DD66344A6FFEB1D32",
        "width": 297
      },
      "is_deleted": 0,
      "readed_count": 0,
      "revoke": 0,
      "device_db_id": 2,
      "device_id": "",
      "device_name": "",
      "device_model": "",
      "created_at": "2025-08-17 16:32:30",
      "edited_at": 0
    }
  ]
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `count` | int | 总消息数量 |
| `list` | array | 消息列表 |
| `message_id` | string | 消息ID |
| `message_seq` | int | 消息序列号 |
| `sender` | string | 发送者UID |
| `sender_name` | string | 发送者姓名 |
| `signal` | int | 信号标识 |
| `payload` | object | 消息内容（包含type字段标识消息类型） |
| `is_deleted` | int | 是否已删除 |
| `readed_count` | int | 已读数量 |
| `revoke` | int | 是否已撤回 |
| `device_db_id` | int | 设备数据库ID |
| `created_at` | string | 创建时间 |
| `edited_at` | int | 编辑时间 |

**筛选功能说明**:

1. **方向筛选** (`direction`)
   - `send`: 只返回用户发送的消息
   - `receive`: 只返回用户接收的消息
   - 不传或空字符串: 返回所有消息

2. **时间范围筛选** (`start_time`, `end_time`)
   - 支持 `YYYY-MM-DD HH:mm:ss` 格式
   - 使用本地时区
   - 消息时间必须在开始时间和结束时间之间

3. **消息类型筛选** (`message_type`)
   - `1`: 文本消息
   - `2`: 图片消息
   - `3`: 语音消息
   - 根据消息payload中的type字段进行筛选

4. **组合筛选**
   - 支持多个筛选条件同时使用
   - 所有条件都满足的消息才会被返回

### 2. 查询用户私聊记录

**接口地址**: `GET /v1/manager/message/recordpersonal`

**功能描述**: 查询指定用户的私聊记录

**请求参数**: 同 `recorduser` 接口

### 3. 查询管理员发送的消息

**接口地址**: `GET /v1/manager/message`

**功能描述**: 查询管理员发送的所有消息

**请求参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `page_index` | int | 否 | 页码，默认1 | `1` |
| `page_size` | int | 否 | 每页数量，默认15 | `15` |

### 4. 查询群组消息

**接口地址**: `GET /v1/manager/message/recordgroup`

**功能描述**: 查询指定群组的消息记录

**请求参数**:

| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| `group_id` | string | 是 | 群组ID | `group_123` |
| `page_index` | int | 否 | 页码，默认1 | `1` |
| `page_size` | int | 否 | 每页数量，默认15 | `15` |

## 消息类型说明

| 类型值 | 类型名称 | 说明 | payload示例 |
|--------|----------|------|-------------|
| `1` | 文本消息 | 普通文本内容 | `{"content": "你好", "type": 1}` |
| `2` | 图片消息 | 图片文件 | `{"type": 2, "url": "file/...", "width": 297, "height": 435}` |
| `3` | 语音消息 | 语音文件 | `{"type": 3, "url": "file/...", "duration": 5}` |
| `4` | 视频消息 | 视频文件 | `{"type": 4, "url": "file/...", "duration": 10}` |
| `5` | 文件消息 | 其他文件 | `{"type": 5, "url": "file/...", "filename": "document.pdf"}` |

## 使用建议

1. **性能优化**: 建议使用时间范围筛选，避免查询过大的数据量
2. **分页使用**: 对于大量数据，建议使用分页功能
3. **组合筛选**: 可以组合多个筛选条件，精确获取所需消息
4. **时间格式**: 时间参数使用URL编码，如空格编码为 `%20`

## 错误码说明

| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| `401` | 未授权 | 检查token是否有效 |
| `400` | 参数错误 | 检查必填参数是否完整 |
| `500` | 服务器错误 | 联系管理员或稍后重试 |

## 更新日志

- **2025-08-17**: 新增 `recorduser` 接口，支持方向、时间、类型等多维度筛选
- **2025-08-17**: 修复时间筛选时区问题
- **2025-08-17**: 修复消息类型筛选的json.Number类型支持
