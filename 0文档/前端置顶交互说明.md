# 前端置顶消息交互说明

## 📋 功能概述

置顶消息功能允许用户将重要消息固定在聊天界面顶部，方便快速查看和访问。支持个人聊天和群聊场景，具有权限控制和数量限制。

## 🏗️ 技术架构

### 后端接口
- **置顶消息**: `POST /v1/message/pinned`
- **同步置顶**: `POST /v1/message/pinned/sync`
- **清空置顶**: `POST /v1/message/pinned/clear`

### 数据同步
- 使用 `version` 字段进行增量同步
- 通过 `CMDSyncPinnedMessage` 命令实时推送
- 支持多端状态同步

## 🎨 UI界面设计

### 1. 置顶消息区域
- **位置**: 聊天界面顶部，消息列表上方
- **样式**: 卡片式设计，背景色区别于普通消息
- **标识**: 显示 📌 图标和"置顶消息"文字
- **布局**: 多条置顶消息叠层显示，新置顶消息盖在上一条上面

### 2. 置顶消息卡片
- **内容预览**: 显示消息前20-30个字符
- **类型标识**: 
  - 文本: 直接显示内容
  - 图片: 显示"图片"标识
  - 文件: 显示"文件"标识
  - 语音: 显示"语音消息"标识
- **时间显示**: 显示置顶时间
- **操作按钮**: 
  - 右侧 ❎ 按钮：取消置顶
  - 点击卡片主体：跳转原消息

### 3. 消息列表中的置顶标识
- **图标**: 在消息左侧显示 📌 图标
- **背景**: 置顶消息背景色高亮
- **边框**: 特殊边框样式区分

### 4. 置顶消息叠层显示
- **叠层效果**: 多条置顶消息以卡片叠层形式显示
- **层级关系**: 最新置顶的消息显示在最上层
- **视觉层次**: 上层消息遮挡下层消息，形成3D叠层效果
- **显示数量**: 最多显示3-4条叠层，超出部分通过"更多"按钮展开

### 5. 置顶消息循环定位逻辑
- **点击置顶消息卡片**: 自动定位到消息列表中的具体消息
- **定位完成后**: 自动显示下一条置顶消息（如果存在）
- **再次点击**: 继续定位到下一条置顶消息
- **循环机制**: 按置顶时间顺序循环显示所有置顶消息
- **定位反馈**: 定位过程中高亮显示目标消息，提供视觉反馈

## 🔄 交互流程

### 1. 置顶消息操作

#### 长按触发
- 用户右键
- 弹出操作菜单
- 显示"置顶消息"选项

#### 权限验证
- **个人聊天**: 所有用户都可以置顶
- **群聊**: 
  - 群主/管理员: 可以置顶
  - 普通成员: 根据 `AllowMemberPinnedMessage` 设置决定

#### 数量限制检查
- 每个频道最多10条置顶消息
- 达到上限时显示提示："置顶消息已达上限，请先取消部分置顶"

#### 确认置顶
- 显示确认弹窗
- 预览消息内容
- 确认/取消按钮

#### 置顶成功
- 显示Toast提示："消息已置顶"
- 消息立即出现在置顶区域最上层
- 原消息位置显示置顶标识
- 新置顶消息覆盖在之前的置顶消息上面，之前的 置顶消息被盖住不是删除。

### 2. 取消置顶操作

#### 操作方式
- 长按置顶消息卡片
- 选择"取消置顶"
- 或点击置顶消息的取消按钮
- 点击置顶消息卡片：定位到消息列表中的具体消息
- **取消置顶按钮**: 每条置顶消息卡片最右侧显示 ❎ 按钮

#### 取消成功
- 从置顶区域移除
- 原消息位置移除置顶标识
- 显示Toast提示："已取消置顶"

### 3. 清空置顶消息

#### 权限要求
- **个人聊天**: 用户本人可以清空
- **群聊**: 仅群主/管理员可以清空

#### 操作流程
- 在置顶区域显示"清空"按钮
- 点击后显示确认弹窗
- 确认后清空所有置顶消息

### 4. 置顶消息定位跳转

#### 点击定位逻辑
- **首次点击**: 定位到当前置顶消息在聊天记录中的位置
- **自动切换**: 定位完成后，置顶区域自动显示下一条置顶消息
- **循环显示**: 按置顶时间顺序循环显示所有置顶消息
- **定位反馈**: 目标消息高亮显示，聊天列表自动滚动到对应位置

#### 定位状态管理
- **当前显示**: 置顶区域显示当前可点击的置顶消息
- **历史记录**: 已定位过的置顶消息记录
- **循环结束**: 所有置顶消息都定位完成后，重新开始循环

## 📱 多端同步机制

### 1. 实时同步
- 收到 `CMDSyncPinnedMessage` 命令时
- 自动调用同步接口获取最新状态
- 更新本地置顶区域显示

### 2. 定时同步
- 每30秒自动同步一次
- 使用上次同步的version进行增量同步
- 确保数据一致性

### 3. 离线同步
- 用户重新上线后
- 自动同步离线期间的置顶变化
- 更新本地状态

## 🔔 置顶消息通知处理

### 1. 通知类型识别

#### CMD命令通知
- **触发时机**: 收到 `CMDSyncPinnedMessage` 命令
- **处理方式**: 自动调用同步接口，无需用户操作
- **显示效果**: 置顶区域自动更新，无额外提示

#### 系统消息通知
- **触发时机**: 收到置顶相关的系统提示消息
- **消息内容**: "xxx 置顶了消息内容"
- **显示效果**: 在聊天界面显示，带红点提醒

### 2. 前端通知处理流程

#### 收到CMD通知后
1. **自动触发**: 无需用户确认，自动处理
2. **调用同步**: 自动调用 `/v1/message/pinned/sync` 接口
3. **更新状态**: 获取最新置顶消息状态
4. **刷新UI**: 更新置顶区域显示
5. **无感体验**: 用户无需手动操作

#### 收到系统消息后
1. **显示通知**: 在聊天界面显示系统提示消息
2. **红点提醒**: 显示红点，提醒用户查看
3. **用户操作**: 用户点击查看置顶消息
4. **引导体验**: 引导用户了解置顶变化

### 3. 通知内容智能展示

#### 文本消息置顶
- **显示格式**: "张三 置顶了`消息内容`"
- **内容处理**: 用反引号包围文本内容
- **长度限制**: 超长内容自动截断，显示省略号

#### 其他类型消息置顶
- **图片消息**: "张三 置顶了图片"
- **文件消息**: "张三 置顶了文件"
- **语音消息**: "张三 置顶了语音消息"
- **视频消息**: "张三 置顶了视频"

### 4. 通知状态管理

#### 通知生命周期
1. **接收阶段**: 实时接收CMD和系统消息
2. **处理阶段**: 自动同步或用户确认
3. **展示阶段**: 更新UI和显示提示
4. **清理阶段**: 清理过期通知状态

#### 通知优先级
1. **高优先级**: CMD命令通知（实时处理）
2. **中优先级**: 系统消息通知（用户确认）
3. **低优先级**: 定时同步（后台处理）

### 5. 用户交互响应

#### 置顶成功反馈
- **Toast提示**: 显示"消息已置顶"
- **置顶区域**: 消息立即出现在置顶区域
- **原消息**: 显示置顶标识
- **动画效果**: 平滑的置顶动画

#### 置顶失败处理
- **错误提示**: 显示具体错误原因
- **重试机制**: 提供重试按钮
- **状态回滚**: 本地状态回滚到操作前

#### 权限不足提示
- **按钮置灰**: 置顶按钮禁用
- **提示信息**: 显示权限说明
- **引导操作**: 引导用户联系管理员

### 6. 多端通知同步

#### 实时同步策略
- **主设备**: 优先处理，立即响应
- **其他设备**: 延迟处理，确保一致性
- **冲突处理**: 以最新操作为准

#### 离线通知处理
- **本地缓存**: 缓存离线期间的置顶操作
- **上线同步**: 重新上线后批量同步
- **状态恢复**: 恢复离线期间的所有状态

### 7. 通知性能优化

#### 批量处理
- **合并通知**: 短时间内多次置顶合并处理
- **延迟更新**: 避免频繁UI刷新
- **智能去重**: 去除重复通知

#### 缓存策略
- **本地缓存**: 缓存置顶消息状态
- **增量更新**: 只同步变化部分
- **预加载**: 预加载可能需要的置顶消息

### 8. 通知用户体验

#### 视觉反馈
- **动画效果**: 平滑的置顶/取消置顶动画
- **状态变化**: 明显的置顶状态标识
- **进度指示**: 操作进度和状态指示

#### 操作引导
- **新手引导**: 首次使用时的操作说明
- **快捷操作**: 提供置顶相关的快捷方式
- **帮助提示**: 内置帮助和说明文档

#### 个性化设置
- **通知开关**: 用户可控制通知类型
- **提醒方式**: 自定义提醒方式和频率
- **显示偏好**: 自定义置顶消息显示样式

## 🎯 状态管理

### 1. 置顶状态
- `is_pinned`: 0=未置顶，1=已置顶
- `is_deleted`: 0=正常，1=已删除（取消置顶）

### 2. 版本控制
- `version`: 时间戳，用于增量同步
- 每次状态变更都会更新version

### 3. 权限状态
- 根据用户角色和群设置动态控制
- 权限变更时实时更新UI状态

## 🚫 异常处理

### 1. 网络异常
- 置顶操作失败时显示错误提示
- 提供重试按钮
- 本地状态回滚

### 2. 权限异常
- 权限不足时按钮置灰
- 显示权限说明
- 引导用户联系管理员

### 3. 数量限制
- 达到上限时禁用置顶功能
- 显示数量限制提示
- 建议用户先取消部分置顶

## 🎨 动画效果

### 1. 置顶动画
- 消息从原位置滑入置顶区域
- 使用弹性动画效果
- 透明度渐变变化

### 2. 取消置顶动画
- 从置顶区域滑出
- 平滑的消失效果
- 原位置恢复动画

### 3. 状态切换动画
- 按钮图标动态变化
- 颜色状态切换
- 触觉反馈（震动）

## 📱 响应式适配

### 1. 移动端
- 触摸友好的按钮大小
- 手势操作支持
- 适配不同屏幕尺寸

### 2. 桌面端
- 鼠标悬停效果
- 键盘快捷键支持
- 右键菜单操作

### 3. 平板端
- 触摸和鼠标双重支持
- 横竖屏适配
- 分屏模式支持

## 🔧 配置选项

### 1. 用户偏好
- 置顶消息显示数量
- 自动同步频率
- 动画效果开关

### 2. 群组设置
- 是否允许普通成员置顶
- 置顶消息数量限制
- 置顶权限管理

## 📊 数据统计

### 1. 使用统计
- 置顶消息数量
- 置顶操作频率
- 用户偏好分析

### 2. 性能监控
- 同步接口响应时间
- 数据一致性检查
- 异常情况统计

## 🚀 未来优化

### 1. 功能增强
- 置顶消息分类
- 置顶消息搜索
- 置顶消息分享

### 2. 性能优化
- 智能同步策略
- 缓存机制优化
- 离线支持增强

### 3. 用户体验
- 个性化设置
- 智能推荐
- 操作引导优化
