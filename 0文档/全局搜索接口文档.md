# 全局搜索接口文档

## 📋 接口概述

全局搜索接口提供跨模块的统一搜索能力，支持搜索聊天内容、用户、群组和应用。该接口采用分类型搜索策略，支持多种过滤条件和排序方式。

## 🔗 接口信息

- **接口路径**: `POST /v1/message/global`
- **请求方法**: `POST`
- **认证方式**: `Token Header`
- **内容类型**: `application/json`
- **接口描述**: 全局搜索接口，支持多类型内容搜索

## 📥 请求参数

### 请求头
```
token: {token}
Content-Type: application/json
```

### 请求体
```json
{
  "keyword": "搜索关键词",
  "search_types": ["chat", "user", "group", "app"],
  "filters": {
    "channel_id": "限定频道ID（可选）",
    "channel_type": "频道类型（可选）",
    "content_type": "内容类型（可选）",
    "date_range": {
      "start_time": "2025-01-01 00:00:00",
      "end_time": "2025-12-31 23:59:59"
    },
    "file_types": ["image", "document", "video", "audio"]
  },
  "pagination": {
    "page": 1,
    "page_size": 20
  },
  "sort": {
    "field": "relevance",
    "order": "desc"
  }
}
```

### 参数说明

#### 基础参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| keyword | string | 是 | 搜索关键词，支持中文、英文、数字 |
| search_types | array | 是 | 搜索类型数组，支持：chat/user/group/app |

#### 过滤参数 (filters)
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| channel_id | string | 否 | 限定搜索的频道ID |
| channel_type | uint8 | 否 | 频道类型：1-个人，2-群组 |
| content_type | uint8 | 否 | 内容类型：1-文本，2-图片，3-语音，4-视频，5-文件 |
| date_range.start_time | string | 否 | 搜索开始时间，格式：2025-01-01 00:00:00 |
| date_range.end_time | string | 否 | 搜索结束时间，格式：2025-01-01 00:00:00 |
| file_types | array | 否 | 文件类型过滤：image/document/video/audio |

#### 分页参数 (pagination)
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|---------|------|
| page | uint32 | 否 | 1 | 页码，从1开始 |
| page_size | uint32 | 否 | 20 | 每页数量，最大100 |

#### 排序参数 (sort)
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|---------|------|
| field | string | 否 | relevance | 排序字段：relevance/time/name |
| order | string | 否 | desc | 排序方向：asc/desc |

## 📤 响应格式

### 成功响应
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 150,
    "results": {
      "chat": {
        "total": 45,
        "items": [
          {
            "type": "chat",
            "message_id": "msg_123",
            "channel_id": "channel_001",
            "channel_type": 1,
            "from_uid": "user_001",
            "from_name": "张三",
            "content": "这是一条包含关键词的消息内容...",
            "content_type": 1,
            "timestamp": "2025-08-17 22:30:00",
            "relevance_score": 0.95,
            "highlight": {
              "content": "这是一条包含<em>关键词</em>的消息内容..."
            }
          }
        ]
      },
      "user": {
        "total": 12,
        "items": [
          {
            "type": "user",
            "uid": "user_002",
            "name": "李四",
            "username": "lisi",
            "short_no": "ABC123",
            "avatar": "avatar_url",
            "relevance_score": 0.88,
            "highlight": {
              "name": "<em>李</em>四"
            }
          }
        ]
      },
      "group": {
        "total": 8,
        "items": [
          {
            "type": "group",
            "group_no": "group_001",
            "name": "技术交流群",
            "description": "讨论技术问题的群组",
            "member_count": 150,
            "relevance_score": 0.82,
            "highlight": {
              "name": "技术交流<em>群</em>"
            }
          }
        ]
      },
      "app": {
        "total": 25,
        "items": [
          {
            "type": "app",
            "app_id": "app_001",
            "name": "技术文档",
            "description": "技术文档管理应用",
            "icon": "icon_url",
            "relevance_score": 0.78,
            "highlight": {
              "name": "技术<em>文档</em>"
            }
          }
        ]
      }
    }
  }
}
```

### 错误响应
```json
{
  "code": 400,
  "message": "参数错误",
  "data": null
}
```

## 🔍 搜索结果字段说明

### 聊天消息 (chat)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| type | string | 固定值："chat" |
| message_id | string | 消息唯一ID |
| channel_id | string | 频道ID |
| channel_type | uint8 | 频道类型：1-个人，2-群组 |
| from_uid | string | 发送者UID |
| from_name | string | 发送者昵称 |
| content | string | 消息内容（截取片段） |
| content_type | uint8 | 内容类型：1-文本，2-图片，3-语音，4-视频，5-文件 |
| timestamp | string | 消息时间（格式：2025-01-01 00:00:00） |
| relevance_score | float64 | 相关度评分 (0-1) |
| highlight.content | string | 高亮显示的内容 |

### 用户 (user)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| type | string | 固定值："user" |
| uid | string | 用户UID |
| name | string | 用户昵称 |
| username | string | 用户名（zone+phone格式） |
| short_no | string | 短编号 |
| avatar | string | 头像URL（暂时为空） |
| relevance_score | float64 | 相关度评分 (0-1) |
| highlight.name | string | 高亮显示的昵称 |

### 群组 (group)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| type | string | 固定值："group" |
| group_no | string | 群组编号 |
| name | string | 群组名称 |
| description | string | 群组描述（notice字段） |
| member_count | uint32 | 成员数量 |
| relevance_score | float64 | 相关度评分 (0-1) |
| highlight.name | string | 高亮显示的群组名 |

### 应用 (app)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| type | string | 固定值："app" |
| app_id | string | 应用ID |
| name | string | 应用名称 |
| description | string | 应用描述 |
| icon | string | 应用图标URL |
| relevance_score | float64 | 相关度评分 (0-1) |
| highlight.name | string | 高亮显示的应用名 |

## 🚀 实现方案

### 1. 架构设计
```
客户端 → API网关 → 消息模块 → 本地数据库查询
```

### 2. 搜索策略
- **聊天内容**: 直接查询本地数据库，支持分表查询（message, message1, message2等）
- **用户**: 数据库模糊查询（姓名、用户名、短编号、手机号）
- **群组**: 数据库模糊查询（名称、编号、分类）+ 成员数统计
- **应用**: 数据库模糊查询（名称、描述、分类）

### 3. 性能优化
- 并发搜索处理
- 智能相关度评分
- 分页加载
- 关键词高亮

### 4. 安全考虑
- 用户权限验证（token认证）
- 搜索结果权限过滤
- 敏感信息过滤

## 📝 使用示例

### 搜索聊天内容
```json
{
  "keyword": "技术讨论",
  "search_types": ["chat"],
  "filters": {
    "content_type": 1,
    "date_range": {
      "start_time": "2025-08-01 00:00:00",
      "end_time": "2025-08-17 23:59:59"
    }
  },
  "pagination": {
    "page": 1,
    "page_size": 10
  }
}
```

### 搜索用户
```json
{
  "keyword": "张三",
  "search_types": ["user"],
  "pagination": {
    "page": 1,
    "page_size": 20
  }
}
```

### 搜索群组
```json
{
  "keyword": "技术交流",
  "search_types": ["group"],
  "pagination": {
    "page": 1,
    "page_size": 15
  }
}
```

### 搜索应用
```json
{
  "keyword": "文档管理",
  "search_types": ["app"],
  "pagination": {
    "page": 1,
    "page_size": 10
  }
}
```

### 全局搜索
```json
{
  "keyword": "技术",
  "search_types": ["chat", "user", "group", "app"],
  "pagination": {
    "page": 1,
    "page_size": 20
  },
  "sort": {
    "field": "relevance",
    "order": "desc"
  }
}
```

## ⚠️ 注意事项

1. **搜索权限**: 只能搜索用户有权限访问的内容
2. **结果限制**: 每页最大返回100条结果
3. **关键词长度**: 关键词长度建议在1-50个字符之间
4. **搜索频率**: 建议限制搜索频率，避免过度消耗资源
5. **分表处理**: 聊天消息支持分表查询，自动遍历所有消息表
6. **相关度算法**: 使用智能评分算法，支持前缀匹配和内容匹配

## 🔄 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0.0 | 2025-08-17 | 初始版本，支持基础搜索功能 |
| 1.1.0 | 2025-08-17 | 完善本地数据库查询，支持分表、相关度评分、关键词高亮 |
