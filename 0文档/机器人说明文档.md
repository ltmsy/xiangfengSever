# 机器人功能说明文档

## 📋 目录

- [概述](#概述)
- [功能特性](#功能特性)
- [系统机器人](#系统机器人)
- [使用方法](#使用方法)
- [技术架构](#技术架构)
- [接口说明](#接口说明)
- [配置说明](#配置说明)
- [开发指南](#开发指南)
- [常见问题](#常见问题)
- [更新日志](#更新日志)

---

## 概述

TangSengDaoDao项目中的机器人是一个**智能客服和自动化服务系统**，类似于微信的公众号机器人。机器人能够自动响应用户的咨询、提供系统帮助信息、支持行内搜索功能，并处理各种用户命令和查询。

**主要用途**：
- 新用户引导和帮助
- 系统功能说明
- 常见问题自动回复
- 内容搜索和推荐
- 客服支持

---

## 功能特性

### ✅ **核心功能**

#### **1. 自动回复系统**
- **命令识别**: 自动识别用户发送的命令
- **智能回复**: 根据命令返回相应的帮助信息
- **多语言支持**: 支持中文命令和回复

#### **2. 消息处理**
- **实时监听**: 监听用户发送的消息
- **自动触发**: 多种方式触发机器人响应
- **消息存储**: 支持消息的存储和过期清理

#### **3. 行内搜索**
- **Inline Query**: 支持机器人的行内搜索
- **多类型结果**: 返回GIF、文章等多种类型
- **分页加载**: 支持分页获取更多结果

#### **4. 权限管理**
- **身份验证**: 基于AppKey的身份验证
- **频道控制**: 控制机器人可发送消息的频道
- **状态管理**: 支持启用/禁用机器人

### 🔧 **高级功能**

#### **1. 消息发送**
- **主动发送**: 机器人可以主动发送消息
- **消息类型**: 支持文本、图片等多种类型
- **流式消息**: 支持流式消息的开始和结束

#### **2. 状态显示**
- **Typing状态**: 显示"正在输入"状态
- **在线状态**: 实时显示机器人在线状态

#### **3. 菜单管理**
- **自定义菜单**: 支持自定义机器人命令菜单
- **菜单同步**: 客户端可同步机器人菜单信息

---

## 系统机器人

### 🎯 **内置命令列表**

TangSengDaoDao系统内置了完整的系统机器人，支持以下命令：

| 命令 | 说明 | 回复内容 |
|------|------|----------|
| `/基本信息` | 唐僧叨叨基本信息 | 系统介绍、官网链接、演示地址等 |
| `/添加好友` | 如何添加好友 | 详细的操作步骤说明 |
| `/加群` | 如何创建群聊 | 群聊创建的操作指南 |
| `/添加表情` | 如何添加表情包 | 表情包添加和制作方法 |
| `/搜索GIF` | 聊天中发送GIF | GIF搜索和发送教程 |
| `/Android包下载` | 下载Android应用 | 应用下载地址 |
| `/未知消息` | 未知消息处理 | 升级客户端建议 |
| `/电脑端登录` | PC/Web登录 | 电脑端登录方法 |
| `/举报` | 举报用户或群 | 投诉举报操作指南 |

### 🌟 **命令示例**

#### **使用 `/基本信息` 命令**
```
用户发送: /基本信息
机器人回复: 唐僧叨叨是一款轻量级，高性能，重安全专注于私有化部署的开源即时通讯系统。唐僧叨叨官网：https://www.tsdaodao.com 各端演示地址：https://tsdaodao.com/guide/demo.html 悟空官网：https://githubim.com 在APP我的-设置-模块管理中关闭所有模块即是开源版本所有功能。
```

#### **使用 `/添加好友` 命令**
```
用户发送: /添加好友
机器人回复: 您好，点击右上角【+】，选择【添加好友】-- 点击搜索 -- 输入用户的手机号、短号（任意一个添加即可）进行好友添加查找
```

---

## 使用方法

### 🔍 **触发方式**

#### **1. 命令触发**
直接在聊天中输入命令即可：
```
/基本信息
/添加好友
/加群
```

#### **2. @机器人**
在消息中@机器人用户名：
```
@system 你好
@机器人用户名 帮助
```

#### **3. 直接私聊**
直接给机器人发送私聊消息，机器人会自动处理并回复。

#### **4. 群聊触发**
在群聊中@机器人，机器人会响应群聊中的命令。

### 📱 **客户端操作**

#### **添加机器人好友**
1. 在好友列表中添加系统机器人
2. 机器人用户名通常是系统预设的
3. 添加后即可使用机器人功能

#### **使用机器人功能**
1. 在聊天界面输入命令
2. 机器人自动识别并回复
3. 支持连续对话和多次查询

---

## 技术架构

### 🏗️ **系统架构**

```
用户消息 → 消息监听器 → 机器人识别器 → 机器人处理器 → 回复生成器 → 消息发送器
    ↓              ↓              ↓              ↓              ↓              ↓
  消息队列     事件处理     命令解析     业务逻辑     内容生成     消息投递
```

### 🔧 **核心组件**

#### **1. 消息监听器 (MessageListener)**
- 监听所有用户消息
- 识别机器人相关的消息
- 触发机器人处理流程

#### **2. 机器人识别器 (RobotIdentifier)**
- 识别消息中的机器人ID
- 支持多种识别方式
- 验证机器人有效性

#### **3. 命令处理器 (CommandProcessor)**
- 解析用户命令
- 匹配预设回复内容
- 生成回复消息

#### **4. 消息管理器 (MessageManager)**
- 管理机器人消息队列
- 处理消息过期清理
- 支持消息确认机制

### 💾 **数据存储**

#### **Redis存储**
- 机器人事件队列
- 消息过期时间管理
- 临时数据缓存

#### **MySQL存储**
- 机器人基本信息
- 机器人菜单配置
- 系统配置参数

---

## 接口说明

### 🔌 **API接口列表**

#### **1. 机器人同步**
- **接口**: `POST /v1/robot/sync`
- **功能**: 同步机器人菜单和配置信息
- **权限**: 需要用户登录

#### **2. 行内搜索**
- **接口**: `POST /v1/robot/inline_query`
- **功能**: 机器人行内搜索功能
- **权限**: 需要用户登录

#### **3. 获取事件**
- **接口**: `GET /v1/robots/:robot_id/:app_key/events`
- **功能**: 获取机器人事件列表
- **权限**: 机器人身份验证

#### **4. 发送消息**
- **接口**: `POST /v1/robots/:robot_id/:app_key/sendMessage`
- **功能**: 机器人发送消息
- **权限**: 机器人身份验证

#### **5. 输入状态**
- **接口**: `POST /v1/robots/:robot_id/:app_key/typing`
- **功能**: 显示机器人输入状态
- **权限**: 机器人身份验证

#### **6. 流式消息**
- **接口**: `POST /v1/robots/:robot_id/:app_key/stream/start`
- **接口**: `POST /v1/robots/:robot_id/:app_key/stream/end`
- **功能**: 流式消息控制
- **权限**: 机器人身份验证

### 📊 **请求参数示例**

#### **机器人同步请求**
```json
[
  {
    "robot_id": "u_10000",
    "version": 0,
    "username": "system"
  }
]
```

#### **行内搜索请求**
```json
{
  "offset": "",
  "query": "天气",
  "username": "weather_bot",
  "channel_id": "channel_123",
  "channel_type": 1
}
```

#### **发送消息请求**
```json
{
  "setting": 0,
  "channel_id": "channel_123",
  "channel_type": 1,
  "stream_no": "stream_456",
  "payload": {
    "type": 1,
    "content": "你好，我是机器人！"
  }
}
```

---

## 配置说明

### ⚙️ **系统配置**

#### **机器人配置项**
```yaml
robot:
  messageExpire: 7d          # 机器人消息过期时间
  inlineQueryTimeout: 10s    # 行内搜索超时时间
  eventPoolSize: 100         # 事件池大小
```

#### **账户配置**
```yaml
account:
  systemUID: "u_10000"       # 系统机器人UID
  fileHelperUID: "fileHelper" # 文件助手UID
```

### 🔐 **权限配置**

#### **机器人状态**
- **启用 (Enable)**: 状态值为1，机器人正常工作
- **禁用 (Disable)**: 状态值为0，机器人停止工作

#### **行内搜索开关**
- **开启**: `inlineOn = 1`，支持行内搜索功能
- **关闭**: `inlineOn = 0`，禁用行内搜索功能

#### **频道权限控制**
- **私聊**: 机器人可以向用户发送私聊消息
- **群聊**: 机器人可以向群聊发送消息（需要权限验证）

---

## 开发指南

### 🛠️ **自定义机器人开发**

#### **1. 创建机器人**
```go
// 创建机器人实例
robot := &robot{
    RobotID:     "custom_robot_001",
    Username:    "custom_bot",
    InlineOn:    1,
    Placeholder: "请输入搜索关键词",
    Status:      1,
    Version:     1,
}
```

#### **2. 添加机器人菜单**
```go
// 添加命令菜单
menu := &menu{
    RobotID: "custom_robot_001",
    CMD:     "/自定义命令",
    Remark:  "自定义命令说明",
    Type:    "none",
}
```

#### **3. 处理机器人事件**
```go
// 监听机器人消息
func (rb *Robot) handleCustomRobot(message *config.MessageResp) {
    // 自定义处理逻辑
    // 解析命令、生成回复等
}
```

### 📝 **开发注意事项**

#### **1. 消息类型支持**
目前机器人主要支持文本消息类型：
```go
func (rb *Robot) supportContentType(contentType common.ContentType) bool {
    return contentType == common.Text
}
```

#### **2. 权限验证**
机器人发送消息需要验证频道权限：
```go
func (rb *Robot) allowSendToChannel(channelID string, channelType uint8) bool {
    // TODO：完善权限控制逻辑
    return true
}
```

#### **3. 错误处理**
确保机器人操作的错误处理：
```go
if err != nil {
    rb.Error("操作失败", zap.Error(err))
    // 返回友好的错误信息
}
```

---

## 常见问题

### ❓ **FAQ**

#### **Q: 机器人不响应怎么办？**
A: 检查以下几点：
1. 确认机器人状态为启用状态
2. 检查机器人是否正确添加为好友
3. 验证命令格式是否正确
4. 查看系统日志是否有错误信息

#### **Q: 如何添加自定义机器人？**
A: 需要以下步骤：
1. 在数据库中创建机器人记录
2. 配置机器人菜单和命令
3. 实现自定义处理逻辑
4. 测试机器人功能

#### **Q: 机器人消息过期时间如何设置？**
A: 在配置文件中设置：
```yaml
robot:
  messageExpire: 7d  # 7天过期
```

#### **Q: 支持哪些消息类型？**
A: 目前主要支持：
- 文本消息 (type: 1)
- 基础消息类型
- 其他类型需要扩展支持

#### **Q: 如何实现AI对话功能？**
A: 需要集成第三方AI服务：
1. 接入ChatGPT、文心一言等AI服务
2. 实现消息转发和处理
3. 添加对话上下文管理
4. 实现流式回复

---

## 更新日志

### 📅 **版本更新记录**

- **2025-08-17**: 创建机器人功能说明文档
- **2025-08-17**: 完善功能特性和使用方法
- **2025-08-17**: 添加技术架构和开发指南
- **2025-08-17**: 补充常见问题和解决方案

### 🔄 **功能演进**

#### **当前版本功能**
- ✅ 系统机器人完整功能
- ✅ 基础命令处理
- ✅ 行内搜索支持
- ✅ 消息发送和接收

#### **未来规划功能**
- 🚧 AI智能对话
- 🚧 多语言支持
- 🚧 高级权限控制
- 🚧 机器人插件系统

---

## 🔝 [返回顶部](#机器人功能说明文档)
