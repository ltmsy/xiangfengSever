# 后台管理配置接口文档

## 📋 概述

本文档描述了后台管理系统的配置管理相关接口，支持按分类管理各种系统配置，为前端提供tab切换式的配置管理界面。

## 🔐 权限要求

- 所有管理接口需要超级管理员权限
- 公开配置接口无需权限验证
- 使用JWT Bearer Token认证

## 🌐 基础信息

- **基础URL**: `/v1/manager`
- **认证方式**: Bearer Token
- **数据格式**: JSON
- **字符编码**: UTF-8

## 📚 配置分类

系统预定义了以下配置分类：

| 分类键 | 分类名称 | 说明 |
|--------|----------|------|
| `group` | 群组配置 | 群组相关功能配置 |
| `system` | 系统配置 | 系统基础配置 |
| `security` | 安全配置 | 安全相关配置 |
| `notification` | 通知配置 | 通知相关配置 |
| `ui` | 界面配置 | 用户界面相关配置 |
| `message` | 消息配置 | 消息功能相关配置 |
| `file` | 文件配置 | 文件管理相关配置 |
| `robot` | 机器人配置 | 机器人功能相关配置 |
| `statistics` | 统计配置 | 统计功能相关配置 |



## 🔌 API接口详情

### 1. 获取配置分类列表

**接口地址**: `GET /config/categories`

**接口描述**: 获取所有配置分类信息，用于前端tab切换

**请求参数**: 无

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "category": "group",
      "category_name": "群组配置",
      "count": 8
    },
    {
      "category": "system",
      "category_name": "系统配置",
      "count": 8
    }
  ]
}
```

**响应字段说明**:
- `category`: 配置分类键
- `category_name`: 配置分类显示名称
- `count`: 该分类下的配置项数量

---

### 2. 获取所有配置（按分类分组）

**接口地址**: `GET /config/list`

**接口描述**: 获取所有配置项，按分类分组返回，用于前端tab页面展示

**请求参数**: 无

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "category": "group",
      "category_name": "群组配置",
      "configs": [
        {
          "id": 1,
          "config_key": "group.notify_member_join",
          "config_value": "1",
          "config_type": "boolean",
          "description": "群成员加入时是否通知其他成员",
          "category": "group",
          "is_editable": 1,
          "is_public": 1,
          "sort_order": 100,
          "version": 1,
          "created_at": "2025-01-17 23:22:43",
          "updated_at": "2025-01-17 23:22:43",
          "created_by": "system",
          "updated_by": "system"
        }
      ]
    }
  ]
}
```

---

### 3. 根据分类获取配置

**接口地址**: `GET /config/category/{category}`

**接口描述**: 根据指定分类获取该分类下的所有配置项

**路径参数**:
- `category`: 配置分类（必填）

**支持的分类值**: `group`, `system`, `security`, `notification`, `ui`, `message`, `file`, `robot`, `statistics`

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "category": "group",
    "category_name": "群组配置",
    "configs": [
      {
        "id": 1,
        "config_key": "group.notify_member_join",
        "config_value": "1",
        "config_type": "boolean",
        "description": "群成员加入时是否通知其他成员",
        "is_editable": 1,
        "is_public": 1
      }
    ]
  }
}
```

---

### 4. 更新单个配置

**接口地址**: `PUT /config/update`

**接口描述**: 更新指定配置项的值

**请求参数**:
```json
{
  "config_key": "group.notify_member_join",
  "config_value": "0"
}
```

**请求字段说明**:
- `config_key`: 配置键（必填）
- `config_value`: 配置值（必填）

**响应示例**:
```json
{
  "code": 200,
  "message": "success"
}
```

**注意事项**:
- 只能更新 `is_editable = 1` 的配置项
- 配置值会根据配置类型进行验证
- 更新后版本号会自动递增

---

### 5. 批量更新配置

**接口地址**: `PUT /config/batch-update`

**接口描述**: 批量更新多个配置项的值

**请求参数**:
```json
{
  "configs": [
    {
      "config_key": "group.notify_member_join",
      "config_value": "1"
    },
    {
      "config_key": "group.notify_member_leave",
      "config_value": "1"
    }
  ]
}
```

**请求字段说明**:
- `configs`: 配置项数组（必填，至少1项）
  - `config_key`: 配置键（必填）
  - `config_value`: 配置值（必填）

**响应示例**:
```json
{
  "code": 200,
  "message": "success"
}
```

**注意事项**:
- 使用数据库事务确保批量更新的一致性
- 所有配置项必须存在且可编辑
- 配置值会进行类型验证

---

### 6. 搜索配置

**接口地址**: `POST /config/search`

**接口描述**: 根据关键词和分类搜索配置项

**请求参数**:
```json
{
  "keyword": "群组",
  "category": "group",
  "page": 1,
  "page_size": 20
}
```

**请求字段说明**:
- `keyword`: 搜索关键词（可选）
- `category`: 配置分类（可选）
- `page`: 页码（必填，最小1）
- `page_size`: 每页数量（必填，1-100）

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "configs": [
      {
        "id": 1,
        "config_key": "group.notify_member_join",
        "config_value": "1",
        "config_type": "boolean",
        "description": "群成员加入时是否通知其他成员"
      }
    ],
    "total": 1,
    "page": 1,
    "page_size": 20
  }
}
```

---

### 7. 新增配置项

**接口地址**: `POST /config/create`

**接口描述**: 创建新的配置项

**请求参数**:
```json
{
  "config_key": "system.new_feature",
  "config_value": "1",
  "config_type": "boolean",
  "description": "新功能开关",
  "category": "system",
  "is_editable": 1,
  "is_public": 0,
  "sort_order": 250
}
```

**请求字段说明**:
- `config_key`: 配置键（必填，全局唯一）
- `config_value`: 配置值（必填）
- `config_type`: 配置类型（必填，支持：string、number、boolean、json、image）
- `description`: 配置描述（必填）
- `category`: 配置分类（必填）
- `is_editable`: 是否可编辑（可选，默认1）
- `is_public`: 是否公开（可选，默认0）
- `sort_order`: 排序顺序（可选，默认0）

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 25,
    "config_key": "system.new_feature",
    "config_value": "1",
    "config_type": "boolean",
    "description": "新功能开关",
    "category": "system",
    "is_editable": 1,
    "is_public": 0,
    "sort_order": 250,
    "version": 1,
    "created_at": "2025-01-20 10:00:00",
    "updated_at": "2025-01-20 10:00:00",
    "created_by": "admin",
    "updated_by": "admin"
  }
}
```

**注意事项**:
- 配置键必须全局唯一
- 配置值会根据配置类型进行验证
- 创建者信息会自动记录

---

### 8. 删除配置项

**接口地址**: `DELETE /config/delete/{config_key}`

**接口描述**: 删除指定的配置项

**路径参数**:
- `config_key`: 配置键（必填）

**响应示例**:
```json
{
  "code": 200,
  "message": "success"
}
```

**注意事项**:
- 删除操作不可恢复
- 只能删除 `is_editable = 1` 的配置项
- 系统核心配置不允许删除

---

### 9. 批量删除配置项

**接口地址**: `DELETE /config/batch-delete`

**接口描述**: 批量删除多个配置项

**请求参数**:
```json
{
  "config_keys": [
    "system.temp_config1",
    "system.temp_config2"
  ]
}
```

**请求字段说明**:
- `config_keys`: 要删除的配置键数组（必填，至少1项）

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "deleted_count": 2,
    "failed_keys": []
  }
}
```

**响应字段说明**:
- `deleted_count`: 成功删除的配置项数量
- `failed_keys`: 删除失败的配置键列表

**注意事项**:
- 使用数据库事务确保批量删除的一致性
- 只能删除可编辑的配置项
- 返回删除结果统计

---

### 10. 获取公开配置

**接口地址**: `GET /config/public`

**接口描述**: 获取所有公开的配置项，无需权限验证

**请求参数**: 无

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "system.site_name": "唐僧叨叨",
    "system.site_logo": "/assets/images/logo.png",
    "ui.theme": "light"
  }
}
```

**响应字段说明**:
- 返回 `is_public = 1` 的配置项
- 以 `config_key: config_value` 的键值对形式返回

## 📊 配置数据类型

### 1. boolean类型
- 支持值: `"0"`, `"1"`, `"true"`, `"false"`
- 示例: 开关类配置

### 2. number类型
- 支持值: 数字字符串
- 示例: 数量限制、时间设置

### 3. string类型
- 支持值: 任意字符串
- 示例: 名称、描述、路径

### 4. image类型 ⭐ 新增
- 支持值: 图片文件路径或URL
- 示例: Logo、头像、背景图等图片配置
- 验证规则: 自动验证图片路径格式

### 5. json类型
- 支持值: JSON格式字符串
- 示例: 复杂配置对象

## 🔒 权限控制

### 配置权限级别

1. **只读配置** (`is_editable = 0`)
   - 普通管理员只能查看
   - 超级管理员也无法修改

2. **可编辑配置** (`is_editable = 1`)
   - 超级管理员可以修改
   - 支持单个和批量更新

3. **公开配置** (`is_public = 1`)
   - 前端可以获取
   - 无需权限验证

4. **私有配置** (`is_public = 0`)
   - 仅后台可见
   - 需要管理员权限

## 📝 配置项示例

### 群组配置示例
```json
{
  "group.notify_member_join": "1",
  "group.notify_member_leave": "1",
  "group.notify_member_kick": "1",
  "group.new_member_see_history": "1",
  "group.allow_member_invite": "1",
  "group.allow_member_pinned_message": "0",
  "group.max_member_count": "500",
  "group.auto_delete_inactive_days": "30"
}
```

### 系统配置示例
```json
{
  "system.site_name": "唐僧叨叨",
  "system.site_logo": "/assets/images/logo.png",
  "system.site_favicon": "/assets/images/favicon.ico",
  "system.default_avatar": "/assets/images/default_avatar.png",
  "system.welcome_message": "欢迎使用唐僧叨叨！",
  "system.maintenance_mode": "0",
  "system.maintenance_message": "系统正在维护中，请稍后再试"
}
```

### 图片配置示例 ⭐ 新增
```json
{
  "ui.login_bg": "/assets/images/login_bg.jpg",
  "ui.app_icon": "https://cdn.example.com/app_icon.png",
  "ui.banner_image": "/assets/images/banner.webp"
}
```

## 🖼️ 图片上传完整流程

### 1. 图片上传步骤

#### **第一步：获取图片上传地址**
```bash
GET /v1/file/upload?type=common&path=/admin/config/logo.png
```

**请求参数**:
- `type`: 文件类型，建议使用 `common`（通用）
- `path`: 图片保存路径，建议使用 `/admin/config/{配置键}` 格式

**响应示例**:
```json
{
  "url": "http://api.example.com/v1/file/upload?type=common&path=/admin/config/logo.png"
}
```

#### **第二步：上传图片文件**
```bash
POST /v1/file/upload?type=common&path=/admin/config/logo.png
Content-Type: multipart/form-data

file: [图片文件]
```

**响应示例**:
```json
{
  "path": "file/preview/common/admin/config/logo.png"
}
```

#### **第三步：保存图片路径到配置**
```bash
POST /v1/manager/config/create
Content-Type: application/json
Authorization: Bearer {token}

{
  "config_key": "ui.site_logo",
  "config_value": "file/preview/common/admin/config/logo.png",
  "config_type": "image",
  "description": "网站Logo图片",
  "category": "ui",
  "is_editable": 1,
  "is_public": 1,
  "sort_order": 100
}
```

### 2. 图片上传最佳实践

#### **路径命名规范**
```
/admin/config/{分类}/{配置键}.{扩展名}

示例：
/admin/config/ui/site_logo.png
/admin/config/ui/login_bg.jpg
/admin/config/ui/banner_image.webp
/admin/config/system/app_icon.svg
```

#### **支持的图片格式**
- **推荐格式**: PNG、JPG、WebP
- **支持格式**: JPEG、GIF、BMP、SVG
- **文件大小**: 建议不超过 10MB

#### **图片类型配置建议**
```json
{
  "ui.site_logo": "file/preview/common/admin/config/ui/site_logo.png",
  "ui.login_background": "file/preview/common/admin/config/ui/login_bg.jpg",
  "ui.banner_image": "file/preview/common/admin/config/ui/banner.webp"
}
```

### 3. 前端实现要点

#### **图片上传组件**
- 封装图片上传逻辑，包含获取上传地址、上传文件、保存配置三个步骤
- 支持错误处理和用户提示
- 可复用，支持不同配置键和分类

#### **图片预览组件**
- 根据 `config_type = "image"` 自动识别图片配置项
- 显示图片预览和更换按钮
- 其他类型配置项使用默认的输入组件渲染

#### **前端图片预览实现**

##### **图片预览URL拼接**
```javascript
// 上传成功后返回的path
const path = "file/preview/common/admin/config/system/system.site_logo.png";

// 拼接完整的预览URL
const baseURL = "http://localhost:8090/v1"; // 根据环境配置
const imageURL = `${baseURL}/${path}`;

// 结果: http://localhost:8090/v1/file/preview/common/admin/config/system/system.site_logo.png
```

##### **在HTML中直接使用**
```html
<img src="http://localhost:8090/v1/file/preview/file/preview/common/admin/config/system/system.site_logo.png" 
     alt="系统Logo" 
     style="max-width: 200px; height: auto;">
```

##### **动态设置图片源**
```javascript
// 根据配置类型自动渲染图片
function renderConfigItem(config) {
  if (config.config_type === 'image') {
    // 图片类型：显示图片预览
    return `<img src="${baseURL}/${config.config_value}" alt="${config.description}">`;
  } else {
    // 其他类型：显示输入框
    return `<input type="text" value="${config.config_value}">`;
  }
}
```

##### **图片预览接口说明**
- **接口地址**: `GET /v1/file/preview/*path`
- **无需认证**: 公开接口，可直接访问
- **自动重定向**: 接口会自动重定向到实际的文件存储地址
- **支持缓存**: 浏览器会自动缓存图片，提高加载速度

### 4. 图片配置管理流程

#### **完整的管理流程**
1. **创建图片配置项**
   - 设置 `config_type = "image"`
   - 设置合适的分类和描述
   - 设置权限和可见性

2. **上传图片文件**
   - 使用文件上传接口上传图片
   - 获取返回的文件路径

3. **更新配置值**
   - 将文件路径保存到配置项
   - 支持图片预览和更换

4. **图片访问**
   - 通过 `/v1/file/preview/` 接口访问图片
   - 支持CDN加速和缓存

#### **图片配置更新流程**
1. 上传新图片到文件服务
2. 使用配置更新接口更新配置值
3. 刷新页面显示新的图片

## ⚠️ 错误码说明

| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| 400 | 请求参数错误 | 检查请求参数格式和必填项 |
| 401 | 未授权 | 检查JWT Token是否有效 |
| 403 | 权限不足 | 确认用户具有超级管理员权限 |
| 404 | 配置不存在 | 检查配置键是否正确 |
| 409 | 配置键已存在 | 新增配置时配置键重复，请使用其他键名 |
| 422 | 配置值验证失败 | 检查配置值是否符合配置类型要求 |
| 500 | 服务器内部错误 | 查看服务器日志获取详细错误信息 |

## 🚫 删除限制说明

以下类型的配置项不允许删除：
- 系统核心配置（如：`system.site_name`、`system.site_logo`）
- 安全关键配置（如：`security.password_min_length`）
- 只读配置（`is_editable = 0`）
- 正在被使用的配置项

## 🔧 前端集成建议

### 1. Tab切换实现
```javascript
// 获取配置分类
const categories = await api.get('/config/categories');

// 根据分类获取配置
const configs = await api.get(`/config/category/${category}`);

// 渲染配置表单
renderConfigForm(configs);
```

### 2. 配置更新
```javascript
// 单个更新
await api.put('/config/update', {
  config_key: 'group.notify_member_join',
  config_value: '0'
});

// 批量更新
await api.put('/config/batch-update', {
  configs: [
    { config_key: 'key1', config_value: 'value1' },
    { config_key: 'key2', config_value: 'value2' }
  ]
});
```

### 3. 搜索功能
```javascript
const result = await api.post('/config/search', {
  keyword: '群组',
  category: 'group',
  page: 1,
  page_size: 20
});
```

### 4. 新增配置
```javascript
// 创建新配置项
const newConfig = await api.post('/config/create', {
  config_key: 'system.new_feature',
  config_value: '1',
  config_type: 'boolean',
  description: '新功能开关',
  category: 'system'
});

// 创建图片类型配置
const imageConfig = await api.post('/config/create', {
  config_key: 'ui.banner_image',
  config_value: '/assets/images/banner.png',
  config_type: 'image',
  description: '首页横幅图片',
  category: 'ui'
});
```

### 5. 删除配置
```javascript
// 删除单个配置项
await api.delete('/config/delete/system.temp_config');

// 批量删除配置项
const deleteResult = await api.delete('/config/batch-delete', {
  config_keys: ['system.temp_config1', 'system.temp_config2']
});
```

## 📈 性能优化建议

1. **缓存策略**: 为配置数据添加Redis缓存
2. **分页加载**: 大量配置时使用分页加载
3. **按需加载**: 根据tab切换按需加载配置
4. **批量操作**: 多个配置更新时使用批量接口

## 🖼️ 图片上传注意事项

### **文件大小限制**
- **建议大小**: 不超过 10MB
- **最大限制**: 受存储服务配置限制
- **优化建议**: 上传前进行图片压缩

### **图片格式要求**
- **推荐格式**: PNG、JPG、WebP
- **支持格式**: JPEG、GIF、BMP、SVG

### **安全考虑**
- **文件类型**: 仅支持图片格式
- **路径安全**: 使用预定义的上传路径
- **权限控制**: 需要管理员权限

### **错误处理要点**
- 文件大小检查：建议不超过10MB
- 文件类型验证：仅支持图片格式
- 用户友好提示：使用Toast、Alert等组件显示错误信息

### **图片预览优化要点**
- 懒加载：使用IntersectionObserver实现图片懒加载
- 加载失败处理：提供默认图片作为备选
- 加载状态管理：显示加载成功/失败状态

## 🔍 调试和测试

- 使用Postman或其他API测试工具测试接口
- 测试权限控制和数据验证
- 查看服务器日志获取详细错误信息

## 📞 技术支持

如有问题，请联系开发团队或查看服务器日志获取详细错误信息。


