# 后台管理配置接口文档

## 📋 概述

本文档描述了后台管理系统的配置管理相关接口，支持按分类管理各种系统配置，为前端提供tab切换式的配置管理界面。

## 🔐 权限要求

- 所有管理接口需要超级管理员权限
- 公开配置接口无需权限验证
- 使用JWT Bearer Token认证

## 🌐 基础信息

- **基础URL**: `/v1/manager`
- **认证方式**: Bearer Token
- **数据格式**: JSON
- **字符编码**: UTF-8

## 📚 配置分类

系统预定义了以下3个配置分类：

| 分类键 | 分类名称 | 说明 |
|--------|----------|------|
| `group` | 群组配置 | 群组相关功能配置 |
| `system` | 系统配置 | 系统基础配置 |
| `security` | 安全配置 | 安全相关配置 |



## 🔌 API接口详情

### 1. 获取配置分类列表

**接口地址**: `GET /config/categories`

**接口描述**: 获取所有配置分类信息，用于前端tab切换

**请求参数**: 无

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "category": "group",
      "category_name": "群组配置",
      "count": 8
    },
    {
      "category": "system",
      "category_name": "系统配置",
      "count": 8
    }
  ]
}
```

**响应字段说明**:
- `category`: 配置分类键
- `category_name`: 配置分类显示名称
- `count`: 该分类下的配置项数量

---

### 2. 获取所有配置（按分类分组）

**接口地址**: `GET /config/list`

**接口描述**: 获取所有配置项，按分类分组返回，用于前端tab页面展示

**请求参数**: 无

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "category": "group",
      "category_name": "群组配置",
      "configs": [
        {
          "id": 1,
          "config_key": "group.notify_member_join",
          "config_value": "1",
          "config_type": "boolean",
          "description": "群成员加入时是否通知其他成员",
          "category": "group",
          "is_editable": 1,
          "is_public": 1,
          "sort_order": 100,
          "version": 1,
          "created_at": "2025-01-17 23:22:43",
          "updated_at": "2025-01-17 23:22:43",
          "created_by": "system",
          "updated_by": "system"
        }
      ]
    }
  ]
}
```

---

### 3. 根据分类获取配置

**接口地址**: `GET /config/category/{category}`

**接口描述**: 根据指定分类获取该分类下的所有配置项

**路径参数**:
- `category`: 配置分类（必填）

**支持的分类值**: `group`, `system`, `security`, `notification`, `ui`, `message`, `file`, `robot`, `statistics`

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "category": "group",
    "category_name": "群组配置",
    "configs": [
      {
        "id": 1,
        "config_key": "group.notify_member_join",
        "config_value": "1",
        "config_type": "boolean",
        "description": "群成员加入时是否通知其他成员",
        "is_editable": 1,
        "is_public": 1
      }
    ]
  }
}
```

---

### 4. 更新单个配置

**接口地址**: `PUT /config/update`

**接口描述**: 更新指定配置项的值

**请求参数**:
```json
{
  "config_key": "group.notify_member_join",
  "config_value": "0"
}
```

**请求字段说明**:
- `config_key`: 配置键（必填）
- `config_value`: 配置值（必填）

**响应示例**:
```json
{
  "code": 200,
  "message": "success"
}
```

**注意事项**:
- 只能更新 `is_editable = 1` 的配置项
- 配置值会根据配置类型进行验证
- 更新后版本号会自动递增

---

### 5. 批量更新配置

**接口地址**: `PUT /config/batch-update`

**接口描述**: 批量更新多个配置项的值

**请求参数**:
```json
{
  "configs": [
    {
      "config_key": "group.notify_member_join",
      "config_value": "1"
    },
    {
      "config_key": "group.notify_member_leave",
      "config_value": "1"
    }
  ]
}
```

**请求字段说明**:
- `configs`: 配置项数组（必填，至少1项）
  - `config_key`: 配置键（必填）
  - `config_value`: 配置值（必填）

**响应示例**:
```json
{
  "code": 200,
  "message": "success"
}
```

**注意事项**:
- 使用数据库事务确保批量更新的一致性
- 所有配置项必须存在且可编辑
- 配置值会进行类型验证

---

### 6. 搜索配置

**接口地址**: `POST /config/search`

**接口描述**: 根据关键词和分类搜索配置项

**请求参数**:
```json
{
  "keyword": "群组",
  "category": "group",
  "page": 1,
  "page_size": 20
}
```

**请求字段说明**:
- `keyword`: 搜索关键词（可选）
- `category`: 配置分类（可选）
- `page`: 页码（必填，最小1）
- `page_size`: 每页数量（必填，1-100）

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "configs": [
      {
        "id": 1,
        "config_key": "group.notify_member_join",
        "config_value": "1",
        "config_type": "boolean",
        "description": "群成员加入时是否通知其他成员"
      }
    ],
    "total": 1,
    "page": 1,
    "page_size": 20
  }
}
```

---

### 7. 获取公开配置

**接口地址**: `GET /config/public`

**接口描述**: 获取所有公开的配置项，无需权限验证

**请求参数**: 无

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "system.site_name": "唐僧叨叨",
    "system.site_logo": "/assets/images/logo.png",
    "ui.theme": "light"
  }
}
```

**响应字段说明**:
- 返回 `is_public = 1` 的配置项
- 以 `config_key: config_value` 的键值对形式返回

## 📊 配置数据类型

### 1. boolean类型
- 支持值: `"0"`, `"1"`, `"true"`, `"false"`
- 示例: 开关类配置

### 2. number类型
- 支持值: 数字字符串
- 示例: 数量限制、时间设置

### 3. string类型
- 支持值: 任意字符串
- 示例: 名称、描述、路径

### 4. json类型
- 支持值: JSON格式字符串
- 示例: 复杂配置对象

## 🔒 权限控制

### 配置权限级别

1. **只读配置** (`is_editable = 0`)
   - 普通管理员只能查看
   - 超级管理员也无法修改

2. **可编辑配置** (`is_editable = 1`)
   - 超级管理员可以修改
   - 支持单个和批量更新

3. **公开配置** (`is_public = 1`)
   - 前端可以获取
   - 无需权限验证

4. **私有配置** (`is_public = 0`)
   - 仅后台可见
   - 需要管理员权限

## 📝 配置项示例

### 群组配置示例
```json
{
  "group.notify_member_join": "1",
  "group.notify_member_leave": "1",
  "group.notify_member_kick": "1",
  "group.new_member_see_history": "1",
  "group.allow_member_invite": "1",
  "group.allow_member_pinned_message": "0",
  "group.max_member_count": "500",
  "group.auto_delete_inactive_days": "30"
}
```

### 系统配置示例
```json
{
  "system.site_name": "唐僧叨叨",
  "system.site_logo": "/assets/images/logo.png",
  "system.site_favicon": "/assets/images/favicon.ico",
  "system.default_avatar": "/assets/images/default_avatar.png",
  "system.welcome_message": "欢迎使用唐僧叨叨！",
  "system.maintenance_mode": "0",
  "system.maintenance_message": "系统正在维护中，请稍后再试"
}
```

## ⚠️ 错误码说明

| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| 400 | 请求参数错误 | 检查请求参数格式和必填项 |
| 401 | 未授权 | 检查JWT Token是否有效 |
| 403 | 权限不足 | 确认用户具有超级管理员权限 |
| 404 | 配置不存在 | 检查配置键是否正确 |
| 500 | 服务器内部错误 | 查看服务器日志获取详细错误信息 |

## 🔧 前端集成建议

### 1. Tab切换实现
```javascript
// 获取配置分类
const categories = await api.get('/config/categories');

// 根据分类获取配置
const configs = await api.get(`/config/category/${category}`);

// 渲染配置表单
renderConfigForm(configs);
```

### 2. 配置更新
```javascript
// 单个更新
await api.put('/config/update', {
  config_key: 'group.notify_member_join',
  config_value: '0'
});

// 批量更新
await api.put('/config/batch-update', {
  configs: [
    { config_key: 'key1', config_value: 'value1' },
    { config_key: 'key2', config_value: 'value2' }
  ]
});
```

### 3. 搜索功能
```javascript
const result = await api.post('/config/search', {
  keyword: '群组',
  category: 'group',
  page: 1,
  page_size: 20
});
```

## 📈 性能优化建议

1. **缓存策略**: 为配置数据添加Redis缓存
2. **分页加载**: 大量配置时使用分页加载
3. **按需加载**: 根据tab切换按需加载配置
4. **批量操作**: 多个配置更新时使用批量接口

## 🔍 调试和测试

### 1. 接口测试
使用Postman或其他API测试工具测试接口

### 2. 权限测试
- 使用普通用户Token测试权限控制
- 使用超级管理员Token测试完整功能

### 3. 数据验证
- 测试不同配置类型的值验证
- 测试边界条件和异常情况

## 📞 技术支持

如有问题，请联系开发团队或查看服务器日志获取详细错误信息。
