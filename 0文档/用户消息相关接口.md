# 唐僧叨叨 - 用户消息相关接口文档

## 📋 接口概览

唐僧叨叨提供了完整的后台管理接口来查看和管理用户消息，包括消息查看、发送、删除等功能。

## 🔐 认证接口

### 管理员登录
```http
POST /v1/manager/login
```

**请求参数：**
```json
{
  "username": "admin",
  "password": "admiN123456"
}
```

**响应示例：**
```json
{
  "uid": "admin",
  "token": "925d0793a63e45bba1a18e0ad17ed381",
  "name": "超级管理员",
  "role": "superAdmin"
}
```

**说明：**
- 使用超级管理员账号登录
- 返回的token需要在后续请求的Header中携带
- Header格式：`token: {token值}`

## 📝 消息查看接口

### 1. 查看代发消息记录
```http
GET /v1/manager/message?page={页码}&page_size={每页数量}
```

**请求参数：**
- `page`: 页码，从1开始
- `page_size`: 每页数量，建议10-100

**请求头：**
```
token: {管理员token}
```

**响应示例：**
```json
{
  "count": 0,
  "list": []
}
```

**功能说明：**
- 查看管理员代发的消息历史记录
- 需要管理员权限

### 2. 查看频道消息记录
```http
GET /v1/manager/message/record?channel_id={频道ID}&page={页码}&page_size={每页数量}
```

**请求参数：**
- `channel_id`: 频道ID（群组ID）
- `page`: 页码，从1开始
- `page_size`: 每页数量

**请求头：**
```
token: {管理员token}
```

**响应示例：**
```json
{
  "count": 150,
  "list": [
    {
      "message_id": "123456",
      "message_seq": 100,
      "sender": "user123",
      "sender_name": "张三",
      "payload": {
        "content": "你好！",
        "type": 1
      },
      "is_deleted": 0,
      "readed_count": 1,
      "revoke": 0,
      "device_db_id": 1,
      "device_id": "iPhone_123",
      "device_name": "iPhone 15",
      "device_model": "iPhone 15 Pro",
      "created_at": "2024-01-01 12:00:00"
    }
  ]
}
```

**功能说明：**
- 查看指定频道（群组）的所有消息
- 包含发送者信息、设备信息、消息内容等
- 支持分页查询

### 3. 查看单聊消息记录
```http
GET /v1/manager/message/recordpersonal?uid={用户1}&touid={用户2}&page={页码}&page_size={每页数量}
```

**请求参数：**
- `uid`: 其中一个用户的ID
- `touid`: 另一个用户的ID
- `page`: 页码，从1开始
- `page_size`: 每页数量

**请求头：**
```
token: {管理员token}
```

**响应示例：**
```json
{
  "count": 50,
  "list": [
    {
      "message_id": "123456",
      "sender": "user1",
      "sender_name": "张三",
      "payload": {
        "content": "私聊消息内容",
        "type": 1
      },
      "signal": 0,
      "is_deleted": 0,
      "readed_count": 1,
      "revoke": 0,
      "device_db_id": 1,
      "device_id": "iPhone_123",
      "device_name": "iPhone 15",
      "device_model": "iPhone 15 Pro",
      "created_at": "2024-01-01 12:00:00"
    }
  ]
}
```

**功能说明：**
- 查看两个用户之间的私聊记录
- 包含完整的消息内容和元数据
- 支持分页查询

## 📤 消息发送接口

### 4. 发送消息
```http
POST /v1/manager/message/send
```

**请求头：**
```
token: {超级管理员token}
Content-Type: application/json
```

**请求参数：**
```json
{
  "sender": "admin",
  "sender_name": "系统管理员",
  "received_channel_id": "user123",
  "received_channel_type": 1,
  "content": "系统通知消息"
}
```

**参数说明：**
- `sender`: 发送者UID
- `sender_name`: 发送者名称
- `received_channel_id`: 接收者频道ID（用户ID或群组ID）
- `received_channel_type`: 频道类型（1: 个人, 2: 群组）
- `content`: 消息内容

**响应示例：**
```json
{
  "status": 200
}
```

**权限要求：**
- 需要超级管理员权限

### 5. 给好友发送消息
```http
POST /v1/manager/message/sendfriends
```

**请求头：**
```
token: {超级管理员token}
Content-Type: application/json
```

**请求参数：**
```json
{
  "uid": "user123",
  "to_uids": ["user456", "user789"],
  "content": "群发消息内容"
}
```

**参数说明：**
- `uid`: 发送者UID
- `to_uids`: 接收者UID列表
- `content`: 消息内容

**权限要求：**
- 需要超级管理员权限

### 6. 给所有用户发送消息
```http
POST /v1/manager/message/sendall
```

**请求头：**
```
token: {超级管理员token}
Content-Type: application/json
```

**请求参数：**
```json
{
  "content": "系统公告：平台维护通知"
}
```

**参数说明：**
- `content`: 消息内容

**功能说明：**
- 给平台所有用户发送系统消息
- 分批发送，避免系统压力过大

**权限要求：**
- 需要超级管理员权限

## 🗑️ 消息管理接口

### 7. 删除消息
```http
DELETE /v1/manager/message
```

**请求头：**
```
token: {超级管理员token}
Content-Type: application/json
```

**请求参数：**
```json
{
  "list": [
    {
      "message_id": "123456",
      "message_seq": 100
    }
  ],
  "channel_id": "group123",
  "from_uid": "user123",
  "channel_type": 2
}
```

**参数说明：**
- `list`: 要删除的消息列表
- `channel_id`: 频道ID
- `from_uid`: 发送者UID（单聊时必填）
- `channel_type`: 频道类型（1: 个人, 2: 群组）

**权限要求：**
- 需要超级管理员权限

## 🚫 内容管理接口

### 8. 查询违禁词
```http
GET /v1/manager/message/prohibit_words?page={页码}&page_size={每页数量}&search_key={搜索关键词}
```

**请求参数：**
- `page`: 页码
- `page_size`: 每页数量
- `search_key`: 搜索关键词（可选）

**响应示例：**
```json
{
  "list": [
    {
      "id": 1,
      "content": "违禁词内容",
      "is_deleted": 0,
      "version": 1,
      "created_at": "2024-01-01 12:00:00"
    }
  ],
  "count": 10
}
```

### 9. 添加违禁词
```http
POST /v1/manager/message/prohibit_words
```

**请求参数：**
```json
{
  "content": "新的违禁词"
}
```

### 10. 删除违禁词
```http
DELETE /v1/manager/message/prohibit_words
```

**请求参数：**
```json
{
  "id": 1
}
```

## 🔧 接口使用示例

### 完整测试流程

```bash
# 1. 登录获取Token
TOKEN=$(curl -s -X POST http://localhost:8090/v1/manager/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admiN123456"}' | \
  grep -o '"token":"[^"]*"' | cut -d'"' -f4)

echo "Token: $TOKEN"

# 2. 查看代发消息记录
curl -H "token: $TOKEN" \
  "http://localhost:8090/v1/manager/message?page=1&page_size=10"

# 3. 查看群组消息
curl -H "token: $TOKEN" \
  "http://localhost:8090/v1/manager/message/record?channel_id=group123&page=1&page_size=20"

# 4. 查看用户私聊记录
curl -H "token: $TOKEN" \
  "http://localhost:8090/v1/manager/message/recordpersonal?uid=user1&touid=user2&page=1&page_size=20"

# 5. 发送系统消息
curl -X POST -H "token: $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"content":"系统维护通知"}' \
  "http://localhost:8090/v1/manager/message/sendall"
```

## 📊 数据字段说明

### 消息记录字段
- `message_id`: 消息唯一ID
- `message_seq`: 消息序号
- `sender`: 发送者UID
- `sender_name`: 发送者名称
- `payload`: 消息内容（JSON格式）
- `is_deleted`: 是否已删除（0: 否, 1: 是）
- `readed_count`: 已读人数
- `revoke`: 是否撤回（0: 否, 1: 是）
- `device_id`: 设备ID
- `device_name`: 设备名称
- `device_model`: 设备型号
- `created_at`: 发送时间

### 消息类型
- `type: 1`: 文本消息
- `type: 2`: 图片消息
- `type: 3`: 语音消息
- `type: 4`: 视频消息
- `type: 5`: 文件消息

## ⚠️ 注意事项

1. **权限控制**
   - 所有接口都需要管理员Token
   - 部分接口需要超级管理员权限

2. **分页查询**
   - 所有列表接口都支持分页
   - 建议page_size不超过100

3. **隐私保护**
   - 这些接口仅供系统管理使用
   - 请遵守相关法律法规

4. **性能考虑**
   - 大量数据查询时建议使用分页
   - 避免频繁调用接口

## 🔗 相关接口

- **用户管理**: `/v1/manager/user/*`
- **群组管理**: `/v1/manager/group/*`
- **设备管理**: `/v1/manager/user/devices`

## 📞 技术支持

如有问题，请联系系统管理员或查看系统日志。
